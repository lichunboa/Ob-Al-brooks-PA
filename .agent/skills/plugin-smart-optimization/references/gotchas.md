# Gotchas (常见陷阱)

> **来源**: 整合了 `trading-console-plugin-maintainer` 技能包的实战经验

---

## 代码重构陷阱

### 陷阱 1: 大爆炸式重构 🔴

**症状**: 一次性修改大量代码

**后果**: 
- 难以定位问题
- 回滚困难
- 容易破坏功能

**避免方法**:
- 小步快跑
- 每次只改一个模块
- 频繁测试

**实战经验**:
- 之前尝试一次性拆分 6500+ 行代码导致系统崩溃
- 必须采用"一次一个 Tab"的策略

---

### 陷阱 2: 忽略依赖关系 🟡

**症状**: 修改代码时没有考虑依赖关系

**后果**:
- 破坏其他模块
- 引入循环依赖
- 难以维护

**避免方法**:
- 使用 serena 分析依赖关系
- 先修改被依赖的模块
- 保持接口稳定

---

### 陷阱 3: 过度优化 🟡

**症状**: 为了优化而优化

**后果**:
- 代码变得复杂
- 可读性下降
- 维护成本增加

**避免方法**:
- 只优化有明确问题的代码
- 保持代码简单
- 优先可读性

---

## Dashboard.tsx 超大文件专项陷阱 ⚠️

### 陷阱 4: 删除块导致"半截 JSX" 🔴

**症状**: 错误面板爆炸(数百个 TS/TSX 解析错误),通常从文件开头附近开始连锁

**后果**:
- 300+ 解析错误
- 难以定位问题点
- 可能需要完全回滚

**处理方法**:
1. **立刻停止继续编辑**
2. 回到"最后一次 build 通过"的状态
   ```bash
   git restore Dashboard.tsx
   # 或
   git checkout HEAD~1 -- src/views/Dashboard.tsx
   ```
3. 重新用稳定锚点夹住删除范围,分小步做

**预防方法**:
- 任何删除/替换都必须包含完整起止边界
- 用模块标题做锚点(例如 `📥 导出`、`⚔️ 交易中心`)
- 不跨越组件定义边界(不要越过 `return (` / `</...>`)

---

### 陷阱 5: 重复块残留 🟡

**症状**: UI 里出现重复模块;或搜索关键词出现 2+ 次

**后果**:
- 用户看到重复内容
- 功能混乱
- 难以维护

**处理方法**:
1. 全局搜索统计命中数
   ```
   搜索: "✅ 每日行动"
   预期: 1 次命中
   实际: 2 次命中 ❌
   ```
2. 每次只删除一个命中点
3. 删除后重新统计
4. 用"命中数 == 目标数"作为验收,不靠肉眼

**预防方法**:
- 先全局搜索模块标题统计出现次数
- 逐个定位:读取命中附近 50-150 行确认所属页面
- 删除时用"前后稳定锚点"夹住
- 删除后再次搜索,直到只剩目标位置

---

### 陷阱 6: 条件渲染嵌套层级错误 🟡

**症状**: 某页内容跑到另一页;或某 tab 下空白

**后果**:
- 页面显示错误
- 用户体验混乱
- 难以调试

**处理方法**:
- 优先改成"顺序渲染"而非多层三元嵌套
- 确保 `activePage === "xxx"` 的块不被其它条件包裹

**预防方法**:
- 禁止把 learn 嵌到 analytics 之类的错误层级
- 合并分支时优先改为"顺序渲染"(减少三元/嵌套)

---

## 外部集成陷阱

### 陷阱 7: 未做 capability 检测 🟡

**症状**: 用户未安装 Tasks/QuickAdd 时点击即报错

**后果**:
- 插件崩溃
- 用户体验差
- 难以排查

**处理方法**:
- 统一加 `can("...")` 分支
- 缺失则提示"需要安装/启用 xx 插件"而不是隐藏

**预防方法**:
- 始终走 capability 检测
- 集成缺失时:渲染提示文案,不要隐藏整个模块
- 对外部命令调用:统一走 `action()`/`runCommand()` 体系

---

### 陷阱 8: 使用 window.prompt/confirm 🔴

**症状**: 按钮点击事件已触发,但不会出现输入框/确认框

**原因**: Obsidian 桌面端对 `window.prompt()` / `window.confirm()` 的行为不稳定

**后果**:
- 重命名/改值/追加/注入都无法继续
- 用户点击无响应

**处理方法**:
- 不要在插件 UI 逻辑里用 `window.prompt/confirm`
- 改用 Obsidian 原生 `Modal(this.app)` 实现输入与确认
- React 组件里若拿不到 `app`:在 `ConsoleView`(宿主)实现 `promptText/confirmDialog` 并通过 props 注入

**验证**:
- 在 Obsidian 内实际点一次"重命名/追加/注入"
- 能弹出 Modal 且写入生效

---

## UI/样式陷阱

### 陷阱 9: 颜色硬编码 🟡

**症状**: 
- 同一语义在不同页面颜色不一致
- Obsidian 主题一换,颜色语义跟着漂
- 代码里散落很多 `#...` / `rgba(...)`

**后果**:
- 主题漂移
- 维护困难
- 视觉不一致

**处理方法**:
- 背景/边框/按钮 hover/focus:使用 Obsidian CSS 变量
  - `var(--background-*)`
  - `var(--interactive-accent)`
- 语义色/图表色:统一从 `src/ui/tokens.ts` 读取(v5 palette)
- 禁止在 `Dashboard.tsx` 新增硬编码色值

**验证**:
- 全局搜索 `#` 的新增命中应为 0
- 或仅出现在 `src/ui/tokens.ts`

---

## Git 陷阱

### 陷阱 10: 提交信息不清晰 🟡

**症状**: 提交信息模糊或缺失

**后果**:
- 难以理解历史变更
- 回滚困难
- 团队协作混乱

**避免方法**:
- 使用有意义的提交信息
- 遵循提交规范
- 每次提交只做一件事

**推荐格式**:
```
refactor: [描述优化内容]

- 优化内容 1
- 优化内容 2
- 优化内容 3

风险等级: 低
验证: 构建通过 + 功能测试通过
```

---

## 快速排雷清单

遇到问题时,按此顺序检查:

1. **构建失败** → 检查是否有"半截 JSX"
2. **重复内容** → 全局搜索统计命中数
3. **页面空白** → 检查条件渲染嵌套
4. **点击无响应** → 检查是否用了 window.prompt/confirm
5. **颜色不对** → 检查是否硬编码色值
6. **外部插件报错** → 检查 capability 检测

---

(持续更新)

