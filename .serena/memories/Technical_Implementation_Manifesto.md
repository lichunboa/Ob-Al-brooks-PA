# ğŸ“„ äº¤æ˜“å‘˜æ§åˆ¶å° (Trader Command) æŠ€æœ¯å®ç°ç™½çš®ä¹¦ (Technical Manifesto)

> **âš ï¸ Agent æ³¨æ„**: æ­¤æ–‡æ¡£è®°å½•äº†ç³»ç»Ÿ**"ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡"**ä»¥åŠ**"æ ¸å¿ƒé€»è¾‘å¦‚ä½•è¿è½¬"**ã€‚åœ¨ä¿®æ”¹å¤æ‚è„šæœ¬ï¼ˆå°¤å…¶æ˜¯ coreï¼‰ä¹‹å‰ï¼Œ**å¿…é¡»**å…ˆé˜…è¯»ç›¸å…³ç« èŠ‚ã€‚ä¿®æ”¹ä»£ç åï¼Œ**å¿…é¡»**åŒæ­¥æ›´æ–°æ­¤æ–‡æ¡£ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå¼•æ“: `scripts/pa-core.js`

**æ–‡ä»¶å®šä½**: ç³»ç»Ÿçš„å•ä¸€æ•°æ®æº (Single Source of Truth)ï¼Œè´Ÿè´£åŠ è½½ã€æ¸…æ´—äº¤æ˜“æ•°æ®ï¼Œè®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ï¼Œå¹¶ç®¡ç†å…¨å±€ç¼“å­˜ã€‚

### 1. æ™ºèƒ½ç¼“å­˜ä¸åˆ·æ–°æœºåˆ¶ (Smart Cache & Refresh)

*   **ç—›ç‚¹è§£å†³**: è§£å†³ DataviewJS é¢‘ç¹åˆ·æ–°å¯¼è‡´çš„å¡é¡¿å’Œæ»šåŠ¨æ¡è·³åŠ¨é—®é¢˜ã€‚
*   **æ ¸å¿ƒçŠ¶æ€**:
    *   `window.__paBuilding`: é”ï¼Œé˜²æ­¢å¹¶å‘é€’å½’åˆ·æ–°ã€‚
    *   `window.paForceReload`: æ ‡å¿—ä½ï¼ŒUI æŒ‰é’®ç‚¹å‡»åˆ·æ–°æ—¶ç½®ä¸º trueã€‚
    *   `window.paDirty`: è„æ ‡è®°ï¼Œç”± `app.vault.on('modify')` è§¦å‘ï¼Œæ ‡å¿—ç€æœ‰æ•°æ®æ–‡ä»¶å˜æ›´ã€‚
*   **é€»è¾‘æµç¨‹**:
    1.  **Check**: æ£€æŸ¥ `cachedTs` æ˜¯å¦è¿‡æœŸï¼ˆé»˜è®¤ ttl åœ¨ config ä¸­å®šä¹‰ï¼‰ä¸” `paDirty` ä¸º falseã€‚
    2.  **Hit**: å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å› `window.paData` ä¸­çš„æ•°æ®ï¼ˆæé€Ÿæ¨¡å¼ï¼‰ã€‚
    3.  **Miss**: å¦‚æœæœªå‘½ä¸­æˆ–å¼ºåˆ¶åˆ·æ–°ï¼Œæ‰§è¡Œå…¨é‡æ‰«æï¼ˆæ‰«ææ¨¡å¼ï¼‰ã€‚

### 2. æ»šåŠ¨æ¡é”å®šæŠ€æœ¯ (Scroll Locking)

*   **å¤æ‚é€»è¾‘**: Dataview åˆ·æ–°ä¼šé”€æ¯ DOMï¼Œå¯¼è‡´é¡µé¢è·³å›é¡¶éƒ¨ã€‚æˆ‘ä»¬å®ç°äº†å¤æ‚çš„â€œæ»šåŠ¨ä¿æŒâ€é€»è¾‘ã€‚
*   **å…³é”®å‡½æ•°**:
    *   `paCaptureScrollState()`: æ•è·å½“å‰ leaf çš„ scrollTop/Ratioã€‚
    *   `paStartScrollLock()`: åœ¨åˆ·æ–°æœŸé—´å¼€å¯ä¸€ä¸ª `requestAnimationFrame` å¾ªç¯ï¼Œå¼ºè¡ŒæŠŠ scrollTop é’‰åœ¨ç›®æ ‡ä½ç½®ï¼Œé˜²æ­¢è§†è§‰è·³åŠ¨ã€‚
    *   `paRestoreScrollState()`: åˆ·æ–°å®Œæˆåï¼Œç­‰å¾… DOM é«˜åº¦ç¨³å®šï¼ˆ3å¸§ä¸å˜ï¼‰åï¼Œæ¢å¤ä½ç½®ã€‚
*   **é™·é˜± (Pitfalls)**:
    *   ä¸è¦è½»æ˜“ä¿®æ”¹ `paGetScrollerElForLeaf` ä¸­çš„é€‰æ‹©å™¨ä¼˜å…ˆçº§ï¼ˆ`.view-content` vs `.cm-scroller`ï¼‰ï¼Œè¿™é€‚é…äº† Obsidian é˜…è¯»/ç¼–è¾‘æ¨¡å¼çš„å·®å¼‚ã€‚

### 3. æ•°æ®æ¸…æ´—ç®¡é“ (Data Pipeline)

*   **Review Hints (æ™ºèƒ½å¤ç›˜æç¤º)**:
    *   **é€»è¾‘**: è¿™é‡Œä¸ä»…åŠ è½½æ•°æ®ï¼Œè¿˜è¿è¡Œäº†ä¸€å±‚è½»é‡çº§ AI è§„åˆ™ (`buildReviewHints`)ã€‚
    *   **è§„åˆ™**: æ£€æŸ¥ `setup`, `market_cycle`, `strategyName` ç­‰å­—æ®µæ˜¯å¦ç¼ºå¤±ï¼Œç”Ÿæˆæç¤ºå¯¹è±¡æ•°ç»„ã€‚
    *   **ç›®çš„**: ç»™ UI å±‚æ˜¾ç¤º "âš ï¸ ç¼ºå°‘è®¾ç½®" è­¦å‘Šï¼Œè€Œä¸ç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶ã€‚

### 4. æ•°æ®ç»“æ„ (Data Schema)

*   `window.paData.tradesAsc`: äº¤æ˜“æ•°ç»„ï¼ŒæŒ‰æ—¶é—´å‡åºï¼ˆæ—§->æ–°ï¼‰ã€‚
*   `window.paData.stats`: `livePnL`, `liveWin` ç­‰å®æ—¶ç»Ÿè®¡ã€‚
*   `window.paData.strategyIndex`: ç­–ç•¥åº“ç´¢å¼•ï¼Œç”± `Strategy Repository/` æ–‡ä»¶å¤¹è§£æè€Œæ¥ã€‚

---

## ğŸ“Š è§†å›¾å®ç°: `scripts/pa-view-*.js`

### 1. âš”ï¸ äº¤æ˜“ä¸­å¿ƒ: `scripts/pa-view-today.js`
**èŒè´£**: å®æ—¶æˆ˜å†µçœ‹æ¿ã€‚å®ƒæ˜¯ç”¨æˆ·äº¤æ˜“æ—¶çš„"æŠ¬å¤´æ˜¾ç¤ºå™¨ (HUD)"ã€‚

#### ğŸ”§ å…³é”®ä¾èµ– (Critical Dependencies)
*   **Global State**: å¼ºä¾èµ– `window.paData.tradesAsc` (æ•°æ®æº) å’Œ `window.paData.strategyIndex` (ç­–ç•¥åŒ¹é…)ã€‚è‹¥ `paData` ä¸ºç©ºï¼Œè„šæœ¬ä¼šé™é»˜å¤±è´¥ (return empty)ã€‚
*   **Active Trade Logic**:
    *   **åˆ¤å®šæ ‡å‡†**: `!t.outcome`. åªè¦ `outcome` å­—æ®µä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œå³è§†ä¸º"è¿›è¡Œä¸­"ã€‚
    *   **éšæ‚£**: å¦‚æœæ‚¨æ‰‹åŠ¨å¡«å†™äº† "Partial" ä½†æ²¡å¡« "Win/Loss"ï¼Œä¼šè¢«è§†ä¸ºå·²ç»“æŸã€‚åŠ¡å¿…æ³¨æ„ `outcome` ä¸ºä¸»è¦çŠ¶æ€å­—æ®µã€‚
*   **Strategy Matching (åŒ¹é…é“¾)**:
    1.  **ç²¾ç¡®åŒ¹é…**: éå†å½“å‰äº¤æ˜“çš„ `patterns` æ•°ç»„ (å¦‚ `['Wedge']`) -> æŸ¥è¡¨ `strategyIndex.byPattern` -> å‘½ä¸­ç­–ç•¥å¡ã€‚
    2.  **æ¨¡ç³Šå…œåº•**: è‹¥æ—  patternï¼Œåˆ™ç”± `market_cycle` + `setup` (å¦‚ "Trading Range", "Pullback") è¿›è¡Œç²—ç•¥è®¡åˆ†æ¨èã€‚
*   **Hardcoded Actions**:
    *   **QuickAdd**: æŒ‰é’®ç»‘å®šäº†å‘½ä»¤ID `quickadd:choice:New Live Trade`ã€‚è‹¥æ‚¨åœ¨ QuickAdd æ’ä»¶ä¸­é‡å‘½åäº†æ­¤åŠ¨ä½œï¼ŒæŒ‰é’®å°†å¤±æ•ˆã€‚
    *   **Daily Link**: å‡è®¾æ—¥è®°è·¯å¾„ä¸º `Daily/YYYY-MM-DD_Journal`ã€‚è‹¥ä¿®æ”¹æ—¥è®°å­˜æ”¾ç›®å½•ï¼Œ"åˆ›å»ºä»Šæ—¥æ—¥è®°"é“¾æ¥éœ€åŒæ­¥ä¿®æ”¹ã€‚

### 2. ğŸ“Š æ•°æ®ä¸­å¿ƒ: `scripts/pa-view-hub-analytics.js`
**èŒè´£**: è´¦æˆ·åˆ†æã€èµ„é‡‘æ›²çº¿ã€é”™è¯¯å½’å› ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Data Parsing**:
    *   **Type Filter**: ä¸¥æ ¼åŒºåˆ† `Live` (å®ç›˜), `Demo` (æ¨¡æ‹Ÿ), `Backtest` (å›æµ‹)ã€‚å¤§å°å†™æ•æ„Ÿ (è™½ç„¶éƒ¨åˆ†é€»è¾‘åšäº† `.toLowerCase()` å…¼å®¹ï¼Œä½†å»ºè®®ç»Ÿä¸€é¦–å­—æ¯å¤§å†™)ã€‚
    *   **PnL Safety**: ä½¿ç”¨ `parseFloat(t.pnl) || 0`ã€‚å³ä½¿ Frontmatter å†™é”™æˆ `pnl: null` æˆ– `pnl: "100u"`, ä¹Ÿèƒ½å®‰å…¨å¤„ç†ä¸º 0ï¼Œé˜²æ­¢æ•´ä¸ªè®¡ç®—å´©æºƒã€‚
*   **Equity Curve (èµ„é‡‘æ›²çº¿)**:
    *   **ç´¯åŠ é€»è¾‘**: åŸºäº `tradesAsc` (æ—¶é—´å‡åº) è¿›è¡Œ `cum += pnl`ã€‚å› æ­¤ `pa-core` å¿…é¡»ä¿è¯ `tradesAsc` æ’åºæ­£ç¡®ï¼Œå¦åˆ™æ›²çº¿ä¼šç©¿è¶Šæ—¶ç©ºã€‚
    *   **SVG Rendering**: åŠ¨æ€è®¡ç®— `maxVal/minVal`ã€‚
        *   *Edge Case*: å¦‚æœè´¦æˆ·åªæœ‰ 1 ç¬”äº¤æ˜“æˆ–ç›ˆäºå…¨ä¸º 0 (max=min)ï¼Œåˆ†æ¯ä¸º 0 ä¼šå¯¼è‡´ `Infinity`ã€‚ä»£ç ä¸­åšäº† `range || 1` æˆ– `maxVal = Math.max(.., 100)` çš„å…œåº•ã€‚
*   **Strategy Identification**:
    *   **Source of Truth**: ä¼˜å…ˆä½¿ç”¨ `strategyIndex` (æ¥è‡ª core)ã€‚è¿™ä¿è¯äº† Dashboard å’Œ Analytics çœ‹åˆ°çš„ç­–ç•¥åç§°æ°¸è¿œä¸€è‡´ã€‚
    *   **Fallback**: è‹¥ core æœªå°±ç»ªï¼Œä¼šé™çº§ä¸ºæœ¬åœ°ç®€æ˜“æ˜ å°„ (ä¸æ¨è)ã€‚

### 3. ğŸ§  è®°å¿†æ¨¡å—: `scripts/pa-view-memory.js`
**èŒè´£**: é—´éš”é‡å¤è®°å¿† (SRS) çš„å¯è§†åŒ–ä¸äº¤äº’å…¥å£ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Recommendation Algorithm (æ¨èä¼˜å…ˆçº§)**:
    1.  **Due (åˆ°æœŸ)**: `sr.due > 0` ä¸”æœ‰ `sr.focusFile` (å¯é€šè¿‡ Shake æŒ‰é’®ä¸´æ—¶ Bypass)ã€‚
    2.  **Hybrid (æ··åˆ)**: `course.hybridRec` (æ–°è¯¾æˆ–é—ªå¡)ã€‚
    3.  **Random (éšæœº)**: æ‘‡ä¸€æ‘‡ (`quizPool` éšæœºæŠ½å–)ã€‚
*   **Interaction Logic (Bypass)**:
    *   **Shake ğŸ²**: ç‚¹å‡»æ‘‡ä¸€æ‘‡ä¼šè®¾ç½® `window.paIgnoreFocus = true` å¹¶åˆ·æ–°è§†å›¾ï¼Œä»è€Œè·³è¿‡å¼ºåˆ¶å¤ä¹ ï¼Œè¿›å…¥ Random æ¨¡å¼ã€‚
    *   **Hard Refresh ğŸ”„**: å¼ºåˆ¶åˆ·æ–°ä¼šé‡ç½® `window.paIgnoreFocus = false`ï¼Œæ¢å¤é»˜è®¤ä¼˜å…ˆçº§ã€‚
*   **UI Constraints**:
    *   **Container Height**: `.mem-chart-row` å¢é«˜è‡³ `180px` ä»¥å®¹çº³é•¿æ ‡é¢˜ã€‚
    *   **Text Culling**: æ ‡é¢˜å¼ºåˆ¶ `-webkit-line-clamp: 2`ï¼Œé˜²æ­¢ä¸­æ–‡æ¸²æŸ“æ—¶çš„å‚ç›´æº¢å‡º (V3.1 Fix)ã€‚
*   **Command Coupling**:
    *   **Review Button**: ç»‘å®š `obsidian-spaced-repetition:srs-review-flashcards`ã€‚æ­¤æ’ä»¶å¿…é¡»å®‰è£…ä¸”å¯ç”¨ã€‚
    *   **Force Refresh**: ä¼˜å…ˆå°è¯• `window.paRefreshViews` (core v14+)ï¼Œå¤±è´¥åˆ™å›é€€åˆ° `dataview:force-refresh-views`ã€‚
*   **DOM Injection**:
    *   åŠ¨æ€æ³¨å…¥ `<style id="pa-mem-style-v3">`ã€‚è‹¥æ ·å¼é”™ä¹±ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»– Shadow DOM å†²çªã€‚

### 4. ğŸ—‚ï¸ ç­–ç•¥ä»“åº“: `scripts/pa-view-playbook.js`
**èŒè´£**: ç­–ç•¥å±•ç¤ºã€æ€§èƒ½ç»Ÿè®¡ã€åˆ†ç»„ç´¢å¼•ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Strategy Resolution (åç§°å½’ä¸€åŒ–)**:
    *   **Canonical Name**: æå…¶ä¾èµ– `strategyLookup` (Map) å°†åˆ«å (å¦‚ "TR", "Wedge") è½¬ä¸ºæ ‡å‡†åã€‚
    *   **CJK Check**: ä½¿ç”¨ `/[\u4e00-\u9fff]/` æ­£åˆ™æ£€æµ‹ä¸­æ–‡ã€‚è‹¥çº¯è‹±æ–‡ï¼Œå¼ºè¡Œæ·»åŠ  "å¾…è¡¥å……/" å‰ç¼€ä»¥æç¤ºæ±‰åŒ–ã€‚
*   **Runtime Aggregation (è¿è¡Œæ—¶ç»Ÿè®¡)**:
    *   **Performance**: ä¸ä¾èµ– core é¢„ç®—çš„ç»Ÿè®¡ï¼Œè€Œæ˜¯**ç°åœºéå†** `tradesAsc` è®¡ç®—æ¯ä¸ªç­–ç•¥çš„èƒœç‡/ç›ˆäºã€‚è¿™ä¿è¯äº† Playbook çœ‹åˆ°çš„æ•°æ®æ°¸è¿œæ˜¯æœ€æ–°çš„ (Real-time)ã€‚
*   **Grouping Logic**:
    *   **Primary Filter**: å– `s.marketCycles[0]` ä½œä¸ºä¸»åˆ†ç»„ã€‚å¦‚æœä¸€ä¸ªç­–ç•¥å±äºå¤šä¸ªå‘¨æœŸï¼Œå®ƒåªä¼šåœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸçš„åˆ†ç»„ä¸‹æ˜¾ç¤º (UI æƒè¡¡)ã€‚
    *   **Sort Order**: å®æˆ˜ä¸­ (Active) > ç›ˆäºé«˜ > æœ€è¿‘ä½¿ç”¨ã€‚

### 5. ğŸ—ºï¸ è¯¾ç¨‹åœ°å›¾: `scripts/pa-view-course.js`
**èŒè´£**: å±•ç¤ºå­¦ä¹ è¿›åº¦çŸ©é˜µä¸æ¨èè¯¾ç¨‹ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Rec Algorithm (æ··åˆæ¨è)**:
    1.  **Core Priority**: ä¼˜å…ˆä½¿ç”¨ core è®¡ç®—å¥½çš„ `hybridRec` (é¿å…é‡å¤è®¡ç®—)ã€‚
    2.  **Sequential Fallback**: è‹¥æ— æ¨èï¼ŒæŒ‰ `syllabus` é¡ºåºå¯»æ‰¾ç¬¬ä¸€ä¸ªæœªå®Œæˆ (`!isDone`) çš„ç« èŠ‚ã€‚
    3.  **Random Review**: è‹¥å…¨å·²å®Œæˆï¼ŒéšæœºæŠ½å–ä¸€èŠ‚ä½œä¸ºå¤ä¹ ã€‚
*   **ID Fuzzy Match**:
    *   `simpleId(id)`: ç§»é™¤æœ«å°¾å­—æ¯ (å¦‚ "L01A" -> "L01")ã€‚åˆ¤å®š `done` æ—¶ï¼Œåªè¦ ID æˆ– SimpleID åœ¨ `doneSet` ä¸­å³è§†ä¸ºå®Œæˆã€‚

### 6. ğŸ–¼ï¸ å¤ç›˜ç”»å»Š: `scripts/pa-view-gallery.js`
**èŒè´£**: è§†è§‰åŒ–å¤ç›˜ (Visual Review)ï¼Œå±•ç¤ºäº¤æ˜“æˆªå›¾ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Image Resolution (å›¾ç‰‡è§£æ)**:
    *   **Complex Regex**: æ”¯æŒè§£æ `cover` å­—æ®µä¸­çš„ `![[...]]` (WikiLink), `![](...)` (Markdown Link) æˆ– çº¯è·¯å¾„ã€‚
    *   **Path Resolve**: ä½¿ç”¨ `app.metadataCache.getFirstLinkpathDest` è§£å†³ç›¸å¯¹è·¯å¾„é—®é¢˜ã€‚è¿™æ˜¯æœ€å®¹æ˜“å‡º Bug çš„åœ°æ–¹ï¼Œä¿®æ”¹æ—¶éœ€æµ‹è¯•ä¸åŒå±‚çº§çš„å¼•ç”¨ã€‚
*   **Performance Constraint**:
    *   **Limit**: ç¡¬ç¼–ç åªå¤„ç†å‰ 20 ç¬”äº¤æ˜“ï¼Œæœ€ç»ˆåªæ¸²æŸ“ 4 å¼ å¡ç‰‡ï¼Œé˜²æ­¢ DOM è¿‡é‡å¡æ­» Obsidianã€‚

### 7. ğŸ” æ•°æ®å·¡æ£€: `scripts/pa-view-inspector.js`
**èŒè´£**: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ã€å¥åº·åº¦è¯„åˆ†ã€å­—æ®µåˆ†å¸ƒã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Validation Logic (æ ¡éªŒè§„åˆ™)**:
    *   **Whitelist Source**: è¯»å– `Templates/å±æ€§å€¼é¢„è®¾.md` ä½œä¸ºåˆæ³•å€¼ç™½åå•ã€‚è‹¥æ­¤æ–‡ä»¶ç¼ºå¤±ï¼Œæ ¡éªŒåŠŸèƒ½ä¼šå¤±æ•ˆã€‚
    *   **Consistency Check**: æ£€æŸ¥ `strategyName` æ˜¯å¦åœ¨ `strategyIndex` ä¸­å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œæ ‡è®°ä¸º "æœªçŸ¥ç­–ç•¥"ã€‚
    *   **Logic Check**: æ£€æµ‹ `pnl != 0 && r == 0` (æœ‰ç›ˆäºä½†æ— é£é™©å›æŠ¥æ¯”) çš„é€»è¾‘çŸ›ç›¾ã€‚
*   **Stable Aggregation**:
    *   ä½¿ç”¨ `stableKey` (å¦‚ `tickerKey`, `tfKey`) è¿›è¡Œèšåˆç»Ÿè®¡ï¼Œé¿å… "ES" å’Œ "ES(Mini)" è¢«æ‹†æˆä¸¤é¡¹ã€‚ä¿®æ”¹ `pa-core` çš„å½’ä¸€åŒ–é€»è¾‘æ—¶éœ€æ³¨æ„æ­¤å¤„çš„ä¾èµ–ã€‚

---

## ğŸ› ï¸ ç»´æŠ¤å®ˆåˆ™ (Maintainer Protocols)

1.  **åŸå­åŒ–æ ¸å¿ƒå‡çº§**: ä¿®æ”¹ `pa-core.js` æ—¶ï¼Œå°½é‡åªæ”¹åŠ¨å…·ä½“çš„å¤„ç†å‡½æ•°ï¼Œä¸è¦ç ´åé¡¶å±‚çš„ `try-catch` ç»“æ„å’Œå…¨å±€å˜é‡åˆå§‹åŒ–ã€‚
2.  **Manifesto First**: é‡åˆ°ä¸ç†è§£çš„å˜é‡ï¼ˆå¦‚ `__paUserScrollIntentInstalled`ï¼‰ï¼Œå…ˆæŸ¥é˜…æ­¤æ–‡æ¡£ï¼Œä¸è¦éšæ„åˆ é™¤çœ‹ä¼¼â€œæ— ç”¨â€çš„ä»£ç â€”â€”å®ƒä»¬é€šå¸¸æ˜¯ä¸ºäº†å¤„ç† Obsidian çš„æ€ªå¼‚è¡Œä¸ºã€‚
