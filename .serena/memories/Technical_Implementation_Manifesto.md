# ğŸ“„ äº¤æ˜“å‘˜æ§åˆ¶å° (Trader Command) æŠ€æœ¯å®ç°ç™½çš®ä¹¦ (Technical Manifesto)

> **âš ï¸ Agent æ³¨æ„**: æ­¤æ–‡æ¡£è®°å½•äº†ç³»ç»Ÿ**"ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡"**ä»¥åŠ**"æ ¸å¿ƒé€»è¾‘å¦‚ä½•è¿è½¬"**ã€‚åœ¨ä¿®æ”¹å¤æ‚è„šæœ¬ï¼ˆå°¤å…¶æ˜¯ coreï¼‰ä¹‹å‰ï¼Œ**å¿…é¡»**å…ˆé˜…è¯»ç›¸å…³ç« èŠ‚ã€‚ä¿®æ”¹ä»£ç åï¼Œ**å¿…é¡»**åŒæ­¥æ›´æ–°æ­¤æ–‡æ¡£ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå¼•æ“: `scripts/pa-core.js`

**æ–‡ä»¶å®šä½**: ç³»ç»Ÿçš„å•ä¸€æ•°æ®æº (Single Source of Truth)ï¼Œè´Ÿè´£åŠ è½½ã€æ¸…æ´—äº¤æ˜“æ•°æ®ï¼Œè®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ï¼Œå¹¶ç®¡ç†å…¨å±€ç¼“å­˜ã€‚

### 1. æ™ºèƒ½ç¼“å­˜ä¸åˆ·æ–°æœºåˆ¶ (Smart Cache & Refresh)

*   **ç—›ç‚¹è§£å†³**: è§£å†³ DataviewJS é¢‘ç¹åˆ·æ–°å¯¼è‡´çš„å¡é¡¿å’Œæ»šåŠ¨æ¡è·³åŠ¨é—®é¢˜ã€‚
*   **æ ¸å¿ƒçŠ¶æ€**:
    *   `window.__paBuilding`: é”ï¼Œé˜²æ­¢å¹¶å‘é€’å½’åˆ·æ–°ã€‚
    *   `window.paForceReload`: æ ‡å¿—ä½ï¼ŒUI æŒ‰é’®ç‚¹å‡»åˆ·æ–°æ—¶ç½®ä¸º trueã€‚
    *   `window.paDirty`: è„æ ‡è®°ï¼Œç”± `app.vault.on('modify')` è§¦å‘ï¼Œæ ‡å¿—ç€æœ‰æ•°æ®æ–‡ä»¶å˜æ›´ã€‚
*   **é€»è¾‘æµç¨‹**:
    1.  **Check**: æ£€æŸ¥ `cachedTs` æ˜¯å¦è¿‡æœŸï¼ˆé»˜è®¤ ttl åœ¨ config ä¸­å®šä¹‰ï¼‰ä¸” `paDirty` ä¸º falseã€‚
    2.  **Hit**: å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å› `window.paData` ä¸­çš„æ•°æ®ï¼ˆæé€Ÿæ¨¡å¼ï¼‰ã€‚
    3.  **Miss**: å¦‚æœæœªå‘½ä¸­æˆ–å¼ºåˆ¶åˆ·æ–°ï¼Œæ‰§è¡Œå…¨é‡æ‰«æï¼ˆæ‰«ææ¨¡å¼ï¼‰ã€‚

### 2. æ»šåŠ¨æ¡é”å®šæŠ€æœ¯ (Scroll Locking)

*   **å¤æ‚é€»è¾‘**: Dataview åˆ·æ–°ä¼šé”€æ¯ DOMï¼Œå¯¼è‡´é¡µé¢è·³å›é¡¶éƒ¨ã€‚æˆ‘ä»¬å®ç°äº†å¤æ‚çš„â€œæ»šåŠ¨ä¿æŒâ€é€»è¾‘ã€‚
*   **å…³é”®å‡½æ•°**:
    *   `paCaptureScrollState()`: æ•è·å½“å‰ leaf çš„ scrollTop/Ratioã€‚
    *   `paStartScrollLock()`: åœ¨åˆ·æ–°æœŸé—´å¼€å¯ä¸€ä¸ª `requestAnimationFrame` å¾ªç¯ï¼Œå¼ºè¡ŒæŠŠ scrollTop é’‰åœ¨ç›®æ ‡ä½ç½®ï¼Œé˜²æ­¢è§†è§‰è·³åŠ¨ã€‚
    *   `paRestoreScrollState()`: åˆ·æ–°å®Œæˆåï¼Œç­‰å¾… DOM é«˜åº¦ç¨³å®šï¼ˆ3å¸§ä¸å˜ï¼‰åï¼Œæ¢å¤ä½ç½®ã€‚
*   **é™·é˜± (Pitfalls)**:
    *   ä¸è¦è½»æ˜“ä¿®æ”¹ `paGetScrollerElForLeaf` ä¸­çš„é€‰æ‹©å™¨ä¼˜å…ˆçº§ï¼ˆ`.view-content` vs `.cm-scroller`ï¼‰ï¼Œè¿™é€‚é…äº† Obsidian é˜…è¯»/ç¼–è¾‘æ¨¡å¼çš„å·®å¼‚ã€‚

### 3. æ•°æ®æ¸…æ´—ç®¡é“ (Data Pipeline)

*   **Review Hints (æ™ºèƒ½å¤ç›˜æç¤º)**:
    *   **é€»è¾‘**: è¿™é‡Œä¸ä»…åŠ è½½æ•°æ®ï¼Œè¿˜è¿è¡Œäº†ä¸€å±‚è½»é‡çº§ AI è§„åˆ™ (`buildReviewHints`)ã€‚
    *   **è§„åˆ™**: æ£€æŸ¥ `setup`, `market_cycle`, `strategyName` ç­‰å­—æ®µæ˜¯å¦ç¼ºå¤±ï¼Œç”Ÿæˆæç¤ºå¯¹è±¡æ•°ç»„ã€‚
    *   **ç›®çš„**: ç»™ UI å±‚æ˜¾ç¤º "âš ï¸ ç¼ºå°‘è®¾ç½®" è­¦å‘Šï¼Œè€Œä¸ç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶ã€‚

### 4. æ•°æ®ç»“æ„ (Data Schema)

*   `window.paData.tradesAsc`: äº¤æ˜“æ•°ç»„ï¼ŒæŒ‰æ—¶é—´å‡åºï¼ˆæ—§->æ–°ï¼‰ã€‚
*   `window.paData.stats`: `livePnL`, `liveWin` ç­‰å®æ—¶ç»Ÿè®¡ã€‚
*   `window.paData.strategyIndex`: ç­–ç•¥åº“ç´¢å¼•ï¼Œç”± `Strategy Repository/` æ–‡ä»¶å¤¹è§£æè€Œæ¥ã€‚

---

## ğŸ“Š è§†å›¾å®ç°: `scripts/pa-view-*.js`

### 1. âš”ï¸ äº¤æ˜“ä¸­å¿ƒ: `scripts/pa-view-today.js`
**èŒè´£**: å®æ—¶æˆ˜å†µçœ‹æ¿ã€‚å®ƒæ˜¯ç”¨æˆ·äº¤æ˜“æ—¶çš„"æŠ¬å¤´æ˜¾ç¤ºå™¨ (HUD)"ã€‚

#### ğŸ”§ å…³é”®ä¾èµ– (Critical Dependencies)
*   **Global State**: å¼ºä¾èµ– `window.paData.tradesAsc` (æ•°æ®æº) å’Œ `window.paData.strategyIndex` (ç­–ç•¥åŒ¹é…)ã€‚è‹¥ `paData` ä¸ºç©ºï¼Œè„šæœ¬ä¼šé™é»˜å¤±è´¥ (return empty)ã€‚
*   **Active Trade Logic**:
    *   **åˆ¤å®šæ ‡å‡†**: `!t.outcome`. åªè¦ `outcome` å­—æ®µä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œå³è§†ä¸º"è¿›è¡Œä¸­"ã€‚
    *   **éšæ‚£**: å¦‚æœæ‚¨æ‰‹åŠ¨å¡«å†™äº† "Partial" ä½†æ²¡å¡« "Win/Loss"ï¼Œä¼šè¢«è§†ä¸ºå·²ç»“æŸã€‚åŠ¡å¿…æ³¨æ„ `outcome` ä¸ºä¸»è¦çŠ¶æ€å­—æ®µã€‚
*   **Strategy Matching (åŒ¹é…é“¾)**:
    1.  **ç²¾ç¡®åŒ¹é…**: éå†å½“å‰äº¤æ˜“çš„ `patterns` æ•°ç»„ (å¦‚ `['Wedge']`) -> æŸ¥è¡¨ `strategyIndex.byPattern` -> å‘½ä¸­ç­–ç•¥å¡ã€‚
    2.  **æ¨¡ç³Šå…œåº•**: è‹¥æ—  patternï¼Œåˆ™ç”± `market_cycle` + `setup` (å¦‚ "Trading Range", "Pullback") è¿›è¡Œç²—ç•¥è®¡åˆ†æ¨èã€‚
*   **Hardcoded Actions**:
    *   **QuickAdd**: æŒ‰é’®ç»‘å®šäº†å‘½ä»¤ID `quickadd:choice:New Live Trade`ã€‚è‹¥æ‚¨åœ¨ QuickAdd æ’ä»¶ä¸­é‡å‘½åäº†æ­¤åŠ¨ä½œï¼ŒæŒ‰é’®å°†å¤±æ•ˆã€‚
    *   **Daily Link**: å‡è®¾æ—¥è®°è·¯å¾„ä¸º `Daily/YYYY-MM-DD_Journal`ã€‚è‹¥ä¿®æ”¹æ—¥è®°å­˜æ”¾ç›®å½•ï¼Œ"åˆ›å»ºä»Šæ—¥æ—¥è®°"é“¾æ¥éœ€åŒæ­¥ä¿®æ”¹ã€‚

### 2. ğŸ“Š æ•°æ®ä¸­å¿ƒ: `scripts/pa-view-hub-analytics.js`
**èŒè´£**: è´¦æˆ·åˆ†æã€èµ„é‡‘æ›²çº¿ã€é”™è¯¯å½’å› ã€‚

#### ğŸ”§ å…³é”®å®ç° (Critical Implementation)
*   **Data Parsing**:
    *   **Type Filter**: ä¸¥æ ¼åŒºåˆ† `Live` (å®ç›˜), `Demo` (æ¨¡æ‹Ÿ), `Backtest` (å›æµ‹)ã€‚å¤§å°å†™æ•æ„Ÿ (è™½ç„¶éƒ¨åˆ†é€»è¾‘åšäº† `.toLowerCase()` å…¼å®¹ï¼Œä½†å»ºè®®ç»Ÿä¸€é¦–å­—æ¯å¤§å†™)ã€‚
    *   **PnL Safety**: ä½¿ç”¨ `parseFloat(t.pnl) || 0`ã€‚å³ä½¿ Frontmatter å†™é”™æˆ `pnl: null` æˆ– `pnl: "100u"`, ä¹Ÿèƒ½å®‰å…¨å¤„ç†ä¸º 0ï¼Œé˜²æ­¢æ•´ä¸ªè®¡ç®—å´©æºƒã€‚
*   **Equity Curve (èµ„é‡‘æ›²çº¿)**:
    *   **ç´¯åŠ é€»è¾‘**: åŸºäº `tradesAsc` (æ—¶é—´å‡åº) è¿›è¡Œ `cum += pnl`ã€‚å› æ­¤ `pa-core` å¿…é¡»ä¿è¯ `tradesAsc` æ’åºæ­£ç¡®ï¼Œå¦åˆ™æ›²çº¿ä¼šç©¿è¶Šæ—¶ç©ºã€‚
    *   **SVG Rendering**: åŠ¨æ€è®¡ç®— `maxVal/minVal`ã€‚
        *   *Edge Case*: å¦‚æœè´¦æˆ·åªæœ‰ 1 ç¬”äº¤æ˜“æˆ–ç›ˆäºå…¨ä¸º 0 (max=min)ï¼Œåˆ†æ¯ä¸º 0 ä¼šå¯¼è‡´ `Infinity`ã€‚ä»£ç ä¸­åšäº† `range || 1` æˆ– `maxVal = Math.max(.., 100)` çš„å…œåº•ã€‚
*   **Strategy Identification**:
    *   **Source of Truth**: ä¼˜å…ˆä½¿ç”¨ `strategyIndex` (æ¥è‡ª core)ã€‚è¿™ä¿è¯äº† Dashboard å’Œ Analytics çœ‹åˆ°çš„ç­–ç•¥åç§°æ°¸è¿œä¸€è‡´ã€‚
    *   **Fallback**: è‹¥ core æœªå°±ç»ªï¼Œä¼šé™çº§ä¸ºæœ¬åœ°ç®€æ˜“æ˜ å°„ (ä¸æ¨è)ã€‚

---

## ğŸ› ï¸ ç»´æŠ¤å®ˆåˆ™ (Maintainer Protocols)

1.  **åŸå­åŒ–æ ¸å¿ƒå‡çº§**: ä¿®æ”¹ `pa-core.js` æ—¶ï¼Œå°½é‡åªæ”¹åŠ¨å…·ä½“çš„å¤„ç†å‡½æ•°ï¼Œä¸è¦ç ´åé¡¶å±‚çš„ `try-catch` ç»“æ„å’Œå…¨å±€å˜é‡åˆå§‹åŒ–ã€‚
2.  **Manifesto First**: é‡åˆ°ä¸ç†è§£çš„å˜é‡ï¼ˆå¦‚ `__paUserScrollIntentInstalled`ï¼‰ï¼Œå…ˆæŸ¥é˜…æ­¤æ–‡æ¡£ï¼Œä¸è¦éšæ„åˆ é™¤çœ‹ä¼¼â€œæ— ç”¨â€çš„ä»£ç â€”â€”å®ƒä»¬é€šå¸¸æ˜¯ä¸ºäº†å¤„ç† Obsidian çš„æ€ªå¼‚è¡Œä¸ºã€‚
