# 📋 交易员控制台系统技术报告 v5.0

> **报告日期**: 2025 年 12 月 25 日  
> **系统定位**: Obsidian + DataviewJS 的交易系统控制台（Al Brooks PA）  
> **目标**: 更智能（复盘要点/聚合）+ 更安全（不易崩）+ 更易扩展（字段/策略/视图）

---

## 🎯 v5.0 变更导向（你最关心的三件事）

1. **智能化优先级**（你确认的顺序）

   - C：自动生成复盘要点（Review Hints）
   - D：跨笔记聚合/对账（Consistency & Reconciliation）
   - A：自动识别策略/周期（Strategy/Context Identification）
   - B：自动发现缺失字段/类型异常（Schema & Health Check）

2. **扩展清晰：两者都要（C）**

   - YAML schema：字段定义、类型、允许值、迁移兼容
   - 脚本模块：单一信源、复用、失败隔离、缓存一致

3. **v5.0 核心原则**
   - 单一信源：策略映射、字段规范化、显示双语规则不在各 View 重复实现
   - 失败不扩散：单文件异常不影响全局；高风险写入要可预期
   - 向后兼容：旧字段/旧写法依然可读，必要时提供兼容映射

---

## 🧭 系统总览（System Overview）

### 项目由什么组成

- **数据层**：Markdown + YAML Frontmatter
- **运行时**：Obsidian + DataviewJS
- **引擎**：`window.paData`（由 Core 构建并缓存）
- **视图**：一组 View 脚本负责渲染不同面板（Inspector/Playbook/Today/Analytics/Manager/Schema...）

### 关键输出（单一入口）

- `window.paData.trades` / `tradesAsc`：交易数据（归一化后）
- `window.paData.stats`：统计
- `window.paData.strategyIndex`：策略索引（策略库单一信源）
- `window.paData.sr` / `course`：学习与复习相关

---

## 🔄 数据流（Data Flow）

```
Markdown/YAML
   │  (Dataview scan)
   ▼
Core: scripts/pa-core.js
   │  - 读取、归一化、校验、缓存
   │  - 产出 window.paData
   ▼
Views: scripts/pa-view-*.js
   │  - 只做展示/交互
   │  - 复用 paData 与统一映射
   ▼
UI: Dashboard / Panels
```

### 缓存策略（现状 + 建议）

- **现状**：Core 有 TTL 缓存与强制刷新入口（hard refresh）
- **建议**：
  - 所有 View **只读** `window.paData`，不自行重复扫描（除非明确标注为兜底）
  - 所有写入（Manager）后统一触发一次 refresh

---

## 🧩 模块边界与契约（Module Contracts）

下面是 v5.0 要“写死”的契约：每个模块只做自己的事，减少口径漂移。

### Core（scripts/pa-core.js）

- **输入**：Dataview pages（交易、策略、课程、复习…）
- **输出**：`window.paData`（trades/stats/strategyIndex/sr/course…）
- **依赖**：`pa-config.js`、`pa-utils.js`、Obsidian API、Dataview API
- **缓存**：TTL + 手动强制刷新
- **失败兜底**：
  - 单页读取异常不应中断全量构建
  - 字段缺失/类型异常应被归一化到安全默认值
- **扩展点**：
  - 新增 trade 字段：在 Core 归一化一次，然后 View 只读使用
  - 新增策略卡字段：进入 strategyIndex 的 item 结构（marketCycles/patterns/source...）

### Utils（scripts/pa-utils.js）

- **输入**：任意 Dataview/Obsidian 值（string/array/link/object/number…）
- **输出**：稳定的 scalar/array/number，避免 `"[object Object]"`、`Proxy`、数组/标量混乱
- **依赖**：无（纯函数优先）
- **失败兜底**：永不 throw（除非显式要求）
- **扩展点**：新增字段类型时只补 utils 的 normalize，不要在每个 View 各写一份

### Strategy Index（window.paData.strategyIndex）

- **输入**：策略仓库策略卡
- **输出**：
  - `list[]`：策略条目
  - `lookup`：别名 -> 规范名（CN/EN/Full）
  - `byPattern`：pattern -> 规范名
- **契约**：
  - View 不得重复构建自己的 lookup/byPattern（避免漂移）
  - 显示层如需“只显示中文”，必须是展示规则，不得污染索引数据

### Views（scripts/pa-view-\*.js）

通用契约：

- **输入**：只读 `window.paData`（必要时兜底扫描，但必须注明）
- **输出**：UI
- **失败兜底**：数据缺失时显示“待补充/Unknown”，但不要报错

### Manager（scripts/pa-view-manager.js，高风险模块）

- **输入**：路径集合 + 操作（rename/update/append/delete/inject）
- **输出**：frontmatter 写入 + refresh
- **风险**：写入失败、覆盖字段、数组/标量类型混乱
- **v5.0 要求**：
  - 写入前约束（不覆盖关键字段/可选白名单）
  - 单文件失败要汇总提示，不扩散成“系统崩了”的体验

---

## 🧠 智能化路线（按你的优先级）

### C. 自动复盘要点（Review Hints）

目标：当交易缺少复盘总结时，系统基于已有字段自动生成“要写什么”的提示（中英对照）。

- **输入候选**：setup / patterns / cycle / entry/exit / pnl/R / 错误标签 / 心态字段
- **输出格式建议**：`trade.reviewHints = [{id, zh, en}]`
- **展示位置建议**（后续落地）：Inspector 的 trade 详情 / Today 的当日复盘区

### D. 跨笔记聚合/对账

目标：同一日期/同一账户/同一品种的交易在统计与列表里口径一致，发现异常自动提示。

- **一致性规则**：
  - 日期归一化
  - 账户类型归一化
  - 货币/金额格式归一化
  - R 值计算口径固定

### A. 自动识别策略/周期

- **核心依赖**：strategyIndex（lookup/byPattern）
- **输出**：trade 的 canonical strategyName 与 cycle

### B. 自动发现缺失字段/类型异常

- **输出**：问题列表 + 可点击跳转
- **策略**：优先做“不会误报”的强规则，再逐步加弱规则

---

## 🧰 扩展指南（你改东西不会崩的关键）

### 1) 新增/调整 YAML 字段（交易模板）

- **推荐流程**：

  1. 先在模板中新增字段
  2. 在 Core 里把该字段纳入归一化（默认值 + 类型）
  3. 在 Schema/Inspector 增加校验（缺失/非法值）
  4. 最后在 View 展示

- **不要做的事**：
  - 不要在某个 View 里直接拿原始字段做复杂逻辑（会口径漂移）

### 2) 新增策略卡字段（策略仓库）

- **推荐流程**：
  1. 在策略卡 YAML 增加字段
  2. 让 Core 的 strategyIndex item 收录该字段
  3. View 只读 item

### 3) 新增一个 View

- 只读 `window.paData`
- 所有字符串显示遵循“中文优先/中英对照”的统一规则
- 不得在 View 内重建策略索引

---

## ✅ 优化清单（可执行）

### 立刻改（收益高/风险低）

1. **把重复映射/重复识别统一到 Core**（已开始：Analytics Hub 已优先复用 strategyIndex）
2. **为智能复盘要点在 Core 产出结构化 hints**（不改 UI，后续逐步接入 Inspector/Today）
3. **所有 View 对 `Unknown/null/Empty` 兜底格式统一**（避免同一字段不同模块不同显示）

### 需要谨慎重构（收益高/风险中高）

1. **Manager 写入治理**：字段白名单、写入预览/回滚、批处理事务化（或最小化失败影响）
2. **统一字段读取层**：把数组/标量/link/proxy 归一化从各模块收敛到 utils
3. **Schema 规则体系**：把“强规则/弱规则”分层，减少误报

---

## 📌 v5.0 里程碑建议

- M1：文档（本文件）+ strategyIndex 单一信源推广到所有关键 View
- M2：Review Hints（Core 生成 + Inspector 展示）
- M3：跨笔记对账（同日/同账户一致性）
- M4：Schema 规则体系 + Manager 写入治理
