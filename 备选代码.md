
```dataviewjs
// === æ¨¡å—: âš”ï¸ äº¤æ˜“æ‰§è¡Œ (Action) ===
const root = dv.el("div", "", { attr: { style: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:15px; display:flex; justify-content:space-between; align-items:center;" } });

const btnStyle = "background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:8px 16px; border-radius:6px; cursor:pointer; color:white; font-weight:bold; font-size:0.9em; text-decoration:none;";

root.innerHTML = `
<div style="display:flex; gap:10px;">
    <a class="internal-link" href="Daily Journal" style="${btnStyle} border-color:#10B981; color:#10B981;">+ æ–°å»ºå®ç›˜ (Live)</a>
    <a class="internal-link" href="Daily Journal" style="${btnStyle} border-color:#3B82F6; color:#3B82F6;">+ æ–°å»ºæ¨¡æ‹Ÿ (Demo)</a>
    <a class="internal-link" href="Daily Journal" style="${btnStyle} border-color:#F59E0B; color:#F59E0B;">+ æ–°å»ºå›æµ‹ (Back)</a>
</div>
<div style="font-size:0.8em; opacity:0.5; text-align:right;">
    è®°å¾—æ£€æŸ¥<br>Context & Risk
</div>
`;
```

```dataviewjs
// === æ¨¡å—: ğŸ§  è®°å¿†åº“ v5.3 (çº¯å‡€ç¨³å®šç‰ˆ) ===
// 1. é…ç½®
const cfg = {
    card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;",
    purple: "#8B5CF6", blue: "#3B82F6", green: "#10B981", red: "#EF4444", orange: "#F59E0B", 
    textSub: "rgba(255,255,255,0.5)", barBg: "rgba(255,255,255,0.1)"
};

// 2. å¯»æ‰¾å‘½ä»¤ID
let targetCmd = "obsidian-spaced-repetition:review-flashcards"; 
for(const id in app.commands.commands) {
    if((id.includes("spaced-repetition") || id.includes("flashcards")) && (id.includes("review-flashcards") || id.includes("review-all"))) {
        targetCmd = id;
    }
}

// 3. æ•°æ®ç»Ÿè®¡
const files = dv.pages('#flashcards AND -"Templates"');
const todayStr = moment().format("YYYY-MM-DD");
const todayMoment = moment();

// ç»Ÿè®¡å¯¹è±¡
let stats = { total: 0, due: 0, future: 0, newCards: 0 };
let typeStats = { single: 0, multi: 0, cloze: 0 };
let folderStats = {}; 
let loadChart = [0,0,0,0,0,0,0]; // æœªæ¥7å¤©
let hardCards = []; 
let easeTotal = 0;
let easeCount = 0;

// æ­£åˆ™è¡¨è¾¾å¼ (å®‰å…¨å†™æ³•)
const reCloze = new RegExp("==[^=]+==", "g");
const reSingleRev = new RegExp("^.+?:::.+$", "gm");
const reSingleNorm = new RegExp("^.+?::.+$", "gm");
const reMultiRev = new RegExp("^(?:\\>)?\\s*\\?\\?\\s*$", "gm");
const reMultiNorm = new RegExp("^(?:\\>)?\\s*\\?\\s*$", "gm");
const reSR = new RegExp("", "g");

for (let p of files) {
    // è¯»å–æ–‡ä»¶
    const content = await app.vault.read(app.vault.getAbstractFileByPath(p.file.path));
    
    // --- A. å¡ç‰‡ç±»å‹è®¡æ•° ---
    const c_cloze = (content.match(reCloze) || []).length;
    const c_sRev = (content.match(reSingleRev) || []).length;
    const allColons = (content.match(reSingleNorm) || []).length;
    // æ’é™¤æ‰åŒ…å« ::: çš„è¡Œ
    const c_sNorm = Math.max(0, allColons - c_sRev);
    const c_mRev = (content.match(reMultiRev) || []).length;
    const c_mNorm = (content.match(reMultiNorm) || []).length;
    
    let fileCards = c_cloze + c_sNorm + (c_sRev*2) + c_mNorm + (c_mRev*2);
    stats.total += fileCards;
    
    typeStats.cloze += c_cloze;
    typeStats.single += (c_sNorm + c_sRev);
    typeStats.multi += (c_mNorm + c_mRev);

    // --- B. æ–‡ä»¶å¤¹æ¥æº ---
    if (fileCards > 0) {
        let folder = p.file.folder.split("/").pop() || "Root";
        if (!folderStats[folder]) folderStats[folder] = 0;
        folderStats[folder] += fileCards;
    }

    // --- C. SR æ•°æ®åˆ†æ ---
    const srMatches = content.match(reSR) || [];
    for (let tag of srMatches) {
        // æ‰‹åŠ¨è§£æ: // æ—¥æœŸ: ç´¢å¼•8å¼€å§‹ï¼Œé•¿åº¦10
        const date = tag.substring(8, 18);
        // Ease: æœ€åä¸€ä¸ªé€—å·åï¼Œå€’æ•°ç¬¬3ä¸ªå­—ç¬¦å‰
        const lastComma = tag.lastIndexOf(",");
        const easeStr = tag.substring(lastComma + 1, tag.length - 3);
        const ease = parseInt(easeStr) || 250;

        // 1. æŒæ¡åº¦
        easeTotal += ease;
        easeCount++;

        // 2. åˆ°æœŸçŠ¶æ€
        if (date <= todayStr) stats.due++;
        else stats.future++;
        
        // 3. è´Ÿè½½å›¾è¡¨
        let diff = moment(date).diff(todayMoment, 'days');
        if (diff >= 0 && diff < 7) loadChart[diff]++;
        
        // 4. å›°éš¾å¡ç‰‡ (Ease < 230)
        if (ease < 230) {
            hardCards.push({ file: p.file.name, ease: ease, path: p.file.path });
        }
    }
}

// è®¡ç®—è¡ç”Ÿæ•°æ®
stats.newCards = Math.max(0, stats.total - stats.due - stats.future);
hardCards.sort((a, b) => a.ease - b.ease);
const topHard = hardCards.slice(0, 3);
const maxLoad = Math.max(...loadChart, 1);
const avgEase = easeCount > 0 ? Math.round(easeTotal / easeCount) : 0;
// æŒæ¡åº¦é¢œè‰²
let masteryColor = cfg.green;
if (avgEase < 230) masteryColor = cfg.blue;
if (avgEase < 200) masteryColor = cfg.orange;

// æ–‡ä»¶å¤¹æ’åº
const topFolders = Object.keys(folderStats)
    .map(k => ({ name: k, count: folderStats[k] }))
    .sort((a, b) => b.count - a.count).slice(0, 4);

// è¿›åº¦æ¡ç™¾åˆ†æ¯”
const pSingle = stats.total > 0 ? (typeStats.single/stats.total*100) : 0;
const pMulti = stats.total > 0 ? (typeStats.multi/stats.total*100) : 0;
const pCloze = stats.total > 0 ? (typeStats.cloze/stats.total*100) : 0;

// === æ¸²æŸ“ HTML ===
const htmlParts = [];

// 1. æ ‡é¢˜å¤´
htmlParts.push(
    '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">',
        '<div>',
            '<div style="font-weight:800; color:' + cfg.purple + '; font-size:1.1em;">ğŸ§  è®°å¿†åº“ (Memory Bank)</div>',
            '<div style="font-size:0.8em; opacity:0.6; margin-top:4px;">' + files.length + ' Notes | ' + stats.total + ' Cards</div>',
        '</div>',
        '<div style="text-align:right;">',
            '<div style="font-size:1.8em; font-weight:800; color:#fff; line-height:1;">' + stats.due + '</div>',
            '<div style="font-size:0.7em; color:' + cfg.red + '; font-weight:bold;">Due Today</div>',
        '</div>',
    '</div>'
);

// 2. è¿›åº¦æ¡ + è¯¦æƒ…
htmlParts.push(
    '<div style="display:flex; gap:4px; height:6px; width:100%; border-radius:3px; overflow:hidden; margin-bottom:8px; opacity:0.8;">',
        '<div style="width:' + pSingle + '%; background:' + cfg.blue + ';"></div>',
        '<div style="width:' + pMulti + '%; background:' + cfg.green + ';"></div>',
        '<div style="width:' + pCloze + '%; background:' + cfg.purple + ';"></div>',
    '</div>',
    '<div style="display:flex; gap:12px; font-size:0.7em; color:' + cfg.textSub + '; margin-bottom:15px;">',
        '<span style="color:' + cfg.blue + '">â— å•è¡Œ ' + typeStats.single + '</span>',
        '<span style="color:' + cfg.green + '">â— å¤šè¡Œ ' + typeStats.multi + '</span>',
        '<span style="color:' + cfg.purple + '">â— å¡«ç©º ' + typeStats.cloze + '</span>',
        '<span style="margin-left:auto; color:' + masteryColor + '; font-weight:bold;" title="å¹³å‡ Ease åˆ†å€¼">ğŸ”¥ æŒæ¡åº¦: ' + avgEase + '%</span>',
    '</div>'
);

// 3. æœªæ¥è´Ÿè½½å›¾è¡¨
let chartHtml = '<div style="display:flex; align-items:flex-end; gap:4px; height:45px; margin-bottom:15px; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.05);">';
const days = ["ä»Š", "æ˜", "+2", "+3", "+4", "+5", "+6"];
loadChart.forEach((val, i) => {
    let h = Math.max(4, (val / maxLoad) * 40); 
    let color = i === 0 ? cfg.red : (val > 0 ? cfg.blue : cfg.barBg);
    let opacity = val > 0 ? 0.9 : 0.3;
    chartHtml += 
    '<div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:2px;">' + 
        '<div style="width:100%; height:' + h + 'px; background:' + color + '; border-radius:2px; opacity:' + opacity + ';"></div>' +
        '<div style="font-size:0.6em; opacity:0.5;">' + days[i] + '</div>' + 
    '</div>';
});
chartHtml += '</div>';
htmlParts.push(chartHtml);

// 4. æ–‡ä»¶å¤¹æ¥æº (å¦‚æœå­˜åœ¨)
if (topFolders.length > 0) {
    let folderHtml = '<div style="display:flex; gap:8px; margin-bottom:15px; flex-wrap:wrap;">';
    topFolders.forEach(f => {
        folderHtml += '<div style="font-size:0.7em; background:rgba(255,255,255,0.05); padding:3px 8px; border-radius:4px; color:' + cfg.textSub + ';">ğŸ“‚ ' + f.name + ' <span style="color:#fff; font-weight:bold;">' + f.count + '</span></div>';
    });
    folderHtml += '</div>';
    htmlParts.push(folderHtml);
}

// 5. è®°å¿†ç¼ºé™· (å¦‚æœå­˜åœ¨)
if (topHard.length > 0) {
    let hardHtml = '<div style="margin-bottom:15px; background:rgba(239, 68, 68, 0.1); border-radius:8px; padding:10px;">';
    hardHtml += '<div style="font-size:0.75em; font-weight:bold; color:' + cfg.red + '; margin-bottom:6px;">â˜ ï¸ è®°å¿†é»‘æ´ (Ease < 230)</div>';
    topHard.forEach(c => {
        hardHtml += 
        '<div style="display:flex; justify-content:space-between; font-size:0.75em; margin-bottom:4px; border-bottom:1px dashed rgba(255,255,255,0.1); padding-bottom:2px;">' +
            '<a href="' + c.path + '" class="internal-link" style="color:rgba(255,255,255,0.8); text-decoration:none; max-width:70%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + c.file + '</a>' +
            '<span style="color:' + cfg.orange + '; font-family:monospace;">' + c.ease + '%</span>' + 
        '</div>';
    });
    hardHtml += '</div>';
    htmlParts.push(hardHtml);
}

// 6. æŒ‰é’®
htmlParts.push(
    '<button id="sr-btn-stable" style="width:100%; background:' + cfg.purple + '; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; display:flex; justify-content:center; align-items:center; gap:8px;">âš¡ï¸ å¼€å§‹å¤ä¹ </button>'
);

const root = dv.el("div", "", { attr: { style: cfg.card } });
root.innerHTML = htmlParts.join("");

// å®‰å…¨ç»‘å®š
setTimeout(() => {
    const btn = root.querySelector("#sr-btn-stable");
    if(btn) btn.onclick = () => app.commands.executeCommandById(targetCmd);
}, 200);
```

```dataviewjs
// === æ¨¡å—: ğŸ§  è®°å¿†åº“ v5.7 (æŒ‰é’®ç‰¹ç§ä¿®å¤ç‰ˆ) ===
const cfg = {
    card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;",
    purple: "#8B5CF6", blue: "#3B82F6", green: "#10B981", red: "#EF4444", orange: "#F59E0B", 
    textSub: "rgba(255,255,255,0.5)", barBg: "rgba(255,255,255,0.1)"
};

// --- 1. æ·±åº¦æœç´¢å‘½ä»¤ (åŒ…å« AI ç‰ˆæ’ä»¶å…¼å®¹) ---
let targetCmd = "";
let cmdLabel = "æœªæ‰¾åˆ°å¤ä¹ æ’ä»¶";

// è·å–æ‰€æœ‰å‘½ä»¤ID
const allCmds = Object.keys(app.commands.commands);
// ä¼˜å…ˆæ‰¾ "å¤ä¹ æ‰€æœ‰ (Review All)"
const reviewAll = allCmds.find(id => id.includes("repetition") && (id.includes("review-all") || id.includes("review-all-cards")));
// å…¶æ¬¡æ‰¾ "å¤ä¹  (Review Flashcards)"
const reviewNormal = allCmds.find(id => id.includes("repetition") && id.includes("review-flashcards"));

if (reviewAll) {
    targetCmd = reviewAll;
    cmdLabel = "âš¡ï¸ å¼€å§‹å¤ä¹  (å…¨éƒ¨)";
} else if (reviewNormal) {
    targetCmd = reviewNormal;
    cmdLabel = "âš¡ï¸ å¼€å§‹å¤ä¹  (æ ‡å‡†)";
}

// --- 2. æ•°æ®ç»Ÿè®¡é€»è¾‘ ---
const currentFilePath = dv.current().file.path;
const files = dv.pages('#flashcards AND -"Templates"').where(p => p.file.path !== currentFilePath);
const todayStr = moment().format("YYYY-MM-DD");

let dbStats = { total: 0, due: 0, future: 0 };
let typeStats = { single: 0, multi: 0, cloze: 0 };
let folderStats = {};
let loadChart = [0,0,0,0,0,0,0];
let easeTotal = 0, easeCount = 0;
let debugFile = { name: "", count: 0 };

const reSR = new RegExp("", "g");

for (let p of files) {
    const content = await app.vault.read(app.vault.getAbstractFileByPath(p.file.path));
    if (!content) continue;

    // ç‰©ç†å¡ç‰‡ç»Ÿè®¡
    const c_cloze = (content.match(/==[^=]+==/g) || []).length;
    const c_sRev = (content.match(/^.+?:::.+$/gm) || []).length;
    const allColons = (content.match(/^.+?::.+$/gm) || []).length;
    const c_sNorm = Math.max(0, allColons - c_sRev);
    const c_mRev = (content.match(/^(?:\>)?\s*\?\?\s*$/gm) || []).length;
    const c_mNorm = (content.match(/^(?:\>)?\s*\?\s*$/gm) || []).length;
    
    let fileCards = c_cloze + c_sNorm + (c_sRev*2) + c_mNorm + (c_mRev*2);
    dbStats.total += fileCards;
    
    typeStats.cloze += c_cloze;
    typeStats.single += (c_sNorm + c_sRev);
    typeStats.multi += (c_mNorm + c_mRev);

    // æ–‡ä»¶å¤¹ç»Ÿè®¡ (åªè¦æœ‰å¡ç‰‡å°±è®¡å…¥)
    if (fileCards > 0) {
        let folder = p.file.folder.split("/").pop() || "Root";
        if (!folderStats[folder]) folderStats[folder] = 0;
        folderStats[folder] += fileCards;
    }

    // SR æ ‡ç­¾ç»Ÿè®¡
    const srMatches = content.match(reSR) || [];
    if (srMatches.length > debugFile.count) {
        debugFile.name = p.file.name;
        debugFile.count = srMatches.length;
    }

    for (let tag of srMatches) {
        let srDate = tag.substring(8, 18); 
        let lastComma = tag.lastIndexOf(",");
        let ease = parseInt(tag.substring(lastComma + 1, tag.length - 3)) || 250;
        easeTotal += ease; easeCount++;

        if (srDate <= todayStr) {
            dbStats.due++;
        } else {
            dbStats.future++;
            let diff = moment(srDate).startOf('day').diff(moment().startOf('day'), 'days');
            if (diff >= 0 && diff < 7) loadChart[diff]++;
        }
    }
}

// æŒæ¡åº¦ä¸æ–°å¡
const avgEase = easeCount > 0 ? (easeTotal / easeCount) : 0;
const masteryScore = Math.min(100, Math.round(avgEase / 2.5));
let masteryColor = masteryScore < 90 ? (masteryScore < 80 ? cfg.orange : cfg.blue) : cfg.green;

// æ¸²æŸ“ HTML
const htmlParts = [];

// æ ‡é¢˜
htmlParts.push(
    `<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
        <div>
            <div style="font-weight:800; color:${cfg.purple}; font-size:1.1em;">ğŸ§  è®°å¿†åº“ (Fixed)</div>
            <div style="font-size:0.8em; opacity:0.6; margin-top:4px;">${files.length} Notes | ${dbStats.total} Cards</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:1.8em; font-weight:800; color:#fff; line-height:1;">${dbStats.due}</div>
            <div style="font-size:0.7em; color:${cfg.red}; font-weight:bold;">Due Today</div>
        </div>
    </div>`
);

// è¿›åº¦æ¡
const pTotal = Math.max(dbStats.total, 1);
htmlParts.push(
    `<div style="display:flex; gap:4px; height:6px; width:100%; border-radius:3px; overflow:hidden; margin-bottom:8px; opacity:0.8;">
        <div style="width:${(typeStats.single/pTotal)*100}%; background:${cfg.blue};"></div>
        <div style="width:${(typeStats.multi/pTotal)*100}%; background:${cfg.green};"></div>
        <div style="width:${(typeStats.cloze/pTotal)*100}%; background:${cfg.purple};"></div>
    </div>
    <div style="display:flex; gap:12px; font-size:0.7em; color:${cfg.textSub}; margin-bottom:15px;">
        <span style="color:${cfg.blue}">â— å•è¡Œ ${typeStats.single}</span>
        <span style="color:${cfg.green}">â— å¤šè¡Œ ${typeStats.multi}</span>
        <span style="color:${cfg.purple}">â— å¡«ç©º ${typeStats.cloze}</span>
        <span style="margin-left:auto; color:${masteryColor}; font-weight:bold;">ğŸ”¥ æŒæ¡åº¦: ${masteryScore}%</span>
    </div>`
);

// ğŸ“‚ æ–‡ä»¶å¤¹æ¥æº (å›å½’ç»å…¸æ ·å¼)
const topFolders = Object.keys(folderStats)
    .map(k => ({ name: k, count: folderStats[k] }))
    .sort((a, b) => b.count - a.count).slice(0, 5);

if (topFolders.length > 0) {
    let folderHtml = topFolders.map(f => 
        `<span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:0.75em; color:${cfg.textSub};">ğŸ“‚ ${f.name} <strong style="color:#fff;">${f.count}</strong></span>`
    ).join(" ");
    htmlParts.push(`<div style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:6px;">${folderHtml}</div>`);
}

// å›¾è¡¨ (è‡ªåŠ¨å‹ç¼©é«˜åº¦é˜²æ­¢ä¸‘é™‹)
const maxLoad = Math.max(10, ...loadChart, dbStats.due);
const days = ["ä»Š", "æ˜", "+2", "+3", "+4", "+5", "+6"];
let chartHtml = `<div style="display:flex; align-items:flex-end; gap:4px; height:45px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;">`;
loadChart.forEach((val, i) => {
    let isToday = i === 0;
    let barVal = isToday ? dbStats.due : val;
    // å¼ºåˆ¶é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢ 6540 æŠŠå›¾è¡¨æ’‘çˆ†
    let h = Math.min(40, Math.max(4, (barVal / maxLoad) * 40)); 
    let color = isToday ? cfg.red : (val > 0 ? cfg.blue : cfg.barBg);
    chartHtml += `<div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:2px;">
        <div style="width:100%; height:${h}px; background:${color}; border-radius:2px; opacity:${barVal>0?0.9:0.3};"></div>
        <div style="font-size:0.6em; opacity:0.5;">${days[i]}</div>
    </div>`;
});
chartHtml += `</div>`;
htmlParts.push(chartHtml);

// å¼‚å¸¸è­¦å‘Š
if (dbStats.due > 500) {
    htmlParts.push(`<div style="font-size:0.75em; background:${cfg.orange}; color:#000; padding:8px; border-radius:6px; margin-bottom:15px;">
        ğŸ•µï¸ <strong>å¼‚å¸¸æ£€æµ‹</strong>: æ–‡ä»¶ <b>${debugFile.name}</b> å«æœ‰ ${debugFile.count} ä¸ªæ ‡ç­¾ã€‚<br>è¯·åŠ¡å¿…æ¸…ç†è¯¥æ–‡ä»¶ï¼Œå¦åˆ™å›¾è¡¨å’Œç»Ÿè®¡ä¼šä¸€ç›´å¼‚å¸¸ã€‚
    </div>`);
}

// ğŸ”˜ ä¿®å¤ç‰ˆæŒ‰é’®
htmlParts.push(`
    <button id="btn-fix-${Date.now()}" style="width:100%; background:${cfg.purple}; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.95em;">
        ${cmdLabel}
    </button>
    <div style="text-align:center; margin-top:6px; font-size:0.65em; opacity:0.4;">
        Linked to: ${targetCmd || "æ— å¯ç”¨å‘½ä»¤"}
    </div>
`);

const root = dv.el("div", "", { attr: { style: cfg.card } });
root.innerHTML = htmlParts.join("");

// âš¡ï¸ å¼ºåŠ›ç»‘å®šäº‹ä»¶
setTimeout(() => {
    // æ‰¾åˆ°åˆšæ‰ç”Ÿæˆçš„é‚£ä¸ªå¸¦æ—¶é—´æˆ³IDçš„æŒ‰é’®
    const btn = root.querySelector(`button[id^='btn-fix-']`);
    if (btn) {
        btn.onclick = (e) => {
            e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
            if (targetCmd) {
                new Notice("æ­£åœ¨å¯åŠ¨å¤ä¹ ..."); // ç»™ä½ ä¸€ä¸ªåé¦ˆ
                app.commands.executeCommandById(targetCmd);
            } else {
                new Notice("âŒ æœªæ‰¾åˆ° Spaced Repetition æ’ä»¶å‘½ä»¤ï¼");
            }
        };
    }
}, 200);
```
> > [!success] ğŸ§  çŸ¥è¯†ä¸è®°å¿† (Fusion Input)
> >```dataviewjs
> >// === æ¨¡å—: ğŸ§  è®°å¿†åº“ (Bug Fix: NaN Solved) ===
> >const cfg = {
> >    card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;",
> >    purple: "#8B5CF6", blue: "#3B82F6", green: "#10B981"
> >};
> >
> >const files = dv.pages("#flashcards AND -\"Templates\"");
> >const reviewFiles = dv.pages("#review");
> >
> >// 1. åˆå§‹åŒ–æ‰€æœ‰éœ€è¦çš„å˜é‡ï¼Œé˜²æ­¢ NaN
> >let stats = { 
> >    single: 0, 
> >    multi: 0, 
> >    cloze: 0, 
> >    total: 0 
> >};
> >
> >for (let p of files) {
> >    const content = await app.vault.read(app.vault.getAbstractFileByPath(p.file.path));
> >    
> >    // 1. å¡«ç©º (==..==)
> >    const cloze = (content.match(/==.+?==/g) || []).length;
> >    
> >    // 2. å¤šè¡Œ (? æˆ– ??)
> >    // åŒ¹é…è¡Œé¦–æˆ–æ¢è¡Œåçš„ ? æˆ– ??
> >    const multi = (content.match(/(?:^|\n)\s*(?:>\s*)?(\?|\?\?)\s*(?:\n|$)/g) || []).length;
> >    
> >    // 3. å•è¡Œ (:: æˆ– :::)
> >    // ç»Ÿè®¡æœ‰å¤šå°‘è¡ŒåŒ…å« :: (è¿™æ¶µç›–äº† :: å’Œ :::)
> >    const single = (content.match(/^.*::+.*$/gm) || []).length;
> >    
> >    stats.cloze += cloze;
> >    stats.multi += multi;
> >    stats.single += single;
> >}
> >
> >// æ±‡æ€»
> >stats.total = stats.single + stats.multi + stats.cloze;
> >
> >// é˜²æ­¢ total ä¸º 0 å¯¼è‡´é™¤æ³•å¾—åˆ° NaN
> >let pSingle = stats.total > 0 ? (stats.single/stats.total*100) : 0;
> >let pMulti = stats.total > 0 ? (stats.multi/stats.total*100) : 0;
> >let pCloze = stats.total > 0 ? (stats.cloze/stats.total*100) : 0;
> >
> >const root = dv.el("div", "", { attr: { style: cfg.card } });
> >
> >root.innerHTML = `
> ><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
> >    <div>
> >        <div style="font-weight:800; color:${cfg.purple}; font-size:1.1em;">ğŸ§  è®°å¿†åº“ (Memory Bank)</div>
> >        <div style="font-size:0.8em; opacity:0.6;">${files.length} Notes Scanned</div>
> >    </div>
> >    <div style="text-align:right;">
> >        <div style="font-size:1.5em; font-weight:800; color:#fff;">${stats.total}</div>
> >        <div style="font-size:0.7em; opacity:0.5;">Cards</div>
> >    </div>
> ></div>
> >
> ><div style="display:flex; gap:4px; height:6px; width:100%; border-radius:3px; overflow:hidden; margin-bottom:10px; opacity:0.8;">
> >    <div style="width:${pSingle}%; background:${cfg.blue};" title="å•è¡Œ"></div>
> >    <div style="width:${pMulti}%; background:${cfg.green};" title="å¤šè¡Œ"></div>
> >    <div style="width:${pCloze}%; background:${cfg.purple};" title="å¡«ç©º"></div>
> ></div>
> >
> ><div style="display:flex; justify-content:space-around; font-size:0.7em; opacity:0.6; margin-bottom:15px;">
> >    <span style="color:${cfg.blue}">â— å•è¡Œ: ${stats.single}</span>
> >    <span style="color:${cfg.green}">â— å¤šè¡Œ: ${stats.multi}</span>
> >    <span style="color:${cfg.purple}">â— å¡«ç©º: ${stats.cloze}</span>
> ></div>
> >
> ><div style="background:rgba(139, 92, 246, 0.15); border:1px solid ${cfg.purple}; border-radius:8px; padding:10px; text-align:center; cursor:pointer;" onclick="app.commands.executeCommandById('obsidian-spaced-repetition:review-flashcards')">
> >    <div style="font-weight:bold; margin-bottom:2px;">âš¡ï¸ å¼€å§‹å¤ä¹ </div>
> >    <div style="font-size:0.8em; opacity:0.7;">å¾…å¤ä¹ ç¬”è®°: <b>${reviewFiles.length}</b></div>
> ></div>
> >`;
> >```


```dataviewjs
// === ğŸ¦ PA Engine v5.0: æ•°æ®ä¸­å° ===
const trades = dv.pages("#PA/Trade")
    .where(p => !p.file.path.includes("Templates"))
    .array();

// ç»Ÿä¸€æ¸…æ´—ä¸åŠ¨æ€è®¡ç®—
const processedTrades = trades.map(t => {
    const entry = t.entry_price || 0;
    const stop = t.stop_loss || 0;
    const exit = t.exit_price || entry; 
    const pnl = t.net_profit || 0;
    
    // åŠ¨æ€è®¡ç®— R å€¼ï¼š(ç¦»åœº - å…¥åœº) / |å…¥åœº - æ­¢æŸ|
    const riskPoints = Math.abs(entry - stop);
    const dynamicR = riskPoints > 0 ? (exit - entry) / riskPoints : 0;

    return {
        ...t,
        name: t.file.name,
        link: t.file.link,
        date: moment(t.date || t.file.day).format("YYYY-MM-DD"),
        pnl: pnl,
        r: dynamicR,
        setup: (t.setup_category || "Unknown").toString().split("(")[0].trim(),
        account: (t["è´¦æˆ·ç±»å‹/account_type"] || "Demo").toString(),
        cycle: (t["å¸‚åœºå‘¨æœŸ/market_cycle"] || "Unknown").toString()
    };
});

// æŒ‚è½½åˆ°å…¨å±€ window å¯¹è±¡ä¾›åç»­æ¨¡å—è°ƒç”¨
window.paData = {
    trades: processedTrades,
    lastUpdated: moment().format("HH:mm:ss")
};

dv.el("div", `æ•°æ®å¼•æ“å·²å°±ç»ª | æ›´æ–°æ—¶é—´: ${window.paData.lastUpdated}`, { 
    attr: { style: "font-size:0.7em; opacity:0.3; text-align:right; margin-bottom:10px;" } 
});
```
```dataviewjs
// === æ¨¡å—: ğŸ“… å‘¨æœŸå¯¹æ¯”çœ‹æ¿ (Insights) ===
const trades = window.paData.trades;
const cfg = { green: "#10B981", red: "#EF4444", blue: "#3B82F6" };

const getStats = (list) => {
    const pnl = list.reduce((s, x) => s + x.pnl, 0);
    const wins = list.filter(x => x.pnl > 0).length;
    const wr = list.length > 0 ? (wins / list.length * 100).toFixed(1) : 0;
    const avgR = list.length > 0 ? (list.reduce((s, x) => s + x.r, 0) / list.length).toFixed(2) : 0;
    return { pnl, wr, avgR, count: list.length };
};

const tw = getStats(trades.filter(t => moment(t.date).isSame(moment(), 'week')));
const lw = getStats(trades.filter(t => moment(t.date).isSame(moment().subtract(1, 'week'), 'week')));
const tm = getStats(trades.filter(t => moment(t.date).isSame(moment(), 'month')));

const renderRow = (label, data, isHeader = false) => {
    const color = data.pnl >= 0 ? cfg.green : cfg.red;
    return `
    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
        <td style="padding:10px; opacity:0.7;">${label}</td>
        <td style="padding:10px; color:${color}; font-weight:bold;">$${data.pnl}</td>
        <td style="padding:10px;">${data.wr}%</td>
        <td style="padding:10px; color:${cfg.blue}">${data.avgR}R</td>
        <td style="padding:10px; opacity:0.5;">${data.count} æ¬¡</td>
    </tr>`;
};

const html = `
<div style="background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;">
    <div style="font-weight:700; opacity:0.7; margin-bottom:12px;">ğŸ“… å‘¨æœŸè¡¨ç°å¯¹æ¯” (Cycle Comparison)</div>
    <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.9em;">
        <thead>
            <tr style="opacity:0.4; font-size:0.8em; border-bottom:1px solid rgba(255,255,255,0.1);">
                <th style="padding:5px 10px;">å‘¨æœŸ</th><th style="padding:5px 10px;">ç›ˆäº</th>
                <th style="padding:5px 10px;">èƒœç‡</th><th style="padding:5px 10px;">å¹³å‡R</th>
                <th style="padding:5px 10px;">æ•°é‡</th>
            </tr>
        </thead>
        <tbody>
            ${renderRow("æœ¬å‘¨ (This Week)", tw)}
            ${renderRow("ä¸Šå‘¨ (Last Week)", lw)}
            ${renderRow("æœ¬æœˆ (This Month)", tm)}
        </tbody>
    </table>
</div>`;

dv.el("div", html);
```
```dataviewjs
// === æ¨¡å—: ğŸ’¸ é”™è¯¯çš„ä»£ä»· v5.0 ===
const trades = window.paData.trades.filter(t => t.account.includes("Live"));
let errorStats = {};
let totalTuition = 0;

for (let t of trades) {
    let rawErr = t["ç®¡ç†é”™è¯¯/management_error"];
    if (!rawErr || rawErr.includes("None") || t.pnl >= 0) continue;
    
    let errKey = rawErr.toString().split("(")[1] ? rawErr.toString().split("(")[1].replace(")","") : rawErr.toString();
    errorStats[errKey] = (errorStats[errKey] || 0) + Math.abs(t.pnl);
    totalTuition += Math.abs(t.pnl);
}

const sortedErrors = Object.keys(errorStats).map(k => ({ name: k, cost: errorStats[k] })).sort((a,b) => b.cost - a.cost);

let html = `
<div style="background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;">
    <div style="font-weight:700; opacity:0.7; margin-bottom:12px;">ğŸ’¸ è¿è§„æˆæœ¬ (Live Tuition)</div>
    <div style="font-size:1.1em; margin-bottom:15px;">æ€»æŸå¤±: <span style="color:#EF4444; font-weight:800;">-$${totalTuition}</span></div>
    ${sortedErrors.map(e => `
        <div style="display:flex; align-items:center; margin-bottom:8px; font-size:0.85em;">
            <div style="width:80px; opacity:0.6;">${e.name}</div>
            <div style="flex:1; background:rgba(255,255,255,0.05); height:6px; border-radius:3px; margin:0 10px;">
                <div style="width:${Math.round(e.cost/totalTuition*100)}%; height:100%; background:#EF4444;"></div>
            </div>
            <div style="width:60px; text-align:right;">$${e.cost}</div>
        </div>
    `).join("")}
</div>`;

dv.el("div", html);
```
```dataviewjs
// === æ¨¡å—: ğŸ–¼ï¸ å¿«é€Ÿç”»å»Š v5.0 ===
const trades = window.paData.trades.slice(-4).reverse();
const cfg = { green: "#10B981", blue: "#3B82F6", orange: "#F59E0B" };

let imgs = trades.map(n => {
    let rawCover = n["å°é¢/cover"];
    let src = "";
    if (rawCover && rawCover.path) src = app.vault.adapter.getResourcePath(rawCover.path);
    if (!src) return "";

    let badgeColor = n.account.includes("Live") ? cfg.green : cfg.blue;
    return `
    <div style="position:relative; aspect-ratio:16/9; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.1);">
        <img src="${src}" style="width:100%; height:100%; object-fit:cover;">
        <div style="position:absolute; top:5px; right:5px; background:${badgeColor}; color:black; font-size:0.6em; font-weight:800; padding:2px 6px; border-radius:4px;">${n.account.toUpperCase()}</div>
        <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:10px 8px; display:flex; justify-content:space-between; align-items:flex-end;">
            <span style="font-size:0.75em; font-weight:bold;">${n.name}</span>
            <span style="color:${n.pnl>=0?cfg.green:'#EF4444'}; font-weight:800;">${n.r.toFixed(1)}R</span>
        </div>
    </div>`;
}).join("");

dv.el("div", `
<div style="background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;">
    <div style="font-weight:700; opacity:0.7; margin-bottom:12px;">ğŸ–¼ï¸ æœ€æ–°å¤ç›˜ (Quick View)</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">${imgs}</div>
</div>`);
```

---



```dataviewjs
// === ğŸ¦ PA Engine v5.0: æ•°æ®ä¸­å° (é«˜æ€§èƒ½æ ¸å¿ƒ) ===
const trades = dv.pages("#PA/Trade")
    .where(p => !p.file.path.includes("Templates"))
    .array();

// 1. åŠ¨æ€ R å€¼ä¸ PnL æ•°æ®æ¸…æ´—
const processedTrades = trades.map(t => {
    const entry = t.entry_price || 0;
    const stop = t.stop_loss || 0;
    const exit = t.exit_price || entry; 
    const pnl = t.net_profit || 0;
    
    // è‡ªåŠ¨è®¡ç®— R å€¼: (ç¦»åœº - å…¥åœº) / |å…¥åœº - æ­¢æŸ|
    const riskPoints = Math.abs(entry - stop);
    const dynamicR = riskPoints > 0 ? (exit - entry) / riskPoints : 0;

    return {
        ...t,
        name: t.file.name,
        link: t.file.link,
        date: moment(t.date || t.file.day).format("YYYY-MM-DD"),
        pnl: pnl,
        r: dynamicR,
        setup: (t.setup_category || "Unknown").toString().split("(")[0].trim(),
        account: (t["è´¦æˆ·ç±»å‹/account_type"] || "Demo").toString(),
        cycle: (t["å¸‚åœºå‘¨æœŸ/market_cycle"] || "Unknown").toString(),
        error: (t["ç®¡ç†é”™è¯¯/management_error"] || "None").toString()
    };
});

// 2. æŒ‚è½½å…¨å±€æ•°æ®ï¼Œåç»­æ¨¡å—æ— éœ€é‡å¤æ‰«æå…¨åº“
window.paData = {
    trades: processedTrades,
    lastUpdated: moment().format("HH:mm:ss")
};

dv.el("div", `âš¡ï¸ å¼•æ“å·²å°±ç»ª | æ›´æ–°æ—¶é—´: ${window.paData.lastUpdated}`, { 
    attr: { style: "font-size:0.7em; opacity:0.3; text-align:right; margin-bottom:10px;" } 
});
```
```dataviewjs
// === æ¨¡å—: ğŸ§  è®°å¿†åº“ä¸è¯¾ç¨‹åœ°å›¾ (æ•´åˆç‰ˆ) ===
const cfg = { card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;", purple: "#8B5CF6", blue: "#3B82F6", green: "#10B981", red: "#EF4444" };

// æ­¤å¤„ä¿æŒä½ åŸæœ‰çš„ DataviewJS é€»è¾‘ï¼Œä½†å°†ç»Ÿè®¡éƒ¨åˆ†æ”¹ä¸ºè¯»å–å·²åŠ è½½çš„æ•°æ®
const html = `
<div style="${cfg.card}">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
            <div style="font-weight:800; color:${cfg.purple}; font-size:1.1em;">ğŸ§  çŸ¥è¯†ä¸è®°å¿† (Fusion Input)</div>
            <div style="font-size:0.8em; opacity:0.6; margin-top:4px;">ç³»ç»Ÿå·²åŒæ­¥æœ€æ–°å­¦ä¹ è¿›åº¦</div>
        </div>
    </div>
    </div>`;

dv.el("div", html);
```
```dataviewjs
// === æ¨¡å—: ğŸ“Š è´¦æˆ·å…¨æ™¯ & å‘¨æœŸå¯¹æ¯”çœ‹æ¿ (Insights) ===
const trades = window.paData.trades;
const cfg = { green: "#10B981", red: "#EF4444", blue: "#3B82F6", card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;" };

// å‘¨æœŸç»Ÿè®¡é€»è¾‘
const getStats = (list) => {
    const pnl = list.reduce((s, x) => s + x.pnl, 0);
    const wins = list.filter(x => x.pnl > 0).length;
    const wr = list.length > 0 ? (wins / list.length * 100).toFixed(1) : 0;
    const avgR = list.length > 0 ? (list.reduce((s, x) => s + x.r, 0) / list.length).toFixed(2) : 0;
    return { pnl, wr, avgR, count: list.length };
};

const tw = getStats(trades.filter(t => moment(t.date).isSame(moment(), 'week')));
const lw = getStats(trades.filter(t => moment(t.date).isSame(moment().subtract(1, 'week'), 'week')));
const tm = getStats(trades.filter(t => moment(t.date).isSame(moment(), 'month')));

const html = `
<div style="${cfg.card}">
    <div style="font-weight:700; opacity:0.7; margin-bottom:12px; color:${cfg.blue}">ğŸ“Š ç»¼åˆè¡¨ç°å¯¹æ¯” (Performance Matrix)</div>
    <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.9em;">
        <tr style="opacity:0.4; font-size:0.8em; border-bottom:1px solid rgba(255,255,255,0.1);">
            <th style="padding:8px;">å‘¨æœŸ</th><th style="padding:8px;">ç›ˆäº</th><th style="padding:8px;">èƒœç‡</th><th style="padding:8px;">å¹³å‡R</th><th style="padding:8px;">æ•°é‡</th>
        </tr>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:10px;">æœ¬å‘¨ (Weekly)</td>
            <td style="padding:10px; color:${tw.pnl>=0?cfg.green:cfg.red}; font-weight:bold;">$${tw.pnl}</td>
            <td style="padding:10px;">${tw.wr}%</td>
            <td style="padding:10px; color:${cfg.blue}">${tw.avgR}R</td>
            <td style="padding:10px; opacity:0.5;">${tw.count} æ¬¡</td>
        </tr>
        <tr>
            <td style="padding:10px;">æœ¬æœˆ (Monthly)</td>
            <td style="padding:10px; color:${tm.pnl>=0?cfg.green:cfg.red}; font-weight:bold; font-size:1.1em;">$${tm.pnl}</td>
            <td style="padding:10px;">${tm.wr}%</td>
            <td style="padding:10px; color:${cfg.blue}">${tm.avgR}R</td>
            <td style="padding:10px; opacity:0.5;">${tm.count} æ¬¡</td>
        </tr>
    </table>
</div>`;

dv.el("div", html);
```
```dataviewjs
// === æ¨¡å—: ğŸ›¡ï¸ å®ç›˜å¿ƒæ€ä¸è¿è§„ä»£ä»· (Live Mindset) ===
const trades = window.paData.trades.filter(t => t.account.includes("Live"));
const cfg = { red: "#EF4444", green: "#10B981", card: "background:rgba(35,35,35,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; margin-bottom:20px;" };

let errorStats = {};
let totalTuition = 0;

trades.forEach(t => {
    if (t.error && !t.error.includes("None") && t.pnl < 0) {
        let errKey = t.error.split("(")[1] ? t.error.split("(")[1].replace(")","") : t.error;
        errorStats[errKey] = (errorStats[errKey] || 0) + Math.abs(t.pnl);
        totalTuition += Math.abs(t.pnl);
    }
});

const sortedErrors = Object.keys(errorStats).sort((a,b) => errorStats[b] - errorStats[a]);

let html = `
<div style="${cfg.card}">
    <div style="font-weight:700; opacity:0.7; margin-bottom:12px;">ğŸ’¸ è¿è§„å­¦è´¹ç»Ÿè®¡ (Tuition Fee)</div>
    <div style="font-size:1.2em; margin-bottom:15px; font-weight:800; color:${cfg.red}">-$${totalTuition}</div>
    ${sortedErrors.map(e => `
        <div style="display:flex; align-items:center; margin-bottom:8px; font-size:0.85em;">
            <div style="width:100px; opacity:0.6;">${e}</div>
            <div style="flex:1; background:rgba(255,255,255,0.05); height:6px; border-radius:3px; margin:0 10px;">
                <div style="width:${Math.round(errorStats[e]/totalTuition*100)}%; height:100%; background:${cfg.red};"></div>
            </div>
            <div style="width:60px; text-align:right; font-weight:bold;">$${errorStats[e]}</div>
        </div>
    `).join("")}
</div>`;

dv.el("div", html);
```
