# Implementation Log: Task 18

**Summary:** 实现 Manager（高风险写入治理，默认关闭写入）：在 Dashboard 内提供 Plan 预览 → 二次确认 → 批量写入流程，支持接收 Inspector 的 FixPlan，并覆盖交易笔记批量归一与策略卡片维护两类动作；提供按文件失败隔离与“Undo Last Apply”回滚（内存备份）。

**Timestamp:** 2026-01-02T05:45:00.000Z
**Log ID:** 6b9a6c1d-64d7-4b6b-9f4f-0fb4e0d3ad0d

---

## Statistics

- **Lines Added:** +0
- **Lines Removed:** -0
- **Files Changed:** 5
- **Net Change:** 0

## Files Modified
- .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx
- .obsidian/plugins/al-brooks-console/src/core/inspector.ts
- .obsidian/plugins/al-brooks-console/src/core/field-mapper.ts
- .spec-workflow/specs/al-brooks-console/tasks.md

## Files Created
- .obsidian/plugins/al-brooks-console/src/core/manager.ts

---

## Artifacts

### Components

#### ConsoleComponent（Dashboard）Manager 分区
- **Type:** React
- **Purpose:** 统一承载“预览→确认→写入”的批量治理入口：
  - 生成计划：Use Inspector FixPlan / Generate Trade Plan / Generate Strategy Plan
  - 预览：JSON 文本预览
  - 安全写入：需勾选确认后才能 Apply
  - 回滚：Undo Last Apply（写入前备份的内容在内存中保存）
  - 失败隔离：逐文件 try/catch，汇总 applied/failed/errors
- **Location:** .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx
- **Props:** 新增
  - `loadStrategyNotes?: () => Promise<StrategyNoteFrontmatter[]>`
  - `applyFixPlan?: (plan: FixPlan, options?: { deleteKeys?: boolean }) => Promise<ManagerApplyResult>`
  - `restoreFiles?: (backups: Record<string, string>) => Promise<ManagerApplyResult>`
- **Exports:** VIEW_TYPE_CONSOLE, ConsoleView

### Functions

#### buildTradeNormalizationPlan
- **Purpose:** 交易笔记批量归一的 FixPlan 生成：
  - 别名字段 → 模板双语 canonical key（如 账户类型/account_type、品种/ticker、净利润/net_profit、结果/outcome）
  - 数值字段 parse（净利润/net_profit 尝试转 number）
  - 枚举值同义归一（如 account_type/ticker/outcome，依赖 EnumPresets）
  - 可选生成 deleteKeys（仅供 Manager 在显式开启“Delete legacy keys”时应用）
- **Location:** .obsidian/plugins/al-brooks-console/src/core/manager.ts
- **Signature:** (trades: TradeRecord[], presets?: EnumPresets, options?: { includeDeleteKeys?: boolean }) => FixPlan
- **Exported:** Yes

#### buildStrategyMaintenancePlan
- **Purpose:** 策略卡片维护 FixPlan 生成（作用域：策略仓库范围内且 tag 为 PA/Strategy）：
  - 缺省字段补齐（最小默认）
  - 多选枚举值同义归一（依赖 EnumPresets）
- **Location:** .obsidian/plugins/al-brooks-console/src/core/manager.ts
- **Signature:** (notes: StrategyNoteFrontmatter[], presets?: EnumPresets, options?: { includeDeleteKeys?: boolean }) => FixPlan
- **Exported:** Yes

#### applyFixPlan / restoreFiles / loadStrategyNotes（ConsoleView 注入）
- **Purpose:** 使用 Obsidian `vault.read/modify` 执行计划（按文件失败隔离），并返回可用于回滚的 backups；策略扫描使用 `metadataCache`（必要时读取文件并 parseYaml）获取 frontmatter。
- **Location:** .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx
- **Exported:** N/A（通过 props 注入）

### SSOT Updates

#### FIELD_ALIASES.accountType
- **Purpose:** 与 vault 模板一致，补齐 `账户类型/account_type` 与 `账户类型` 作为别名覆盖，提升字段归一与治理计划质量。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/field-mapper.ts

### Data Flow / Safety

- **Data Flow:** Inspector FixPlan / Manager-generated plan → ConsoleView.applyFixPlan → vault.modify（逐文件） → ManagerResult 汇总 + backups 支持 undo
- **Safety Defaults:**
  - 默认不写入：必须勾选 “I understand this will write to notes” 才能 Apply
  - 默认不删字段：deleteKeys 只有在显式开启 “Delete legacy keys” 时才会执行
  - 回滚：Undo Last Apply 使用执行前 backups 还原
