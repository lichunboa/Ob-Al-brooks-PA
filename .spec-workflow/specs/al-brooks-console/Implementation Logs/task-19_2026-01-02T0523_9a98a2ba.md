# Implementation Log: Task 19

**Summary:** 实现学习闭环模块（Course + Memory/SRS）与可即时生效的插件设置：新增 Course/Memory 纯计算模块与 Dashboard UI 分区；SRS 复习动作继续通过 Adapter 可降级；设置变更通过订阅通知即时刷新。

**Timestamp:** 2026-01-02T05:23:42.168Z
**Log ID:** 9a98a2ba-4135-45cc-b042-3b3bd0ba27ed

---

## Statistics

- **Lines Added:** +847
- **Lines Removed:** -3
- **Files Changed:** 7
- **Net Change:** 844

## Files Modified
- .obsidian/plugins/al-brooks-console/src/main.ts
- .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx
- .spec-workflow/specs/al-brooks-console/tasks.md

## Files Created
- .obsidian/plugins/al-brooks-console/src/settings.ts
- .obsidian/plugins/al-brooks-console/src/settings-tab.ts
- .obsidian/plugins/al-brooks-console/src/core/course.ts
- .obsidian/plugins/al-brooks-console/src/core/memory.ts

---

## Artifacts

### Components

#### ConsoleComponent (Course/Memory sections)
- **Type:** React
- **Purpose:** 在 Manager 之后新增 Course 与 Memory/SRS 分区：Course 展示 hybridRec + Up Next + 可展开矩阵；Memory 展示指标、focusFile、随机抽题与 SRS Review（adapter 可降级）。
- **Location:** .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx:1000
- **Props:** Props 包含 settings/subscribeSettings/loadCourse/loadMemory/openFile 等注入项（由 ConsoleView 提供）。
- **Exports:** ConsoleComponent (internal)

### Functions

#### simpleCourseId
- **Purpose:** 对齐 legacy 课程 id 归一：去掉末尾章节字母（如 L01A→L01）。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/course.ts:40
- **Signature:** (id: string) => string
- **Exported:** Yes

#### parseSyllabusJsonFromMarkdown
- **Purpose:** 按 legacy 口径解析 PA_Syllabus_Data.md：优先 ```json，其次任意 ```，兜底扫描 JSON 数组。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/course.ts:44
- **Signature:** (mdText: string) => SyllabusItem[]
- **Exported:** Yes

#### buildCourseSnapshot
- **Purpose:** 由 syllabus + doneIds + linksById 生成 Course 快照：进度、phase 矩阵、hybridRec（继续学习/建议复习）与 upNext（受推荐窗口控制）。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/course.ts:92
- **Signature:** (args: { syllabus: SyllabusItem[]; doneIds: Iterable<string>; linksById: Record<string, CourseLink>; courseRecommendationWindow: number; random?: () => number }) => CourseSnapshot
- **Exported:** Yes

#### buildMemorySnapshot
- **Purpose:** 只读扫描 #flashcards 结果生成 Memory/SRS 快照：Total/Due/Mastery/Load(7d)、focusFile、随机抽题 quizPool；Due 支持阈值天数。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/memory.ts:36
- **Signature:** (args: { files: { path: string; name: string; folder: string; content: string }[]; today: Date; dueThresholdDays: number; randomQuizCount: number }) => MemorySnapshot
- **Exported:** Yes

#### onSettingsChanged
- **Purpose:** 插件 settings 订阅：Dashboard 可监听设置变化并即时重新加载 Course/Memory。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:18
- **Signature:** (listener: (settings: AlBrooksConsoleSettings) => void) => () => void
- **Exported:** Yes

#### loadSettings / saveSettings
- **Purpose:** settings 持久化与变更通知：save 后调用 notifySettingsChanged，实现“设置立即生效”。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:33
- **Signature:** loadSettings(): Promise<void>; saveSettings(): Promise<void>
- **Exported:** No

#### ConsoleView.loadCourse
- **Purpose:** 从 vault 读取 PA_Syllabus_Data.md + 扫描 #PA/Course 笔记（module_id/studied），构造 links/doneIds 并生成 CourseSnapshot。
- **Location:** .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx:1947
- **Signature:** (settings: AlBrooksConsoleSettings) => Promise<CourseSnapshot>
- **Exported:** No

#### ConsoleView.loadMemory
- **Purpose:** 从 vault 只读扫描非 Templates 下含 #flashcards 的笔记文本，分批让出事件循环后生成 MemorySnapshot。
- **Location:** .obsidian/plugins/al-brooks-console/src/views/Dashboard.tsx:1991
- **Signature:** (settings: AlBrooksConsoleSettings) => Promise<MemorySnapshot>
- **Exported:** No

### Classes

#### AlBrooksConsoleSettingTab
- **Purpose:** Obsidian 设置页：提供 Course 推荐窗口、Memory Due 阈值、随机抽题数量三项参数；保存后立即触发插件内 settings 变更通知。
- **Location:** .obsidian/plugins/al-brooks-console/src/settings-tab.ts:10
- **Methods:** display
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** Dashboard 在挂载时加载 Course/Memory，并订阅 settings 变更后自动重新加载；SRS Review 行为仍走 SrsAdapter capability，缺失则降级但统计仍可用。
- **Frontend Component:** ConsoleComponent
- **Backend Endpoint:** N/A (Obsidian in-process)
- **Data Flow:** ConsoleView 注入 loadCourse/loadMemory + settings getter/subscribe → ConsoleComponent useEffect 初次加载 → 设置变化触发订阅回调 → 重置 settingsKey 并重新 reloadCourse/reloadMemory；Review 按钮点击 → integrations.action('srs:review-flashcards')（可用则执行，不可用则按钮禁用 + 降级提示）

