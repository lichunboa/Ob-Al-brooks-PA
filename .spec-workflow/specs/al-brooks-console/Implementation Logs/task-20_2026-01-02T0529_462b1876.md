# Implementation Log: Task 20

**Summary:** 新增导出与回归能力：通过命令“Export Index Snapshot (JSON)”将当前 TradeIndex 的归一化 trades、按账户口径 stats，以及（如可用）strategyIndex 列表导出为稳定 JSON，并写入 vault 的 Exports/al-brooks-console/ 目录下的新文件。

**Timestamp:** 2026-01-02T05:29:16.099Z
**Log ID:** 462b1876-5e87-47bd-85ad-7dfbc281419f

---

## Statistics

- **Lines Added:** +135
- **Lines Removed:** -2
- **Files Changed:** 3
- **Net Change:** 133

## Files Modified
- .obsidian/plugins/al-brooks-console/src/main.ts
- .spec-workflow/specs/al-brooks-console/tasks.md

## Files Created
- .obsidian/plugins/al-brooks-console/src/core/export-snapshot.ts

---

## Artifacts

### Functions

#### buildConsoleExportSnapshot
- **Purpose:** 构建稳定的导出 JSON schema（meta + trades + statsByAccountType + 可选 strategyIndex）。
- **Location:** .obsidian/plugins/al-brooks-console/src/core/export-snapshot.ts:24
- **Signature:** (args: { exportedAt: string; pluginVersion: string; trades: TradeRecord[]; statsByAccountType: StatsByAccountType; strategyCards?: StrategyCard[] }) => ConsoleExportSnapshot
- **Exported:** Yes

#### exportIndexSnapshot
- **Purpose:** 导出动作入口：收集 index.getAll() trades、用 SSOT 计算 stats、读取 strategyIndex.list()，序列化并写入新 JSON 文件，最后 Notice 提示路径。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:100
- **Signature:** () => Promise<void>
- **Exported:** No

#### ensureFolder
- **Purpose:** 确保导出目录存在（逐级 createFolder；并发创建时容错）。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:128
- **Signature:** (path: string) => Promise<void>
- **Exported:** No

#### pickAvailablePath
- **Purpose:** 避免覆盖：如果目标文件已存在则自动追加 _2.._9999 后缀。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:149
- **Signature:** (basePath: string) => Promise<string>
- **Exported:** No

#### toFileTimestamp
- **Purpose:** 生成文件名时间戳（YYYYMMDD_HHMMSS）。
- **Location:** .obsidian/plugins/al-brooks-console/src/main.ts:163
- **Signature:** (d: Date) => string
- **Exported:** No

### Integrations

#### Integration
- **Description:** 导出快照复用 SSOT：TradeIndex.getAll() 提供 trades，Stats SSOT computeTradeStatsByAccountType 计算 stats；StrategyIndex（若已实现）通过 strategyIndex.list() 提供策略卡片列表。
- **Frontend Component:** Obsidian command palette (Plugin command)
- **Backend Endpoint:** N/A (Obsidian in-process)
- **Data Flow:** 用户触发命令 → exportIndexSnapshot() → 收集 trades/strategies → 计算 statsByAccountType → buildConsoleExportSnapshot() → vault.create 写入 Exports/al-brooks-console/snapshot_*.json → Notice 提示导出路径

