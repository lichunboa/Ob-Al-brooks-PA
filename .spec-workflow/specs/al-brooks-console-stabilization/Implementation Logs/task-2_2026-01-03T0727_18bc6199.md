# Implementation Log: Task 2

**Summary:** 将 TradeRecord.dateIso 的生成从 basename 截断改为稳定归一化：优先 frontmatter date，其次解析文件名（YYYY-MM-DD / YYYYMMDD / YYMMDD），否则回退到 ctime/mtime，确保始终输出合法 YYYY-MM-DD。

**Timestamp:** 2026-01-03T07:27:00.583Z
**Log ID:** 18bc6199-ffa9-4803-b9ed-4b1c824f0620

---

## Statistics

- **Lines Added:** +96
- **Lines Removed:** -6
- **Files Changed:** 2
- **Net Change:** 90

## Files Modified
- .obsidian/plugins/al-brooks-console/src/platforms/obsidian/obsidian-trade-index.ts
- .spec-workflow/specs/al-brooks-console-stabilization/tasks.md

## Files Created
_No files created_

---

## Artifacts

### Functions

#### ObsidianTradeIndex.normalizeDateIso
- **Purpose:** 从 frontmatter date / 文件名日期 / ctime/mtime 生成稳定的 dateIso(YYYY-MM-DD)，保证输出合法且可排序聚合。
- **Location:** .obsidian/plugins/al-brooks-console/src/platforms/obsidian/obsidian-trade-index.ts:139
- **Signature:** (dateRaw: unknown, file: TFile) => string
- **Exported:** No

#### ObsidianTradeIndex.parseDateIsoFromBasename
- **Purpose:** 从文件名解析日期，支持 YYYY-MM-DD*、YYYYMMDD*、YYMMDD* 三种常见前缀。
- **Location:** .obsidian/plugins/al-brooks-console/src/platforms/obsidian/obsidian-trade-index.ts:113
- **Signature:** (basename: string) => string | null
- **Exported:** No

#### ObsidianTradeIndex.isValidDateIso
- **Purpose:** 校验 dateIso 格式与真实日期合法性（避免 2025-02-30 等无效日期进入索引）。
- **Location:** .obsidian/plugins/al-brooks-console/src/platforms/obsidian/obsidian-trade-index.ts:93
- **Signature:** (iso: string) => boolean
- **Exported:** No

#### ObsidianTradeIndex.toLocalDateIso
- **Purpose:** 把 Date 转为本地 YYYY-MM-DD，用于 ctime/mtime fallback 与可预测的“今日”对齐。
- **Location:** .obsidian/plugins/al-brooks-console/src/platforms/obsidian/obsidian-trade-index.ts:82
- **Signature:** (d: Date) => string
- **Exported:** No

### Integrations

#### Integration
- **Description:** TradeIndex 在 indexFile() 中统一使用 normalizeDateIso 生成 TradeRecord.dateIso，确保 Today/Analytics/排序等消费者不需要在 UI 层做兜底。
- **Frontend Component:** ConsoleView/useDashboardData (消费 dateIso)
- **Backend Endpoint:** (n/a)
- **Data Flow:** vault 扫描/事件触发 → ObsidianTradeIndex.indexFile() → normalizeDateIso(dateRaw, file) → 写入 TradeRecord.dateIso → emitChanged → UI 过滤 todayIso/聚合 analytics

