{
  "id": "snapshot_1767317835156_uywcfnjic",
  "approvalId": "approval_1767317730706_5tungzwpz",
  "approvalTitle": "Approve design for al-brooks-console",
  "version": 2,
  "timestamp": "2026-01-02T01:37:15.156Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design — al-brooks-console\n\n## 0. Design Principles\n- **对照优先**：MVP 以 Dataview 版为基准，先实现“同样的可见结果”，再重构更聪明的逻辑。\n- **只读安全**：MVP 阶段只读取与解析，不自动改写用户笔记。\n- **增量索引**：用 Obsidian 原生事件驱动增量更新，避免频繁全量扫描。\n\n## 1. High-Level Architecture\n\n### 1.1 Modules\n- `ConsolePlugin`（主插件）\n- `DashboardView`（ItemView + React Root）\n- `TradeIndex`（发现/解析/缓存/聚合/事件）\n- `FieldMapper`（双语字段映射、类型安全解析）\n\n### 1.2 Data Flow\n1) `TradeIndex.buildInitialIndex()` 扫描 vault → 生成 `TradeRecord[]` 与聚合 `TradeStats`。\n2) `TradeIndex` 发出 `changed` 事件。\n3) `DashboardView` 订阅事件并刷新 React state。\n4) vault 发生事件（modify/rename/delete）→ `TradeIndex.handleEvent()` → 仅更新受影响文件 → 再次 emit。\n\n## 2. Trade Note Discovery (识别策略)\nMVP：\n- 主要规则：带 `#PA/Trade` tag。\n- 读取来源：优先用 `metadataCache.getFileCache(file)` 的 tags/frontmatter。\n- 初始扫描：遍历 vault 的 Markdown 文件（可先按路径粗过滤以提速）。\n\n增量更新：\n- `app.vault.on('modify')`：重新解析该文件。\n- `app.vault.on('rename')`：更新 key（旧 path → 新 path），必要时重新解析。\n- `app.vault.on('delete')`：从索引移除。\n- `app.metadataCache.on('changed')`：用于捕捉 frontmatter/tag 变化（与 modify 互补）。\n\n## 3. Data Model\n\n### 3.1 Canonical TradeRecord\n建议最小字段：\n- `path: string`（主键）\n- `name: string`\n- `dateIso: string`（YYYY-MM-DD）\n- `ticker?: string`\n- `pnl?: number`（净利润）\n- `outcome?: 'win'|'loss'|'scratch'|'unknown'`（可选，作为兜底或展示）\n- `mtime?: number`\n\n### 3.2 TradeStats\n- `countTotal`\n- `countCompleted`（可定义：有 pnl 或 outcome）\n- `countWins`\n- `winRatePct`\n- `netProfit`\n\n## 4. Field Mapping & Parsing\n\n### 4.1 FieldMapper\n- 维护一个 mapping 表：canonical → 候选字段名数组。\n- MVP 必须支持：\n  - `pnl` ← [`净利润/net_profit`, `net_profit`]\n  - `ticker` ← [`品种/ticker`, `ticker`]\n\n### 4.2 类型解析\n- `pnl`：允许 number / string（如 \"100\"）→ parseFloat；失败则 undefined。\n- `dateIso`：优先 frontmatter `date`；否则从文件名/创建时间推断（MVP 可用 mtime/ctime 兜底）。\n\n## 5. Win Rate Canonicalization\n统一口径：\n- 若 `pnl` 可用：\n  - pnl > 0 → win\n  - pnl < 0 → loss\n  - pnl === 0 → scratch（计入 completed 但不计 win；或按配置）\n- 若 `pnl` 不可用：根据 outcome 字符串映射（Win/Loss/Scratch/止盈/止损/保本）。\n\n说明：该设计显式修复现状 core 中“stats 与 coachFocus 口径不一致”的问题。\n\n## 6. UI Design (MVP)\n\n### 6.1 Dashboard Layout\n- 顶部：三张统计卡片（交易次数 / 胜率 / 净利润）\n- 下方：交易列表（最近 N 笔，可配置，默认 50）\n\n### 6.2 Interactions\n- 点击列表项：打开对应文件（使用 Obsidian API 打开 leaf）。\n\n## 7. Performance & Debounce\n- 初始扫描可能耗时：\n  - 允许显示 loading 状态。\n  - 增量更新采用 debounce（例如 300~800ms），批处理多个快速 modify。\n\n## 8. Compatibility / Migration Strategy\n- MVP 期间不删除旧版 Dataview 控制台。\n- 迁移对照：可用同一组样本 trade notes 对比：\n  - 总交易数\n  - 净利润\n  - 胜率（按 pnl 口径）\n\n## 9. Testing Strategy (轻量)\n- 单元测试（可选）：FieldMapper 解析 pnl/ticker；winrate 计算。\n- 手工验收脚本：\n  - 修改任意 trade note 的 pnl，观察仪表盘更新。\n  - 重命名 trade note，观察链接与计数保持一致。\n",
  "fileStats": {
    "size": 3771,
    "lines": 101,
    "lastModified": "2026-01-01T22:35:40.630Z"
  },
  "comments": []
}