# 数据管道详细文档

> 生成时间: 2025-11-30
> 覆盖模块: AI层 + DATA层

## 一、数据管道总览

```
┌────────────────────────────────────────────────────────────────┐
│                    核心数据管道                                 │
└────────────────────┬───────────────────────────────────────────┘
                      │
              ┌───────┴────────┐
              │                │
              ▼                ▼
   ┌─────────────────┐ ┌───────────────┐
   │  数据采集管道    │ │  分析计算管道  │
   │  (Data Layer)  │ │   (AI Layer)   │
   └───────┬─────────┘ └───────┬───────┘
           │                   │
           └──────────┬────────┘
                      ▼
           ┌──────────────────┐
           │  结果输出管道    │
           │ (Images/Reports) │
           └────────┬─────────┘
                    ▼
           ┌──────────────────┐
           │  Telegram发送    │
           └──────────────────┘
```

---

## 二、数据采集管道

### 2.1 币安数据源管道

```
┌──────────────────────────────────────────────────┐
│         BinanceMarketDataManager               │
│         (币安市场数据统一管理)                  │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
         ▼           ▼           ▼
   ┌─────────┐ ┌────────┐ ┌─────────┐
   │ K线数据 │ │ 订单簿│ │ 资金费率│
   │ OHLCV   │ │ Depth │ │ Funding │
   └────┬────┘ └────┬───┘ └───┬─────┘
        │           │         │
        └─────┬─────┴────┬────┘
              │          │
              ▼          ▼
        ┌──────────┬─────────┐
        │  缓存    │  存储   │
        │  Redis   │ SQLite  │
        └────┬─────┴────┬────┘
             │          │
             └────┬─────┘
                  ▼
        ┌──────────────────┐
        │ AICoinQueryManager│
        └──────────────────┘

数据更新频率: 1分钟
缓存TTL: 5分钟
存储保留: 24小时
```

### 2.2 K线数据采集流程

```
┌──────────────────────────────────────────────────┐
│          K线数据采集流程                          │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│用户请求  │  │ 从缓存查│      │ 缓存命中?│
│BTCUSDT   │──▶│ 询数据  │─────▶│          │
│15m       │  │ Redis   │      └─────┬────┘
└────┬─────┘  └──────────┘            │
     │                                │ 是
     │ 否                             │
     │                                ▼
     │                          ┌──────────┐
     │                          │ 返回缓存 │
     │                          │ 数据     │
     │                          └──────────┘
     │
     └─────────────────────────────────┐
                                       │ 否
                                       ▼
                               ┌──────────────┐
                               │ Binance API  │
                               │ 请求K线数据  │
                               └──────┬───────┘
                                      │
                                      ▼
                               ┌──────────────┐
                               │ 数据清洗     │
                               │ - 缺失值填充 │
                               │ - 异常值处理 │
                               └──────┬───────┘
                                      │
                                      ▼
                               ┌──────────────┐
                               │ 写入缓存     │
                               │ Redis + SQLite│
                               └──────┬───────┘
                                      │
                                      ▼
                               ┌──────────────┐
                               │ 返回数据     │
                               └──────────────┘

性能优化:
- 批量读取 (一次获取1000根K线)
- Redis缓存 (减少API调用)
- 异步IO (async/await)
```

### 2.3 订单簿数据管道

```
┌──────────────────────────────────────────────────┐
│          订单簿数据采集与分析                      │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│本地快照  │  │ Binance  │      │ 合并整合 │
│文件      │──▶│ REST API │─────▶│ 订单簿   │
│10MB/个   │  │ 实时数据  │      │ 完整深度 │
└────┬─────┘  └────┬─────┘      └────┬─────┘
     │             │                 │
     │             └────────┬────────┘
     │                      │
     ▼                      ▼
┌─────────┐          ┌─────────┐
│ 深度分析 │          │ 大订单 │
│ - 买卖比 │          │ 识别   │
│ - 价差   │          │ (50BTC)│
│ - 流动性 │          └─────────┘
└─┬───────┘
   │
   ▼
┌─────────────┐
│ 订单簿分析   │
│ 报告         │
└─────────────┘

应用:
- 流动性分析
- 大订单识别
- 支撑阻力判断
```

### 2.4 资金费率管道

```
┌──────────────────────────────────────────────────┐
│          资金费率数据采集                          │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│ Binance  │  │ 永续合约 │      │ 季度合约 │
│ Funding  │──▶│费率      │      │费率      │
│ Rate API │  │(8小时1次)│      │          │
└────┬─────┘  └────┬─────┘      └────┬─────┘
     │             │                 │
     └─────────────┼─────────────────┘
                   │
                   ▼
         ┌──────────────────┐
         │ FundingRate      │
         │ Analyzer         │
         └──────┬───────────┘
                │
        ┌───────┴────────┐
        │                │
        ▼                ▼
  ┌──────────┐     ┌─────────┐
  │ 费率分析  │     │ 情绪判断 │
  │ - 历史趋势│     │ 看多/看空│
  │ - 极端值  │     │          │
  └──────────┘     └─────────┘

用途:
- 市场多空情绪判断
- 极端费率预警
- 套利机会识别
```

---

## 三、技术指标计算管道

### 3.1 批量计算架构

```
┌──────────────────────────────────────────────────┐
│    TechnicalIndicatorCalculator (技术指标计算器) │
│                  批量计算架构                     │
└────────────────────┬─────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │  输入: DataFrame        │
        │  - K线数据 (1000根)     │
        └────────────┬────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │ ThreadPoolExecutor     │
        │ max_workers=8 (8线程)  │
        └────────┬───────────────┘
     ┌────────────┼────────────┐
     │            │            │
     ▼            ▼            ▼
┌──────────┐ ┌────────┐ ┌──────────┐
│ calc_MACD││calc_RSI││calc_KDJ  │
│ calc_MA  ││calc_ATR││calc_BB   │
│ calc_... ││calc_...││calc_...  │
└────┬─────┘ └──┬─────┘ └──┬───────┘
     │            │          │
     └────────────┼──────────┘
                  │
                  ▼
        ┌──────────────────┐
        │  结果合并         │
        │  DataFrame输出    │
        └────────┬─────────┘
                 │
        ┌────────┴─────────┐
        │                  │
        ▼                  ▼
  ┌──────────┐      ┌─────────┐
  │ 缓存到   │      │ 存储到  │
  │ Redis    │      │ SQLite  │
  └──────────┘      └─────────┘

优化策略:
- 一次读取, 多次计算
- 线程池并行 (CPU密集型)
- 向量化运算 (Pandas)
- 避免重复计算 (Redis缓存)

支持指标: MA, MACD, RSI, KDJ, ATR, BB, VWAP等20+
```

### 3.2 MA (移动平均线) 计算流程

```
┌──────────────────────────────────────────────────┐
│              MA 计算流程                          │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│ 输入     │  │ 计算     │      │ 信号     │
│ K线数据  │──▶│SMA/EMA   │─────▶│ - 金叉  │
│ 收盘价   │  │/WMA      │      │ - 死叉  │
└──────────┘  └──────────┘      │ - 多/空头排列│
                                └──────────┘

参数:
- SMA: simple moving average
- EMA: exponential moving average
- WMA: weighted moving average

常用周期: 5, 10, 20, 30, 60, 120, 250
```

### 3.3 MACD 计算流程

```
┌──────────────────────────────────────────────────┐
│             MACD 计算流程                         │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│ 计算     │  │ 计算     │      │ 计算     │
│ EMA(12)  │──▶│ EMA(26)  │─────▶│ DIF =   │
│ 快线      │  │ 慢线     │      │ EMA12-26 │
└──────────┘  └──────────┘      └────┬─────┘
                                     │
                                     │
                                     ▼
                              ┌──────────┐
                              │ 计算     │
                              │ DEA(9)   │
                              │ 信号线   │
                              └────┬─────┘
                                   │
                                   │
                                   ▼
                              ┌──────────┐
                              │ 计算     │
                              │ MACD柱   │
                              │ 2*(DIF-DEA)│
                              └────┬─────┘
                                   │
                                   ▼
                              ┌──────────┐
                              │ 信号生成 │
                              │ - 金叉   │
                              │ - 死叉   │
                              │ - 背离   │
                              └──────────┘

参数: short=12, long=26, signal=9
```

### 3.4 RSI 计算流程

```
┌──────────────────────────────────────────────────┐
│              RSI 计算流程                         │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│ 计算     │  │ 计算     │      │ 计算     │
│ 价格变动 │──▶│ avg_gain │─────▶│ avg_loss │
│ ΔPrice   │  │ 平均涨幅  │      │ 平均跌幅  │
└──────────┘  └────┬─────┘      └────┬─────┘
                   │                 │
                   └────────┬────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ RS =         │
                    │ avg_gain/    │
                    │ avg_loss     │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ RSI =        │
                    │ 100-(100/    │
                    │ (1+RS))      │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ 信号判断     │
                    │ - >70:超买   │
                    │ - <30:超卖   │
                    └──────────────┘

参数: period=14
```

### 3.5 KDJ 计算流程

```
┌──────────────────────────────────────────────────┐
│              KDJ 计算流程                         │
└────────────────────┬─────────────────────────────┘
                     │
  ┌──────────────────┼──────────────────┐
  │                  │                  │
  ▼                  ▼                  ▼
┌──────────┐  ┌──────────┐      ┌──────────┐
│ 计算     │  │ 计算     │      │ 计算     │
│ RSV      │──▶│ K值      │─────▶│ D值      │
│          │  │ EMA(RSV,3)│     │ │ EMA(K,3)│
│ (收盘价-  │  └──────────┘      │ └─────────┘
│ 最低价)/ │                    │
│ (最高-低)│                    │
└──────────┘                    │
                                │
                                ▼
                          ┌──────────┐
                          │ 计算     │
                          │ J值      │
                          │ 3*K-2*D  │
                          └────┬─────┘
                               │
                               ▼
                         ┌──────────┐
                         │ 信号     │
                         │ - K>D    │
                         │ - 超买超卖│
                         │ - 金叉死叉│
                         └──────────┘

参数: K=3, D=3
```

---

## 四、多周期共振管道

### 4.1 周期权重分配

```
┌──────────────────────────────────────────────────┐
│         多周期共振权重架构                        │
└────────────────────┬─────────────────────────────┘
                     │
       ┌─────────────┴─────────────┐
       │    用户选择基准周期        │
       │      (如: 15m)            │
       └─────────────┬─────────────┘
                     │
      ┌──────────────┼──────────────┐
      │              │              │
      ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ 自动推导 │  │ 权重分配 │  │ 目的      │
├──────────┤  ├──────────┤  ├──────────┤
│ 5m      │  │  20%    │  │ 短期入场 │
│ (关联)   │  │         │  │ 信号捕捉 │
├──────────┤  ├──────────┤  ├──────────┤
│ 15m     │  │  30%    │  │ 中期趋势 │
│ (基准)   │  │         │  │ 主要判断 │
├──────────┤  ├──────────┤  ├──────────┤
│ 1h      │  │  30%    │  │ 中期趋势 │
│ (关联)   │  │         │  │ 主要判断 │
├──────────┤  ├──────────┤  ├──────────┤
│ 4h      │  │  15%    │  │ 长期方向 │
│ (关联)   │  │         │  │ 参考     │
├──────────┤  ├──────────┤  ├──────────┤
│ 1d      │  │  5%     │  │ 大趋势   │
│ (关联)   │  │         │  │ 辅助     │
└──────────┘  └──────────┘  └──────────┘
```

### 4.2 多周期并行计算

```
┌──────────────────────────────────────────────────┐
│        多周期并行计算架构                         │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │  AICoinQueryManager    │
         └───────────┬────────────┘
                     │
         ┌───────────┴────────────┐
         │ MultiTimeframeCalculator│
         └┬───────────────────────┬┘
          │                       │
     ┌────┴────┐             ┌────┴────┐
     │         │             │         │
     ▼         ▼             ▼         ▼
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│  5m计算  │ │ 15m计算  │ │  1h计算  │ │  4h计算  │
│ 线程1    │ │ 线程2    │ │ 线程3    │ │ 线程4    │
│          │ │          │ │          │ │          │
│ - MA     │ │ - MA     │ │ - MA     │ │ - MA     │
│ - MACD   │ │ - MACD   │ │ - MACD   │ │ - MACD   │
│ - RSI    │ │ - RSI    │ │ - RSI    │ │ - RSI    │
│ ...      │ │ ...      │ │ ...      │ │ ...      │
└────┬─────┘ └───┬──────┘ └───┬──────┘ └───┬──────┘
     │           │            │            │
     └───────────┼────────────┼────────────┘
                 │            │
                 └────┬───────┘
                      │
                      ▼
            ┌──────────────────┐
            │ 结果聚合         │
            │ - 统一数据格式   │
            │ - 信号整理       │
            └────────┬─────────┘
                     │
                     ▼
            ┌──────────────────┐
            │ Resonance Analysis│
            │ (共振分析)       │
            └────────┬─────────┘
                     │
                     ▼
            ┌──────────────────┐
            │ 综合信号         │
            │ - 多头共振       │
            │ - 空头共振       │
            │ - 观望           │
            └──────────────────┘

多线程实现:
- ThreadPoolExecutor(max_workers=4)
- 各周期并行计算
- 结果自动聚合
- 响应时间优化: 并行减少50%+时间
```

### 4.3 共振信号生成

```
┌──────────────────────────────────────────────────┐
│          共振信号生成算法                         │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │ 多周期信号汇总          │
         └───────────┬────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
   ┌────────┐  ┌────────┐  ┌────────┐
   │ 5m:    │  │ 15m:   │  │ 1h:    │
   │ 看多   │  │ 看多   │  │ 看多   │
   │ Weight:│  │ Weight:│  │ Weight:│
   │ 0.2    │  │ 0.3    │  │ 0.3    │
   └────┬───┘  └───┬────┘  └───┬────┘
        │          │           │
        └──────────┼───────────┘
                   │
                   ▼
      ┌───────────────────────────┐
      │ 加权计算                  │
      │ Score = Σ(信号×权重)      │
      │ 信号: 看多=1, 看空=-1    │
      └──────┬────────────────────┘
             │
             │
    ┌────────┼────────┬──────────┐
    │        │        │          │
    ▼        ▼        ▼          ▼
┌──────────┐ ┌─────┐ ┌─────┐ ┌─────┐
│Score>0.3 │  │0.3- ││-0.3- ││<-0.3│
│ or >0.5? │  │0.5  ││ 0.5  ││     │
└────┬─────┘ └─┬───┘ └─┬───┘ └─┬───┘
     │         │       │       │
     ▼         ▼       ▼       ▼
┌────────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ 强烈多头│ │多头 ││空头 ││强烈空头│
│ BULL   │ │BULL ││BEAR ││ BEAR  │
└────────┘ └─────┘ └─────┘ └──────┘

示例:
- 5m: 看多 (+0.2)
- 15m: 看多 (+0.3)
- 1h: 看多 (+0.3)
- 4h: 看多 (+0.15)
合计: 0.95 > 0.5 = 强烈多头
```

---

## 五、AI分析管道

### 5.1 分析流程架构

```
┌──────────────────────────────────────────────────┐
│          AI分析管道架构                           │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │  AICoinQueryManager    │
         └──┬───────────────────┬─┘
            │                   │
      ┌─────┴───┐          ┌────┴─────┐
      │         │          │          │
      ▼         ▼          ▼          ▼
┌─────────┐ ┌──────┐ ┌────────┐ ┌──────────┐
│ 数据准备│ │Prompt│ │ LLM    │ │ 结果处理 │
│         │ │构建   │ │调用   │ │         │
├─────────┤ ├──────┤ ├────────┤ ├──────────┤
│- 技术   │ │- 系统 │ │- GPT  │ │- Markdown│
│  指标   │ │- 分析 │ │- Gemini││- 格式化  │
│- 市场   │ │模板   │ │        │ │- 置信度  │
│  数据   │ │      │ │        │ │ 评估    │
│- 订单簿 │ │      │ │        │ │         │
│- 资金   │ │      │ │        │ │         │
│  费率   │ │      │ │        │ │         │
└─────┬───┘ └──┬───┘ └───┬────┘ └────┬─────┘
      │        │         │           │
      └────────┼─────────┼───────────┘
               │         │
               └────┬────┘
                    │
                    ▼
         ┌────────────────────┐
         │ AIAnalysisEngine  │
         │   generate_analysis│
         └────────┬───────────┘
                  │
                  ▼
         ┌────────────────────┐
         │ AnalysisReport     │
         │ Generator          │
         └────────┬───────────┘
                  │
                  ▼
         ┌────────────────────┐
         │ Markdown报告       │
         └────────────────────┘

调用链: _build_analysis_data() → build_prompt() → call_ai_api() → create_report()
```

### 5.2 Prompt构建流程

```
┌──────────────────────────────────────────────────┐
│           Prompt构建流程                          │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │ AIPromptBuilder        │
         └───────────┬────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 系统角色 │ │ 市场数据 │ │ 指令     │
│ System   │ │ Market   │ │ Analysis │
│ Prompt   │ │ Data     │ │ Request  │
└────┬─────┘ └───┬──────┘ └───┬──────┘
     │           │            │
     └───────────┼────────────┘
                 │
                 ▼
        ┌──────────────────┐
        │ 组合成最终Prompt │
        │                  │
        │ 结构:            │
        │ 1. Role          │
        │ 2. Data          │
        │ 3. Task          │
        │ 4. Format        │
        │ 5. Constraints   │
        └────────┬─────────┘
                 │
                 ▼
        ┌──────────────────┐
        │ 调用LLM API      │
        └──────────────────┘

示例模板:
[系统角色]
你是专业的加密货币分析师...

[数据]
BTCUSDT 15m:
- 价格: $43500
- RSI: 65
- MACD: 金叉
...

[指令]请分析并提供交易信号
```

### 5.3 LLM API调用

```
┌──────────────────────────────────────────────────┐
│          LLM API调用架构                          │
└────────────────────┬─────────────────────────────┘
                     │
       ┌─────────────┴─────────────┐
       │  AIAnalysisEngine        │
       │  _call_ai_api()          │
       └┬──────────────────────────┬┘
        │                        │
   ┌────┴─────┐            ┌─────┴──────┐
   │          │            │            │
   ▼          ▼            ▼            ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌──────────┐
│ Gemini │ │ GPT  │ │ Claude │ │ 其他模型 │
│        │ │      │ │        │ │          │
├────────┤ ├──────┤ ├────────┤ ├──────────┤
│ 2.5    │ │ 4    │ │ 3.5    │ │          │
│ Flash  │ │ Turbo│ │ Sonnet │ │          │
└──┬─────┘ └──┬───┘ └───┬────┘ └───┬──────┘
   │          │         │          │
   └──────────┼─────────┼──────────┘
              │         │
              └────┬────┘
                   │
                   ▼
         ┌──────────────────┐
         │ 异步处理         │
         │ - 流式响应       │
         │ - 超时控制       │
         │ - 重试机制       │
         │ - 错误处理       │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐
         │ 解析响应         │
         │ - JSON           │
         │ - Markdown       │
         │ - 自定义格式     │
         └──────────────────┘

调用限制:
- Gemini: 150 RPM (requests per minute)
- GPT: 60 RPM
- 超时: 60秒
- 重试: 3次 (指数退避)

响应解析:
- 市场情绪 (BULL/BEAR/NEUTRAL)
- 信心度 (0-100%)
- 理由 (Markdown格式)
- 信号 (LONG/SHORT/HOLD)
```

---

## 六、结果输出管道

### 6.1 报告生成流程

```
┌──────────────────────────────────────────────────┐
│          分析报告生成流程                         │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │ AnalysisReportGenerator│
         └───────────┬────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 模板选择 │ │ 数据填充 │ │ 格式化   │
│ Template │ │ Variables│ │ Markdown │
└────┬─────┘ └───┬──────┘ └───┬──────┘
     │           │            │
     └───────────┼────────────┘
                 │
                 ▼
        ┌──────────────────┐
        │ 生成报告         │
        │                  │
        │ 结构:            │
        │ 1. 市场概览      │
        │ 2. 技术分析      │
        │ 3. 交易信号      │
        │ 4. 风险管理      │
        │ 5. 仓位建议      │
        └────────┬─────────┘
                 │
                 ▼
        ┌──────────────────┐
        │ Markdown文档     │
        └──────────────────┘
```

### 6.2 图片渲染管道

```
┌──────────────────────────────────────────────────┐
│      Markdown → PNG 渲染管道                     │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │ MarkdownImageRenderer  │
         └───────────┬────────────┘
                     │
      ┌──────────────┼────────────┐
      │              │            │
      ▼              ▼            ▼
┌─────────┐ ┌───────────┐ ┌──────────┐
│ Markdown│ │ HTML转化  │ │ CSS样式  │
│ 预处理  │ │ markdown  │ │ 自定义   │
│         │ │ library   │ │ 样式     │
├─────────┤ ├───────────┤ ├──────────┤
│ - 涨跌  │ │ - 表格    │ │ - 字体   │
│   标记  │ │ - 代码块  │ │ - 颜色   │
│ - 置信  │ │ - 列表    │ │ - 布局   │
│   度标记│ │ - 标题    │ │          │
└────┬────┘ └───┬───────┘ └───┬──────┘
     │          │             │
     └──────────┼─────────────┘
                │
                ▼
      ┌──────────────────┐
      │ HTML文档         │
      │                  │
      │ <!DOCTYPE html>  │
      │ <html>           │
      │   <head>         │
      │     <style>***   │
      │   </head>        │
      │   <body>***      │
      │ </html>          │
      └────────┬─────────┘
               │
               ▼
      ┌──────────────────┐
      │ Playwright       │
      │ - 启动Chromium   │
      │ - 打开页面       │
      │ - 加载HTML       │
      │ networkidle      │
      └────────┬─────────┘
               │
               ▼
      ┌──────────────────┐
      │ 截图             │
      │ page.screenshot()│
      │ - full_page=True │
      │ - type='png'     │
      └────────┬─────────┘
               │
               ▼
      ┌──────────────────┐
      │ PNG图片输出      │
      │ 1920x1080        │
      │ 高清渲染         │
      └──────────────────┘

技术参数:
- 分辨率: 1920x1080
- DPI: 2x (Retina)
- 字体: 28px base (Telegram优化)
- 格式: PNG
- 大小: 500KB-2MB
- 耗时: 2-5秒

特殊样式:
- 价格涨跌: .bullish (绿色) / .bearish (红色)
- 置信度: .confidence-high (绿) / .confidence-medium (黄) / .confidence-low (红)
- 表格: 自适应 + 多列优化
```

### 6.3 Telegram消息发送

```
┌──────────────────────────────────────────────────┐
│       Telegram 消息发送管道                       │
└────────────────────┬─────────────────────────────┘
                     │
      ┌──────────────┴─────────────┐
      │  AITelegramHandler        │
      │  send_results()           │
      └──────────────┬─────────────┘
                     │
      ┌──────────────┼──────────────┐
      │              │              │
      ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ 文字报告 │ │ 图片报告 │ │ 键盘按钮 │
│ Markdown │ │ PNG图片  │ │ (可选)   │
└────┬─────┘ └────┬─────┘ └────┬─────┘
     │            │            │
     └────────────┼────────────┘
                  │
                  ▼
        ┌──────────────────┐
        │ await bot.send_*()│
        │                  │
        │ - send_message   │
        │ - send_photo     │
        │ - send_document  │
        └────────┬─────────┘
                 │
                 ▼
        ┌──────────────────┐
        │ Telegram API     │
        │ 发送成功         │
        └──────────────────┘

发送策略:
1. 先发送文字摘要 (快速)
2. 再发送图片报告 (耗时)
3. 可选: 添加操作按钮
   - 🔄 重新分析
   - 📊 查看详情
   - ⚠️ 风险管理
```

---

## 七、缓存管道

### 7.1 多级缓存架构

```
┌──────────────────────────────────────────────────┐
│           多级缓存管道                            │
└────────────────────┬─────────────────────────────┘
                     │
      ┌──────────────┴──────────────┐
      │     缓存Key设计             │
      │     {symbol}_{interval}_{type}_{timestamp}│
      └──────────────┬──────────────┘
                     │
      ┌──────────────┼──────────────┐
      │              │              │
      ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ L1:内存  │  │ L2:Redis│  │ L3:SQLite│
│ 缓存     │  │ 缓存    │  │ 缓存     │
├──────────┤  ├──────────┤  ├──────────┤
│ 60秒     │  │ 5分钟   │  │ 24小时   │
│ 最快     │  │ 快速    │  │ 持久     │
│ Dict     │  │ Key-Value│  │ SQL查询  │
└────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │
     └─────────────┼─────────────┘
                   │
                   ▼
        ┌──────────────────┐
        │ 查询顺序:        │
        │ 1. 查内存        │
        │ 2. 查Redis       │
        │ 3. 查SQLite      │
        │ 4. 调API         │
        │ 5. 写入各级缓存  │
        └──────────────────┘

缓存命中率:
- L1: 80-90%
- L1+L2: 90-95%
- L1+L2+L3: 95-99%

失效策略:
- 时间过期 (主要)
- 主动失效 (数据更新)
- LRU (内存有限)
```

---

## 八、错误处理管道

```
┌──────────────────────────────────────────────────┐
│            错误处理与恢复管道                     │
└────────────────────┬─────────────────────────────┘
                     │
          ┌──────────┴──────────┐
          │   try-catch块      │
          └──────────┬──────────┘
                     │
      ┌──────────────┼──────────────┐
      │              │              │
      │ 错误类型     │ 处理策略     │ 日志级别
      │              │              │
      ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ 网络超时 │  │ 重试3次  │  │ WARNING  │
│ (10秒)   │  │ 指数退避 │  │          │
├──────────┤  ├──────────┤  ├──────────┤
│ API限流  │  │ 等待60秒 │  │ WARNING  │
│ (429)    │  │ 重试     │  │          │
├──────────┤  ├──────────┤  ├──────────┤
│ 数据缺失 │  │ 调用补全 │  │ INFO     │
│          │  │ 脚本     │  │          │
├──────────┤  ├──────────┤  ├──────────┤
│ 缓存失效 │  │ 重新生成 │  │ INFO     │
│          │  │          │  │          │
├──────────┤  ├──────────┤  ├──────────┤
│ 系统异常 │  │ 记录日志 │  │ ERROR    │
│ (未知)   │  │ 发送告警 │  │          │
└────┬─────┘ └────┬─────┘ └────┬─────┘
     │            │            │
     └────────────┼────────────┘
                  │
                  ▼
        ┌──────────────────┐
        │ 统一错误处理     │
        │ - 日志记录       │
        │ - 用户通知       │
        │ - 指标上报       │
        └──────────────────┘

日志格式:
[时间] [模块] [函数:行号] [错误码] 消息 [context]

示例:
2025-11-30 12:00:00 | ai.py:14003 | E1001 | Binance API timeout | symbol=BTCUSDT, retry=2
```

---

## 九、性能优化点

```
┌──────────────────────────────────────────────────┐
│          性能优化核心策略                          │
└────────────────────┬─────────────────────────────┘
                     │
      ┌──────────────┴──────────────┐
      │ 计算优化:                   │
      │ 1. 向量化运算 (Pandas)      │
      │ 2. 批量处理 (减少IO)        │
      │ 3. 线程池并行 (8线程)       │
      └──────────────┬──────────────┘
                     │
      ┌──────────────┴──────────────┐
      │ 存储优化:                   │
      │ 1. 多级缓存 (L1/L2/L3)      │
      │ 2. 批量写入 (1000条/次)     │
      │ 3. 索引优化 (复合索引)      │
      └──────────────┬──────────────┘
                     │
      ┌──────────────┴──────────────┐
      │ 网络优化:                   │
      │ 1. 异步IO (async/await)     │
      │ 2. 连接池复用               │
      │ 3. 请求限流 (Binance:1200RPM)│
      └──────────────┬──────────────┘
                     │
      ┌──────────────┴──────────────┐
      │ AI优化:                     │
      │ 1. 结果缓存 (24小时)        │
      │ 2. 并发控制 (Semaphore=5)   │
      │ 3. 流式响应 (减少等待)      │
      └──────────────┬──────────────┘
                     │
                     ▼
         ┌──────────────────┐
         │ 监控指标         │
         │ - 响应时间P99     │
         │ - 缓存命中率      │
         │ - AI成功率        │
         │ - 数据完整性      │
         └──────────────────┘

优化效果:
- 响应时间: 30秒 → 15秒
- 缓存命中: 50% → 80%+
- AI成功率: 95%+ (重试机制)
- 吞吐量: 支持100+并发用户
```

---

## 十、监控指标

```
┌──────────────────────────────────────────────────┐
│            核心监控指标                           │
├─────────────────┬────────┬──────────┬─────────┤
│ 指标            │ 当前值 │ 目标值   │ 告警线  │
├─────────────────┼────────┼──────────┼─────────┤
│ AI成功率        │ 95.5%  │ >95%     │ <90%    │
│ 平均响应时间    │ 18秒   │ <30秒    │ >60秒   │
│ 缓存命中率      │ 85%    │ >70%     │ <50%    │
│ 数据完整性      │ 99.95% │ >99.9%   │ <99%    │
│ 并发用户数      │ 45     │ <50      │ >50     │
│ Binance错误率   │ 0.5%   │ <1%      │ >5%     │
│ LLM错误率       │ 2.1%   │ <5%      │ >10%    │
│ 内存使用率      │ 2.8GB  │ <4GB     │ >8GB    │
│ CPU使用率       │ 45%    │ <70%     │ >90%    │
│ 磁盘空间        │ 85GB   │ >100GB   │ <20GB   │
└─────────────────┴────────┴──────────┴─────────┘

监控周期: 每10秒采集
告警方式: Telegram + 邮件
数据保留: 30天 (Prometheus)
```

---

## 十一、部署架构

```
┌──────────────────────────────────────────────────┐
│              部署架构图                           │
└────────────────────┬─────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │  用户 (Telegram)       │
         └───────────┬────────────┘
                     │
                     │
         ┌───────────┴────────────┐
         │  Bot服务器             │
         │  (WSL2 Ubuntu)         │
         │                        │
         │  telegram-service/src/ai│
         ├────────────────────────┤
         │  - bot.py (38KB)       │
         │  - ai.py (744KB)       │
         │  - data.py (444KB)     │
         │  - utils.py (47KB)     │
         └────┬───────────────────┘
              │
              │
    ┌─────────┼──────────┬──────────┐
    │         │          │          │
    ▼         ▼          ▼          ▼
┌─────────┐ ┌────────┐ ┌──────┐ ┌────────┐
│ Redis   │ │ SQLite │ │ TimescaleDB││ S3    │
│ (缓存)  │ │ (本地) │ │ (时序)││ (备份)│
└─────────┘ └────────┘ └───────┘ └────────┘

配置:
- CPU: 8核心
- 内存: 8GB
- 存储: 200GB SSD
- 网络: 100Mbps

依赖:
- Python 3.11+
- Redis 7.0+
- Playwright + Chromium
- 8000+端口 (Telegram)
```

---

## 十二、版本迭代记录

```
┌──────────────────────────────────────────────────┐
│           数据管道版本迭代                         │
├─────────┬──────────┬────────────────────────────┤
│ 版本    │ 日期     │ 变更内容                   │
├─────────┼──────────┼────────────────────────────┤
│ v1.0    │ 2025-11-10│ 基础数据采集与AI分析      │
│ v1.1    │ 2025-11-15│ 添加多周期共振计算        │
│ v1.2    │ 2025-11-18│ 添加缓存系统 (L1/L2/L3)  │
│ v1.3    │ 2025-11-20│ 优化批量计算 (8线程)      │
│ v1.4    │ 2025-11-22│ 添加订单簿分析            │
│ v1.5    │ 2025-11-25│ 支持图片渲染 (Playwright)│
│ v1.6    │ 2025-11-27│ 添加资金费率分析          │
│ v1.7    │ 2025-11-28│ 优化缓存命中率 (85%+)     │
│ v1.8    │ 2025-11-29│ 添加错误恢复机制          │
│ v1.9    │ 2025-11-30│ 文档化 (数据管道)         │
└─────────┴──────────┴────────────────────────────┘

下一版本规划:
- v2.0: 添加回测验证管道
- v2.1: 支持更多交易所
- v2.2: 添加量化策略执行
```
