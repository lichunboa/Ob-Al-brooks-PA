# 小禾酥_Joo

- v1
    
    ![image.png](Categories%20分类/Al%20brooks/价格行为学/小禾酥_Joo/image.png)
    
    ```
    //@version=4
    strategy("加密货币组合策略（RSI过滤 + ATR止损）", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
    
    // 10/15/30 min
    // ======== 参数输入 ========
    signal_length = input(7, title="信号平滑周期")
    sma_signal = input(false, title="使用SMA（否则EMA）")
    lin_reg = input(true, title="使用线性回归K线")
    linreg_length = input(14, title="线性回归长度")
    a = input(1.5, title = "Trailing Stop ATR 乘数")
    c = input(14, title = "Trailing Stop ATR 周期")
    h = input(false, title = "使用 Heikin Ashi")
    
    // === RSI 动能过滤 ===
    use_rsi_filter = input(true, title="启用 RSI 过滤？")
    rsi_length = input(14, title="RSI周期")
    rsi_buy_min = input(50, title="Buy 需 RSI >")
    rsi_sell_max = input(50, title="Sell 需 RSI <")
    
    // === ATR 止损参数 ===
    use_atr_exit = input(true, title="启用 ATR 止损")
    atr_exit_mult = input(2.0, title="ATR 止损倍数")
    
    // ======== 数据源处理 ========
    src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close) : close
    bclose = lin_reg ? linreg(close, linreg_length, 0) : close
    signal = sma_signal ? sma(bclose, signal_length) : ema(bclose, signal_length)
    
    // ======== UT Bot Trailing Stop ========
    xATR = atr(c)
    nLoss = a * xATR
    
    var float xATRTrailingStop = na
    xATRTrailingStop := 
         src > nz(xATRTrailingStop[1]) and src[1] > nz(xATRTrailingStop[1]) ? max(nz(xATRTrailingStop[1]), src - nLoss) :
         src < nz(xATRTrailingStop[1]) and src[1] < nz(xATRTrailingStop[1]) ? min(nz(xATRTrailingStop[1]), src + nLoss) :
         src > nz(xATRTrailingStop[1]) ? src - nLoss : src + nLoss
    
    ema1 = ema(src, 1)
    rawBuy  = crossover(ema1, xATRTrailingStop) and src > xATRTrailingStop
    rawSell = crossover(xATRTrailingStop, ema1) and src < xATRTrailingStop
    
    // ======== RSI 动能过滤 ========
    rsi = rsi(close, rsi_length)
    rsi_ok_buy  = not use_rsi_filter or (rsi > rsi_buy_min)
    rsi_ok_sell = not use_rsi_filter or (rsi < rsi_sell_max)
    
    // ======== 最终信号（RSI过滤） ========
    buy = rawBuy and rsi_ok_buy
    sell = rawSell and rsi_ok_sell
    
    // ======== Entry 执行 ========
    if buy
        strategy.entry("Long", strategy.long)
    
    if sell
        strategy.entry("Short", strategy.short)
    
    // ======== Exit 使用 ATR 止损 ========
    atr_exit = atr(c)
    
    if use_atr_exit
        strategy.exit("Stop Long", from_entry="Long", stop=close - atr_exit_mult * atr_exit)
        strategy.exit("Stop Short", from_entry="Short", stop=close + atr_exit_mult * atr_exit)
    
    // ======== 标签提示 ========
    if buy
        label.new(bar_index, low, "买", style=label.style_labelup, color=color.green, textcolor=color.white, size=size.small)
    
    if sell
        label.new(bar_index, high, "卖", style=label.style_labeldown, color=color.red, textcolor=color.white, size=size.small)
    ```
    
- v2
    
    ![image.png](Categories%20分类/Al%20brooks/价格行为学/小禾酥_Joo/image%201.png)
    
    ```jsx
    //@version=4
    strategy("加密货币组合策略（RSI过滤 + ATR止损）", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
    
    // 10/15/30 min
    // ======== 参数输入 ========
    signal_length = input(7, title="信号平滑周期")
    sma_signal = input(false, title="使用SMA（否则EMA）")
    lin_reg = input(true, title="使用线性回归K线")
    linreg_length = input(14, title="线性回归长度")
    a = input(1.5, title = "Trailing Stop ATR 乘数")
    c = input(14, title = "Trailing Stop ATR 周期")
    d = input(14, title = "Stop Loss ATR 周期")
    h = input(false, title = "使用 Heikin Ashi")
    
    // === RSI 动能过滤 ===
    use_rsi_filter = input(true, title="启用 RSI 过滤？")
    rsi_length = input(14, title="RSI周期")
    rsi_buy_min = input(50, title="Buy 需 RSI >")
    rsi_sell_max = input(50, title="Sell 需 RSI <")
    
    // === ATR 止损参数 ===
    use_atr_exit = input(true, title="启用 ATR 止损")
    atr_exit_mult = input(2.0, title="ATR 止损倍数")
    
    // ======== 数据源处理 ========
    src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close) : close
    bclose = lin_reg ? linreg(close, linreg_length, 0) : close
    signal = sma_signal ? sma(bclose, signal_length) : ema(bclose, signal_length)
    
    // ======== UT Bot Trailing Stop ========
    xATR = atr(c)
    nLoss = a * xATR
    
    var float xATRTrailingStop = na
    xATRTrailingStop := 
         src > nz(xATRTrailingStop[1]) and src[1] > nz(xATRTrailingStop[1]) ? max(nz(xATRTrailingStop[1]), src - nLoss) :
         src < nz(xATRTrailingStop[1]) and src[1] < nz(xATRTrailingStop[1]) ? min(nz(xATRTrailingStop[1]), src + nLoss) :
         src > nz(xATRTrailingStop[1]) ? src - nLoss : src + nLoss
    
    ema1 = ema(src, 1)
    rawBuy  = crossover(ema1, xATRTrailingStop) and src > xATRTrailingStop
    rawSell = crossover(xATRTrailingStop, ema1) and src < xATRTrailingStop
    
    // ======== RSI 动能过滤 ========
    rsi = rsi(close, rsi_length)
    rsi_ok_buy  = not use_rsi_filter or (rsi > rsi_buy_min)
    rsi_ok_sell = not use_rsi_filter or (rsi < rsi_sell_max)
    
    // ======== 最终信号（RSI过滤） ========
    buy = rawBuy and rsi_ok_buy
    sell = rawSell and rsi_ok_sell
    var float entry_price = na
    // ======== Entry 执行 ========
    if buy
        strategy.entry("Long", strategy.long)
        entry_price := close  // 记录多头入场价
    
    if sell
        strategy.entry("Short", strategy.short)
        entry_price := close  // 记录空头入场价
    
    // ======== Exit 使用 ATR 止损 ========
    atr_exit = atr(d)
    exit_threshold = atr_exit_mult * atr_exit  // 回撤阈值
    
    if use_atr_exit
        strategy.exit("Stop Long", from_entry="Long", stop=entry_price - atr_exit_mult * atr_exit,comment="多头 止损离场")
        strategy.exit("Stop Short", from_entry="Short", stop=entry_price + atr_exit_mult * atr_exit,comment="空头 止损离场")
    
    if strategy.position_size > 0 and not na(entry_price)
        unrealized_pnl_atr = close - entry_price
        if unrealized_pnl_atr > 0 and (close < entry_price + exit_threshold)
            strategy.close("Long", comment="多头 浮盈回撤出场")
    
    if strategy.position_size < 0 and not na(entry_price)
        unrealized_pnl_atr = entry_price - close
        if unrealized_pnl_atr > 0 and (close > entry_price - exit_threshold)
            strategy.close("Short", comment="空头 浮盈回撤出场")
    
    // ======== 标签提示 ========
    if buy
        label.new(bar_index, low, "买", style=label.style_labelup, color=color.green, textcolor=color.white, size=size.small)
    
    if sell
        label.new(bar_index, high, "卖", style=label.style_labeldown, color=color.red, textcolor=color.white, size=size.small)
    ```
    
- v3
    
    ![d44fe73cd02a304f32451dc2e43e01a.png](d44fe73cd02a304f32451dc2e43e01a.png)
    
    ```jsx
    //@version=4
    strategy("加密货币组合策略（RSI过滤 + ATR止损）", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
    
    // 10/15/30 min
    // ======== 参数输入 ========
    signal_length = input(7, title="信号平滑周期")
    sma_signal = input(false, title="使用SMA（否则EMA）")
    lin_reg = input(true, title="使用线性回归K线")
    linreg_length = input(14, title="线性回归长度")
    a = input(1.5, title = "Trailing Stop ATR 乘数")
    c = input(14, title = "Trailing Stop ATR 周期")
    d = input(14, title = "Stop Loss ATR 周期")
    h = input(false, title = "使用 Heikin Ashi")
    
    // === RSI 动能过滤 ===
    use_rsi_filter = input(true, title="启用 RSI 过滤？")
    rsi_length = input(14, title="RSI周期")
    rsi_buy_min = input(50, title="Buy 需 RSI >")
    rsi_sell_max = input(50, title="Sell 需 RSI <")
    
    // === ATR 止损参数 ===
    use_atr_exit = input(true, title="启用 ATR 止损")
    atr_exit_mult = input(2.0, title="ATR 止损倍数")
    
    // ======== 数据源处理 ========
    src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close) : close
    bclose = lin_reg ? linreg(close, linreg_length, 0) : close
    signal = sma_signal ? sma(bclose, signal_length) : ema(bclose, signal_length)
    
    // ======== UT Bot Trailing Stop ========
    xATR = atr(c)
    nLoss = a * xATR
    
    var float xATRTrailingStop = na
    xATRTrailingStop := 
         src > nz(xATRTrailingStop[1]) and src[1] > nz(xATRTrailingStop[1]) ? max(nz(xATRTrailingStop[1]), src - nLoss) :
         src < nz(xATRTrailingStop[1]) and src[1] < nz(xATRTrailingStop[1]) ? min(nz(xATRTrailingStop[1]), src + nLoss) :
         src > nz(xATRTrailingStop[1]) ? src - nLoss : src + nLoss
    
    ema1 = ema(src, 1)
    rawBuy  = crossover(ema1, xATRTrailingStop) and src > xATRTrailingStop
    rawSell = crossover(xATRTrailingStop, ema1) and src < xATRTrailingStop
    
    // ======== RSI 动能过滤 ========
    rsi = rsi(close, rsi_length)
    rsi_ok_buy  = not use_rsi_filter or (rsi > rsi_buy_min)
    rsi_ok_sell = not use_rsi_filter or (rsi < rsi_sell_max)
    
    // ======== 最终信号（RSI过滤） ========
    buy = rawBuy and rsi_ok_buy
    sell = rawSell and rsi_ok_sell
    var float entry_price = na
    // ======== Entry 执行 ========
    if buy
        strategy.entry("Long", strategy.long)
        entry_price := close  // 记录多头入场价
    
    if sell
        strategy.entry("Short", strategy.short)
        entry_price := close  // 记录空头入场价
    
    // ======== Exit 使用 ATR 止损 ========
    atr_exit = atr(d)
    exit_threshold = atr_exit_mult * atr_exit  // 回撤阈值
    
    if use_atr_exit
        strategy.exit("Stop Long", from_entry="Long", stop=entry_price - atr_exit_mult * atr_exit,comment="多头 止损离场")
        strategy.exit("Stop Short", from_entry="Short", stop=entry_price + atr_exit_mult * atr_exit,comment="空头 止损离场")
    
    if strategy.position_size > 0 and not na(entry_price)
        unrealized_pnl_atr = close - entry_price
        if unrealized_pnl_atr > 0 and (high - close >  exit_threshold)
            strategy.close("Long", comment="多头 浮盈回撤出场")
    
    if strategy.position_size < 0 and not na(entry_price)
        unrealized_pnl_atr = entry_price - close
        if unrealized_pnl_atr > 0 and (close - high > exit_threshold)
            strategy.close("Short", comment="空头 浮盈回撤出场")
    
    // ======== 标签提示 ========
    if buy
        label.new(bar_index, low, "买", style=label.style_labelup, color=color.green, textcolor=color.white, size=size.small)
    
    if sell
        label.new(bar_index, high, "卖", style=label.style_labeldown, color=color.red, textcolor=color.white, size=size.small)
    ```
    
- v4
    
    ![image.png](Categories%20分类/Al%20brooks/价格行为学/小禾酥_Joo/image%202.png)
    
    ![image.png](Categories%20分类/Al%20brooks/价格行为学/小禾酥_Joo/image%203.png)
    
    ```jsx
    //@version=4
    strategy("加密货币组合策略（RSI过滤 + ATR止损）", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
    
    // 10/15/30 min
    // ======== 参数输入 ========
    signal_length = input(7, title="信号平滑周期")
    sma_signal = input(false, title="使用SMA（否则EMA）")
    lin_reg = input(true, title="使用线性回归K线")
    linreg_length = input(14, title="线性回归长度")
    a = input(1.5, title = "Trailing Stop ATR 乘数")
    c = input(14, title = "Trailing Stop ATR 周期")
    d = input(14, title = "Stop Loss ATR 周期")
    h = input(false, title = "使用 Heikin Ashi")
    
    // === RSI 动能过滤 ===
    use_rsi_filter = input(true, title="启用 RSI 过滤？")
    rsi_length = input(14, title="RSI周期")
    rsi_buy_min = input(50, title="Buy 需 RSI >")
    rsi_sell_max = input(50, title="Sell 需 RSI <")
    
    // === ATR 止损参数 ===
    atr_exit_mult = input(1.4, title="ATR 止损倍数")
    
    // ======== 数据源处理 ========
    src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close) : close
    bclose = lin_reg ? linreg(close, linreg_length, 0) : close
    signal = sma_signal ? sma(bclose, signal_length) : ema(bclose, signal_length)
    
    // ======== UT Bot Trailing Stop ========
    xATR = atr(c)
    nLoss = a * xATR
    
    var float xATRTrailingStop = na
    xATRTrailingStop := 
         src > nz(xATRTrailingStop[1]) and src[1] > nz(xATRTrailingStop[1]) ? max(nz(xATRTrailingStop[1]), src - nLoss) :
         src < nz(xATRTrailingStop[1]) and src[1] < nz(xATRTrailingStop[1]) ? min(nz(xATRTrailingStop[1]), src + nLoss) :
         src > nz(xATRTrailingStop[1]) ? src - nLoss : src + nLoss
    
    ema1 = ema(src, 1)
    rawBuy  = crossover(ema1, xATRTrailingStop) and src > xATRTrailingStop
    rawSell = crossover(xATRTrailingStop, ema1) and src < xATRTrailingStop
    
    // ======== RSI 动能过滤 ========
    rsi = rsi(close, rsi_length)
    rsi_ok_buy  = not use_rsi_filter or (rsi > rsi_buy_min)
    rsi_ok_sell = not use_rsi_filter or (rsi < rsi_sell_max)
    
    // ======== 最终信号（RSI过滤） ========
    buy = rawBuy and rsi_ok_buy
    sell = rawSell and rsi_ok_sell
    var float entry_price = na
    // ======== Entry 执行 ========
    if buy 
        strategy.entry("Long", strategy.long)
        entry_price := close  // 仅在从 flat 到多头时记录价格
    
    if sell 
        strategy.entry("Short", strategy.short)
        entry_price := close  // 仅在从 flat 到空头时记录价格
    
    // ======== Exit 使用 ATR 止损 ========
    atr_exit = atr(d)
    exit_threshold = atr_exit_mult * atr_exit  // 回撤阈值
    
    strategy.exit("Stop Long", from_entry="Long", stop=entry_price - atr_exit_mult * atr_exit,comment="多头 离场")
    strategy.exit("Stop Short", from_entry="Short", stop=entry_price + atr_exit_mult * atr_exit,comment="空头 离场")
    
    //if strategy.position_size > 0 and not na(entry_price)
    //    unrealized_pnl_atr = close - entry_price
    //    if unrealized_pnl_atr > 0 and (high - close >  exit_threshold)
    //        strategy.close("Long", comment="多头 浮盈回撤出场")
    
    //if strategy.position_size < 0 and not na(entry_price)
    //    unrealized_pnl_atr = entry_price - close
    //    if unrealized_pnl_atr > 0 and (close - high > exit_threshold)
    //        strategy.close("Short", comment="空头 浮盈回撤出场")
    
    // ======== 标签提示 ========
    if buy
        label.new(bar_index, low, "买", style=label.style_labelup, color=color.green, textcolor=color.white, size=size.small)
    
    if sell
        label.new(bar_index, high, "卖", style=label.style_labeldown, color=color.red, textcolor=color.white, size=size.small)
    ```
    
- v5
    
    ![ac545cfff5e71e5e93622e2a0566537.png](ac545cfff5e71e5e93622e2a0566537.png)
    
    ![9e735fa3d85c72ff6e3106b104bf9bd.png](9e735fa3d85c72ff6e3106b104bf9bd.png)
    
    ```jsx
    //@version=4
    strategy("加密货币组合策略（RSI过滤 + ATR止损）", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
    
    // 10/15/30 min
    // ======== 参数输入 ========
    signal_length = input(7, title="信号平滑周期")
    sma_signal = input(false, title="使用SMA（否则EMA）")
    lin_reg = input(true, title="使用线性回归K线")
    linreg_length = input(14, title="线性回归长度")
    a = input(1.5, title = "Trailing Stop ATR 乘数")
    c = input(14, title = "Trailing Stop ATR 周期")
    d = input(14, title = "Stop Loss ATR 周期")
    h = input(false, title = "使用 Heikin Ashi")
    
    // === RSI 动能过滤 ===
    use_rsi_filter = input(true, title="启用 RSI 过滤？")
    rsi_length = input(14, title="RSI周期")
    rsi_buy_min = input(50, title="Buy 需 RSI >")
    rsi_sell_max = input(50, title="Sell 需 RSI <")
    
    // === ATR 止损参数 ===
    atr_exit_mult = input(1.4, title="ATR 止损倍数")
    
    // ======== 数据源处理 ========
    src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close) : close
    bclose = lin_reg ? linreg(close, linreg_length, 0) : close
    signal = sma_signal ? sma(bclose, signal_length) : ema(bclose, signal_length)
    
    // 记录最高价/最低价，实现 trailing stop
    var float highestSince = na
    var float lowestSince  = na
    
    if (strategy.position_size > 0)
        highestSince := na(highestSince) ? high : max(highestSince, high)
        lowestSince := na
    else if (strategy.position_size < 0)
        lowestSince := na(lowestSince) ? low : min(lowestSince, low)
        highestSince := na
    else
        highestSince := na
        lowestSince := na
    
    // ======== UT Bot Trailing Stop ========
    xATR = atr(c)
    nLoss = a * xATR
    
    var float xATRTrailingStop = na
    xATRTrailingStop := 
         src > nz(xATRTrailingStop[1]) and src[1] > nz(xATRTrailingStop[1]) ? max(nz(xATRTrailingStop[1]), src - nLoss) :
         src < nz(xATRTrailingStop[1]) and src[1] < nz(xATRTrailingStop[1]) ? min(nz(xATRTrailingStop[1]), src + nLoss) :
         src > nz(xATRTrailingStop[1]) ? src - nLoss : src + nLoss
    
    ema1 = ema(src, 1)
    rawBuy  = crossover(ema1, xATRTrailingStop) and src > xATRTrailingStop
    rawSell = crossover(xATRTrailingStop, ema1) and src < xATRTrailingStop
    
    // ======== RSI 动能过滤 ========
    rsi = rsi(close, rsi_length)
    rsi_ok_buy  = not use_rsi_filter or (rsi > rsi_buy_min)
    rsi_ok_sell = not use_rsi_filter or (rsi < rsi_sell_max)
    
    // ======== 最终信号（RSI过滤） ========
    buy = rawBuy and rsi_ok_buy
    sell = rawSell and rsi_ok_sell
    var float entry_price = na
    // ======== Entry 执行 ========
    if buy 
        strategy.entry("Long", strategy.long)
        entry_price := close  // 仅在从 flat 到多头时记录价格
    
    if sell 
        strategy.entry("Short", strategy.short)
        entry_price := close  // 仅在从 flat 到空头时记录价格
    
    // ======== Exit 使用 ATR 止损 ========
    atr_exit = atr(d)
    exit_threshold = atr_exit_mult * atr_exit  // 回撤阈值
    
    strategy.exit("Stop Long", from_entry="Long", stop=entry_price - atr_exit_mult * atr_exit,comment="多头 离场")
    strategy.exit("Stop Short", from_entry="Short", stop=entry_price + atr_exit_mult * atr_exit,comment="空头 离场")
    
    //if strategy.position_size > 0 and not na(highestSince)
    //    unrealized_pnl_atr = close - entry_price
    //    if unrealized_pnl_atr > 0 and (highestSince - close >  exit_threshold)
    //        strategy.close("Long", comment="多头 浮盈回撤出场")
    
    //if strategy.position_size < 0 and not na(lowestSince)
    //    unrealized_pnl_atr = entry_price - close
    //    if unrealized_pnl_atr > 0 and (close - lowestSince  > exit_threshold)
    //        strategy.close("Short", comment="空头 浮盈回撤出场")
    
    // ======== 标签提示 ========
    if buy
        label.new(bar_index, low, "买", style=label.style_labelup, color=color.green, textcolor=color.white, size=size.small)
    
    if sell
        label.new(bar_index, high, "卖", style=label.style_labeldown, color=color.red, textcolor=color.white, size=size.small)
    ```
    
-