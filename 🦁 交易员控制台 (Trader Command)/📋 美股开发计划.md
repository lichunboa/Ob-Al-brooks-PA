# 美股数据扩展方案 (Stock Service)

## 目标
支持 ES (标普期货), NQ (纳指期货) 及主要美股数据的采集，并无缝集成到现有的 TradeCat 生态中。

## 架构设计

### 1. 新增服务: `services/stock-service`
作为一个独立的 Python 服务运行，不依赖 `data-service` (Crypto)。
- **依赖**: `yfinance`, `asyncpg`, `pandas`, `apscheduler`
- **运行模式**: 定时任务 (Cron)
    - 市场开放期间: 每 1 分钟抓取最新 1m K线。
    - 每日收盘: 抓取日线并修正。
    - 启动时: 补全最近 7 天数据。

### 2. 数据存储策略 (Reuse Strategy)
为了复用 TradeCat 的 `trading-service` (指标计算) 和 `api-gateway` (查询)，我们将美股数据**伪装**成 Crypto 数据写入现有表。

- **目标表**: `market_data.raw.crypto_kline_1m`
- **字段映射**:
    - `symbol`: 保持原名 (如 `ES=F`, `AAPL`)。
    - `open_time`: 转换 UTC 时间戳。
    - `volume`: 映射 Yahoo Volume。
    - `quote_volume`: 填 `0` (股票通常无此数据)。
    - `trades`: 填 `0`。
    - `taker_buy_volume`: 填 `NULL` 或 `0`。

### 3. 需要采集的标的 (Initial List)
- **期货**: `ES=F` (S&P 500 Futures), `NQ=F` (Nasdaq 100 Futures)
- **指数ETF**: `SPY`, `QQQ`
- **个股**: `NVDA`, `TSLA`, `AAPL`

## 执行步骤
1.  **Scaffold**: 创建 `services/stock-service` 目录结构。
2.  **Code**: 编写 `collector.py` (yfinance wrapper) 和 `main.py` (scheduler)。
3.  **Config**: 将其加入 `scripts/start_mac.sh`。
4.  **Verify**: 启动服务，检查 `api-gateway` 是否能读到 `ES=F`。

> 风险提示: `yfinance` 1m 数据不稳定，常有延迟。作为免费方案可行，生产环境建议换用 Alpaca 或 IBKR。我们先用 YF 跑通流程。
