# 📋 交易员控制台 v5.0 深度分析报告（基线）

> 用途：本文件作为“从 DataviewJS 控制台迁移到插件”的对比基线。
>
> - 基线对象：当前仓库内的 DataviewJS 控制台实现（以 `🦁 交易员控制台 (Trader Command)5.0.md` + `scripts/pa-core.js` 为入口）。
> - 不包含：插件侧问题修复方案（另文输出）。
> - 日期：2026-01-03

---

## 1. 系统是什么（定位）

这套系统不是单纯的笔记集合，而是一个运行在 Obsidian 内的“交易决策支持系统（DSS）”：

- 数据源：交易/策略/课程/复习等 Markdown 笔记的 YAML frontmatter + 正文规则
- 运行时：Obsidian + DataviewJS
- 核心机制：由一个“核心引擎”统一扫描、归一化与缓存，并输出到 `window.paData`（单一信源）
- 视图层：多个 `dv.view("scripts/pa-view-*.js")` 只读 `window.paData` 做渲染与交互

---

## 2. 入口与模块地图（你现在的 v5.0 页面）

控制台入口页面：`🦁 交易员控制台 (Trader Command)5.0.md`

页面加载顺序（关键视图）：

1. `scripts/pa-core`：核心引擎（必须先运行，构建 `window.paData`）
2. Trading Hub：`scripts/pa-view-today`
3. Analytics Hub：`scripts/pa-view-hub-analytics`
4. Learning：`scripts/pa-view-memory`、`scripts/pa-view-course`、`scripts/pa-view-playbook`、`scripts/pa-view-gallery`
5. Governance：`scripts/pa-view-inspector`、`scripts/pa-view-schema`、`scripts/pa-view-manager`

---

## 3. 核心引擎（pa-core.js）的职责边界

核心引擎目标：一次扫描 → 统一口径 → 挂载到内存 → 视图只读。

根据现有实现与技术报告，Core 的关键输出包括：

- `window.paData.trades` / `tradesAsc`：交易列表（已归一化）
- `window.paData.stats`：统计（按账户/胜率/汇总等）
- `window.paData.strategyIndex`：策略索引（策略仓库单一信源：byName/lookup/byPattern/list）
- `window.paData.daily`：日记相关（例如 todayJournal 的 market_cycle，用于今日策略推荐）
- `window.paData.sr`：记忆库/闪卡统计（到期、题库、推荐等）
- `window.paData.course`：课程大纲/完成度/推荐
- `window.paData.coach` + `window.paData.recommendations`：统一推荐（trade > course > sr 的排序策略）

稳定性机制（从代码可见的硬化点）：

- TTL 缓存 + “强制刷新”开关（`window.paForceReload`）
- 防并发/递归刷新（`window.__paBuilding`）
- 处理 Dataview 重渲染导致的滚动跳动（捕获/恢复 scroller 状态）

---

## 4. 视图层原则（单一信源）

在 v5.0 视图代码里已经出现明确的“单一信源”策略：

- Today 看板：直接使用 `window.paData.tradesAsc`、`window.paData.strategyIndex`、`window.paData.daily.todayJournal`
- Analytics Hub：优先使用 `window.paData.strategyIndex`，若缺失则禁用策略映射（避免视图重复扫描策略库导致口径漂移）

这意味着：

- Core 的字段归一化/别名表/类型稳定性，是整个系统的“真实接口（API）”
- 视图层应尽量避免自行重复读取文件或重建索引

---

## 5. 模板与字段（Trade / Strategy）

系统通过模板把“可消费字段”收敛到 frontmatter：

- 交易模板：`Templates/单笔交易模版 (Trade Note).md`
  - 字段集合围绕：账户/品种/周期/市场周期/方向/设置类别/形态/信号/订单/价格/风险/净利润/结果/封面/执行评价/策略名称
- 策略卡模板：`Templates/策略卡片规范模板 (Strategy Card Template).md`
  - 字段集合围绕：策略名称/状态/适用市场周期/设置类别/观察到形态/信号质量/入场条件/风险提示/止损建议/目标建议/来源

模板与字段说明文档：`🦁 交易员控制台 (Trader Command)/📘 模板与字段说明.md`

---

## 6. 为什么“移植到插件”容易出问题（迁移风险画像）

从 DataviewJS 控制台迁移到插件，本质上是把“运行时扫描 + 宽松容错”的行为，改成“索引器一次性抽取 + 稳定 schema”。常见风险：

1. **字段别名与口径差异**：
   - 控制台允许中英文键并存、数组/标量混用、Proxy 值等；插件必须在导出 schema 上做硬收敛。
2. **`pnl` 与 `r` 的语义冲突**：
   - 控制台里可能同时存在“金额 pnl”和“R 倍数 r”；插件导出若把二者混用，会造成统计与 UI 文案错位。
3. **“非交易数据”是否导出**：
   - 控制台的 `sr/course/recommendations` 是运行时计算；插件快照若只导出 `trades + stats`，很多模块会缺数据。
4. **排序/去重/主键**：
   - 控制台常用 `tradesAsc` 与 `mtime` 排序；插件若只输出 `trades[]` 且顺序不保证，会引发“今天看板”“最近交易”等体验偏差。

---

## 7. 后续对比报告将覆盖的点（与插件对齐用）

迁移对比（legacy → plugin）建议至少覆盖：

- trades：数量一致性、主键（path）、排序、字段别名收敛
- stats：按账户类型统计口径、win/loss/open/unknown 的判定
- strategyIndex：是否导出、是否支持 byPattern/lookup 的稳定行为
- sr/course/recommendations：是否导出、若不导出则插件 UI/分析侧如何补齐
- 导出稳定性：schemaVersion、向后兼容策略、rawFrontmatter 保留范围

---

> 备注：本基线文档不做“评分/展望”，只保留能落到代码与 schema 的可验证事实，方便后续做回归对照。
