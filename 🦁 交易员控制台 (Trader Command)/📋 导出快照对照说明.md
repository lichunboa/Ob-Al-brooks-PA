# 导出快照对照说明（替代 pa-db-export.json）

本文用于把旧版 `pa-db-export.json`（Engine/DataviewJS 侧导出）与新版插件导出快照（Index Snapshot）对齐，方便你做回归对照与迁移。

## 1. 新导出是什么？

- **命令**：`导出索引快照（JSON）`
- **输出路径**：`Exports/al-brooks-console/snapshot_YYYYMMDD_HHMMSS.json`
- **定位**：这是“插件侧索引快照”，用于稳定导出 **交易索引 + 统计 +（可选）策略卡索引**。

### 新快照 Schema（schemaVersion=1）

```json
{
  "meta": {
    "schemaVersion": 1,
    "exportedAt": "2026-01-01T12:34:56.000Z",
    "pluginVersion": "x.y.z"
  },
  "trades": [
    {
      "path": "Daily/Trades/....md",
      "name": "...",
      "dateIso": "YYYY-MM-DD",
      "ticker": "...",
      "pnl": 1.2,
      "outcome": "win|loss|scratch|open|unknown",
      "accountType": "Live|Demo|Backtest",
      "mtime": 1700000000000,
      "tags": ["#..."],
      "rawFrontmatter": {"...": "..."}
    }
  ],
  "statsByAccountType": {
    "All": {"countTotal": 0, "countCompleted": 0, "countWins": 0, "winRatePct": 0, "netProfit": 0},
    "Live": {"countTotal": 0, "countCompleted": 0, "countWins": 0, "winRatePct": 0, "netProfit": 0},
    "Demo": {"countTotal": 0, "countCompleted": 0, "countWins": 0, "winRatePct": 0, "netProfit": 0},
    "Backtest": {"countTotal": 0, "countCompleted": 0, "countWins": 0, "winRatePct": 0, "netProfit": 0}
  },
  "strategyIndex": {
    "count": 0,
    "cards": [{"...": "..."}]
  }
}
```

> 说明：`strategyIndex` 只有在策略索引可用时才会出现；不可用时为 `undefined`（即 JSON 里可能没有该字段）。

## 2. 字段映射（旧 → 新）

### 2.1 trades / tradesAsc

旧版：
- `trades[]`（倒序）
- `tradesAsc[]`（正序）

新版：
- 只有 `trades[]`（顺序由索引器决定，通常是按 mtime/扫描顺序；如需 asc/desc，请在分析侧排序）

单条交易字段：

| 旧字段 | 新字段 | 备注 |
|---|---|---|
| `id` 或 `link.path` | `path` | 新版统一用 `path` 作为主键 |
| `name` | `name` | 一致 |
| `date` | `dateIso` | 仍为 `YYYY-MM-DD` |
| `type` | `accountType` | 旧：`Live/Demo/Backtest`；新同名但字段名不同 |
| `pnl` | `pnl` | 一致（单位仍按你系统里定义的 R 或金额口径） |
| `r` | （无直接字段） | 新版将结果归因到 `pnl`/`outcome`，不强行保留 `r`；需要的话可在后处理里从 frontmatter 或规则重算 |
| `setup` | （可能在 `rawFrontmatter`） | 新版不承诺结构，作为调试/回退保存 |
| `error` | （可能在 `rawFrontmatter`） | 同上 |
| `ticker` | `ticker` | 一致（若索引器能读到） |

### 2.2 stats

旧版：

```json
"stats": {
  "livePnL": -16.6,
  "liveWin": 0,
  "liveCount": 1,
  "tuition": 0,
  "errors": {}
}
```

新版（等价口径）：

| 旧字段 | 新字段 |
|---|---|
| `stats.livePnL` | `statsByAccountType.Live.netProfit` |
| `stats.liveCount` | `statsByAccountType.Live.countTotal` |
| `stats.liveWin` | `statsByAccountType.Live.countWins` |
| （无） | `statsByAccountType.*.countCompleted` |
| （无） | `statsByAccountType.*.winRatePct` |

> 旧版的 `tuition/errors` 属于旧 Engine 的扩展统计；新版快照当前不包含这些聚合（如你需要，我们可以在下一轮把它们补进导出 schema 的 v2）。

### 2.3 sr（SRS/闪卡统计）

旧版：`sr`（总量/到期/复习/负载/文件列表等）

新版：**当前导出快照不包含 `sr`**。

原因：该快照定位为 **交易索引快照**（trades + stats + strategyIndex）。SRS/记忆属于另一个子系统（Memory/SRS 视图），后续如要“一份导出覆盖全部”，建议：
1) 明确要导出哪些 SRS 指标（最小可用集），
2) 升级 `schemaVersion` 到 2，
3) 在导出里加入 `memory` 或 `srs` 段。

## 3. 回归对照清单（建议）

1) `trades.length`：新旧数量是否一致（允许存在少量差异：如旧导出包含 Demo/Live 混合路径但新索引器过滤了某类路径）。
2) 按账户类型分组：
   - 旧 `type` vs 新 `accountType` 的计数是否一致。
3) PnL 汇总：
   - 旧 `trades[].pnl` 求和 ≈ 新 `statsByAccountType.All.netProfit`。
4) 最近交易抽样：
   - 随机抽 5 笔，核对 `date/dateIso`、`ticker`、`pnl`、路径是否指向同一笔记。

---

如果你希望我把 `r/setup/error/...` 这些旧字段也做成“稳定字段”（不只放 rawFrontmatter），告诉我你希望的字段清单与优先级，我可以把它们升级进下一版导出 schema。