# 导出快照对照说明（替代 pa-db-export.json）

本文用于把旧版 `pa-db-export.json`（Engine/DataviewJS 侧导出）与新版插件导出快照（Index Snapshot）对齐，方便你做回归对照与迁移。

## 1. 新导出是什么？

- **命令**：`导出索引快照（JSON）`
- **输出路径**：`Exports/al-brooks-console/snapshot_YYYYMMDD_HHMMSS.json`
- **定位**：这是“插件侧索引快照”，用于稳定导出 **交易索引 + 统计 +（可选）策略卡索引**。

补充：在不方便打开 Obsidian 的情况下，也可以用工作区脚本离线生成一份“dry-run 快照”用于校验 schema：`tools/generate-snapshot-from-legacy.js`。该文件的 `meta.pluginVersion` 会显示为 `dry-run-from-legacy`，且不会包含 `strategyIndex`（除非你后续扩展脚本）。

### 新快照 Schema（schemaVersion=2）

```json
{
  "meta": {
    "schemaVersion": 2,
    "exportedAt": "2026-01-01T12:34:56.000Z",
    "pluginVersion": "x.y.z"
  },
  "trades": [
    {
      "path": "Daily/Trades/....md",
      "name": "...",
      "dateIso": "YYYY-MM-DD",
      "ticker": "...",
      "pnl": 1.2,
      "r": 1.5,
      "setup": "...",
      "error": "...",
      "dir": "Long",
      "tf": "PT5M",
      "order": "Stop Entry",
      "signal": "Strong Bull Close",
      "plan": "Swing",
      "outcome": "win|loss|scratch|open|unknown",
      "accountType": "Live|Demo|Backtest",
      "mtime": 1700000000000,
      "tags": ["#..."],
      "rawFrontmatter": { "...": "..." }
    }
  ],
  "statsByAccountType": {
    "All": {
      "countTotal": 0,
      "countCompleted": 0,
      "countWins": 0,
      "winRatePct": 0,
      "netProfit": 0
    },
    "Live": {
      "countTotal": 0,
      "countCompleted": 0,
      "countWins": 0,
      "winRatePct": 0,
      "netProfit": 0
    },
    "Demo": {
      "countTotal": 0,
      "countCompleted": 0,
      "countWins": 0,
      "winRatePct": 0,
      "netProfit": 0
    },
    "Backtest": {
      "countTotal": 0,
      "countCompleted": 0,
      "countWins": 0,
      "winRatePct": 0,
      "netProfit": 0
    }
  },
  "strategyIndex": {
    "count": 0,
    "cards": [{ "...": "..." }]
  }
}
```

> 说明：`strategyIndex` 只有在策略索引可用时才会出现；不可用时为 `undefined`（即 JSON 里可能没有该字段）。

> 说明：`r/setup/error/dir/tf/order/signal/plan` 在 schemaVersion=2 中作为**稳定字段**输出（来自交易笔记 frontmatter 的别名提取）。

## 2. 字段映射（旧 → 新）

### 2.1 trades / tradesAsc

旧版：

- `trades[]`（倒序）
- `tradesAsc[]`（正序）

新版：

- 只有 `trades[]`（顺序由索引器决定，通常是按 mtime/扫描顺序；如需 asc/desc，请在分析侧排序）

单条交易字段：

| 旧字段              | 新字段        | 备注                                                                                                                        |
| ------------------- | ------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `id` 或 `link.path` | `path`        | 新版统一用 `path` 作为主键                                                                                                  |
| `name`              | `name`        | 一致                                                                                                                        |
| `date`              | `dateIso`     | 仍为 `YYYY-MM-DD`                                                                                                           |
| `type`              | `accountType` | 旧：`Live/Demo/Backtest`；新同名但字段名不同                                                                                |
| `pnl`               | `pnl`         | **注意口径差异（见下）**：新版索引默认从交易笔记 frontmatter 的 `pnl/net_profit/净利润` 等字段读取，并在 UI 里按 `R` 展示。 |
| `r`                 | `r`           | schemaVersion=2 起稳定输出（从 frontmatter 的 `r/R/r值` 等读取）。                                                          |
| `setup`             | `setup`       | schemaVersion=2 起稳定输出。                                                                                                |
| `error`             | `error`       | schemaVersion=2 起稳定输出（兼容 execution_quality/management_error/error）。                                               |
| `dir`               | `dir`         | schemaVersion=2 起稳定输出。                                                                                                |
| `tf`                | `tf`          | schemaVersion=2 起稳定输出。                                                                                                |
| `order`             | `order`       | schemaVersion=2 起稳定输出。                                                                                                |
| `signal`            | `signal`      | schemaVersion=2 起稳定输出。                                                                                                |
| `plan`              | `plan`        | schemaVersion=2 起稳定输出。                                                                                                |
| `ticker`            | `ticker`      | 一致（若索引器能读到）                                                                                                      |

#### 2.1.1 关键差异：`pnl` vs `r`（强烈建议你确认）

从当前实现看：

- **新版索引的 `TradeRecord.pnl` 读取来源**：交易笔记 frontmatter 中的 `pnl`/`net_profit`/`净利润(net_profit)`/`盈亏`/`收益` 等（详见插件的字段别名表）。
- **新版并不会把旧导出的 `r` 自动映射为 `pnl`**。

而你的旧 `pa-db-export.json` 同时存在 `pnl` 和 `r`，且示例里 `pnl=20`、`r=2`，这通常意味着两者不是同一口径。

所以：

- 如果你希望新版“以 R 为核心口径”（UI 里显示 `${pnl}R`），建议把交易笔记里的 **`net_profit/pnl/净利润` 统一存 R 值**；金额/点数另存一个字段（例如 `cash_pnl`/`points`），避免混淆。
- 如果你希望继续“金额口径 + 单独 R”，那新版导出 schema 最好升级到 v2：显式加入 `r` 字段（稳定输出），而不是依赖 `rawFrontmatter`。

### 2.2 stats

旧版：

```json
"stats": {
  "livePnL": -16.6,
  "liveWin": 0,
  "liveCount": 1,
  "tuition": 0,
  "errors": {}
}
```

新版（等价口径）：

| 旧字段            | 新字段                                |
| ----------------- | ------------------------------------- |
| `stats.livePnL`   | `statsByAccountType.Live.netProfit`   |
| `stats.liveCount` | `statsByAccountType.Live.countTotal`  |
| `stats.liveWin`   | `statsByAccountType.Live.countWins`   |
| （无）            | `statsByAccountType.*.countCompleted` |
| （无）            | `statsByAccountType.*.winRatePct`     |

> 旧版的 `tuition/errors` 属于旧 Engine 的扩展统计；新版快照当前不包含这些聚合（如你需要，我们可以在下一轮把它们补进导出 schema 的 v2）。

### 2.3 sr（SRS/闪卡统计）

旧版：顶层 `sr`（总量/到期/负载/文件列表/文件夹分布等）。

新版：**导出快照当前不包含 `sr`**。

对应关系：

- 新版在控制台 UI 中会计算并展示 Memory/SRS，但这是运行时快照，不会写入 `snapshot_*.json`。
- 如果你需要替代旧 `sr` 的导出能力，建议作为 `schemaVersion: 2` 的新增段，例如：`memory` 或 `srs`。

### 2.4 course（课程地图/推荐）

旧版：顶层 `course`（课程大纲/完成集合/链接表/推荐等）。

新版：**导出快照当前不包含 `course`**。

对应关系：

- 新版控制台 UI 里有 Course 模块（运行时加载并展示）；但导出仅定位为“交易索引快照”。
- 若你希望导出也覆盖课程进度，建议同样升级到 `schemaVersion: 2` 并新增 `course` 段。

### 2.5 updateTime/loadTime/isCached（缓存信息）

旧版：

- `updateTime` / `loadTime` / `isCached` 用于描述 Engine 导出/缓存状态。

新版：

- 用 `meta.exportedAt` 表示导出时间；不导出缓存状态字段。

### 2.3 sr（SRS/闪卡统计）

旧版：`sr`（总量/到期/复习/负载/文件列表等）

新版：**当前导出快照不包含 `sr`**。

原因：该快照定位为 **交易索引快照**（trades + stats + strategyIndex）。SRS/记忆属于另一个子系统（Memory/SRS 视图），后续如要“一份导出覆盖全部”，建议：

1. 明确要导出哪些 SRS 指标（最小可用集），
2. 升级 `schemaVersion` 到 2，
3. 在导出里加入 `memory` 或 `srs` 段。

## 3. 回归对照清单（建议）

1. `trades.length`：新旧数量是否一致（允许存在少量差异：如旧导出包含 Demo/Live 混合路径但新索引器过滤了某类路径）。
2. 按账户类型分组：
   - 旧 `type` vs 新 `accountType` 的计数是否一致。
3. PnL 汇总：
   - 旧 `trades[].pnl` 求和 ≈ 新 `statsByAccountType.All.netProfit`。
4. 最近交易抽样：
   - 随机抽 5 笔，核对 `date/dateIso`、`ticker`、`pnl`、路径是否指向同一笔记。

---

如果你希望我把 `r/setup/error/...` 这些旧字段也做成“稳定字段”（不只放 rawFrontmatter），告诉我你希望的字段清单与优先级，我可以把它们升级进下一版导出 schema。
