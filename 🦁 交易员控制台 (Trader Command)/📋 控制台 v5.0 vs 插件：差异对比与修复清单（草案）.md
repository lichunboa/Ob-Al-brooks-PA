# 📋 控制台 v5.0 vs 插件：差异对比与修复清单（草案）

> 目标：用“可验证”的方式列出差异，并把修复动作收敛成少量高价值改动。
> 
> - legacy：DataviewJS 控制台（`scripts/pa-core.js` + `window.paData`）
> - plugin：Al Brooks Console 插件（TradeIndex/StrategyIndex/TodayContext + React Dashboard）
> - 日期：2026-01-03

---

## 1) 数据来源与运行时差异（根因层）

### legacy（DataviewJS）

- 读取方式：Dataview 扫描 + 运行时 JS 归一化
- 结构：`window.paData`（trades/stats/strategyIndex/sr/course/daily/recommendations…）
- 容错：对缺字段、类型混乱、文件命名不规范更宽松（可以在 JS 里兜底）

### plugin（原生索引 + React 视图）

- 读取方式：Obsidian `metadataCache`（frontmatter + tags）
- 结构：`TradeRecord`（稳定最小字段） + 其他模块按需计算
- 容错：一旦识别/解析规则不完整，就会系统性偏差（例如日期与过滤）

---

## 2) trades：识别规则差异（致命）

### legacy

- 通常通过标签/路径/字段组合识别交易；并在很多查询里排除 Templates。

### plugin

- TradeIndex 规则：tag `PA/Trade` 或 fileClass 命中即可入库。
- **缺失默认排除规则**：`Templates/` 下的交易模板带 `PA/Trade` tag，会被当成真实交易。

**影响**：交易数量、列表、统计、今日筛选都会被污染。

**建议修复（优先级 P0）**：TradeIndex 默认排除 `Templates/`、`Exports/`（至少 Templates）。

---

## 3) dateIso：日期口径差异（致命）

### legacy

- 可能由 Core 在扫描时做归一化（YYYY-MM-DD），并用于 Today/Analytics。

### plugin

- dateIso：优先读 frontmatter.date，否则用 `basename.substring(0,10)`。
- 对 `251219_0036_实盘_ES.md` 这种命名，会得到 `251219_0036`（非 ISO）。

**影响**：排序、今日交易、日聚合、资金曲线、时间窗口统计全都可能错。

**建议修复（优先级 P0）**：实现 filename/path 的日期解析兜底：

- 支持 `YYMMDD_*` → `20YY-MM-DD`
- 支持 `YYYY-MM-DD_*`
- 兜底再使用 mtime 转 local date

---

## 4) pnl vs r：统计口径差异（高风险）

### legacy

- 同时存在 `pnl` 与 `r`（不一定同口径）。

### plugin

- stats 逻辑只看 `pnl` 数值正负来判胜负与净利润。
- 导出 snapshot 虽补 `r/setup/error/...`，但这些字段不参与 stats。

**建议修复（优先级 P1）**：明确插件的主口径：

- 若“以 R 为口径”：将 UI/导出字段命名与文案统一为 R（并避免把金额写入 pnl）
- 若“以金额为口径”：保留 pnl=金额，同时让 r 参与部分面板展示/分析

---

## 5) 导出命令与落盘路径差异（功能错位）

### 你当前文档的预期

- 命令：导出索引快照（JSON）
- 输出：`Exports/al-brooks-console/snapshot_*.json`

### 插件现状

- 实现了 `exportIndexSnapshot()`，但未注册为命令/未在 UI 调用
- 仅注册了 `导出旧版兼容快照`，写入 `Exports/al-brooks-console/pa-db-export.json`

### 现实里出现的 snapshot 文件

- `snapshot_*.json` 目前来自离线脚本 `tools/generate-snapshot-from-legacy.js`
- `meta.pluginVersion` 会显示 `dry-run-from-legacy`

**建议修复（优先级 P0）**：把 `exportIndexSnapshot` 注册成命令，并对齐命名。

---

## 6) 建议修复顺序（最小闭环）

P0（必须先做，否则对比/回归全失真）

1. TradeIndex 默认排除 `Templates/`
2. dateIso 解析兜底（YYMMDD → ISO；最终兜底 mtime）
3. 注册“导出索引快照（JSON）”命令并确认实际落盘

P1（再做口径与扩展）

4. 明确 pnl 与 r 的口径与 UI 文案
5. 补充导出字段（若你确实需要）：tuition/errors/sr/course（需要你确认范围）

---

## 7) 需要你确认的 2 个关键信息（否则会修错方向）

1. 你的 `净利润/net_profit/pnl` 在笔记里到底存的是：金额还是 R？
2. 真实交易笔记的“日期来源”你希望以哪个为准：frontmatter.date、文件名、还是 mtime？
