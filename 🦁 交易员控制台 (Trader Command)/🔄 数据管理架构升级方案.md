# ğŸ”„ æ•°æ®ç®¡ç†æ¶æ„å‡çº§æ–¹æ¡ˆ

> **é—®é¢˜**: ä»"è¢«åŠ¨è¯»å–"åˆ°"ä¸»åŠ¨ç®¡ç†"  
> **ç›®æ ‡**: æ’ä»¶æ§åˆ¶å°æˆä¸ºæ•°æ®çš„ä¸€çº§ç®¡ç†è€…  
> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»º**: 2026-01-11  
> **çŠ¶æ€**: ğŸŸ¡ è®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ é—®é¢˜å®šä¹‰

### å½“å‰ç—›ç‚¹

1. **æ•°æ®è§„èŒƒéš¾ä»¥ç»´æŠ¤**
   - AIæ¯æ¬¡éƒ½æƒ³è‡ªå·±æ·»åŠ å±æ€§
   - ä¸æŒ‰ç…§Templatesè§„å®šçš„æ ¼å¼
   - å±æ€§åç§°ä¸ä¸€è‡´ (ä¸­è‹±æ–‡æ··ç”¨)
   - æ•°æ®è¶Šæ¥è¶Šä¹±

2. **ä¿®æ”¹å›°éš¾**
   - åœ¨æ§åˆ¶å°çœ‹åˆ°é—®é¢˜ï¼Œéœ€è¦æ‰‹åŠ¨æ‰“å¼€ç¬”è®°ä¿®æ”¹
   - ä¿®æ”¹åå¯èƒ½ä¸ç¬¦åˆè§„èŒƒï¼Œç³»ç»Ÿä¸è¯†åˆ«
   - æ‰¹é‡ä¿®æ”¹å‡ ä¹ä¸å¯èƒ½

3. **å•å‘æ•°æ®æµçš„å±€é™**
   ```
   Markdownç¬”è®° â†’ ç´¢å¼•å±‚ â†’ æ§åˆ¶å°å±•ç¤º
   (åªèƒ½è¯»ï¼Œä¸èƒ½å†™)
   ```

---

## ğŸ¯ ç›®æ ‡æ¶æ„

### åŒå‘æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ’ä»¶æ§åˆ¶å° (ä¸€çº§ç®¡ç†è€…)                     â”‚
â”‚  - ç»Ÿä¸€çš„æ•°æ®ç¼–è¾‘ç•Œé¢                                    â”‚
â”‚  - ä¸¥æ ¼çš„æ•°æ®éªŒè¯                                        â”‚
â”‚  - å®æ—¶é¢„è§ˆ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ActionService (å†™å…¥å±‚)                      â”‚
â”‚  - æ•°æ®è§„èŒƒéªŒè¯                                          â”‚
â”‚  - Frontmatteræ›´æ–°                                       â”‚
â”‚  - æ“ä½œå†å²è®°å½•                                          â”‚
â”‚  - Dry Runæ¨¡å¼                                           â”‚
â”‚  - Undo/Redoæ”¯æŒ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Markdownç¬”è®° (æ•°æ®å­˜å‚¨)                     â”‚
â”‚  - Frontmatter (ç»“æ„åŒ–æ•°æ®)                              â”‚
â”‚  - ç¬”è®°æ­£æ–‡ (éç»“æ„åŒ–å†…å®¹)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŸåˆ™

1. **æ§åˆ¶å°ä¼˜å…ˆ** (Console-First)
   - æ‰€æœ‰æ•°æ®ä¿®æ”¹éƒ½é€šè¿‡æ§åˆ¶å°
   - æ§åˆ¶å°ä¿è¯æ•°æ®è§„èŒƒ
   - ç›´æ¥ç¼–è¾‘Markdownä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ

2. **ä¸¥æ ¼éªŒè¯** (Strict Validation)
   - åŸºäºTemplateså®šä¹‰çš„Schema
   - å®æ—¶éªŒè¯ï¼Œç«‹å³åé¦ˆ
   - ä¸ç¬¦åˆè§„èŒƒçš„æ•°æ®æ‹’ç»å†™å…¥

3. **å®‰å…¨æ“ä½œ** (Safe Operations)
   - Dry Run: é¢„è§ˆä¿®æ”¹ç»“æœ
   - Undo: æ’¤é”€æœ€è¿‘æ“ä½œ
   - æ“ä½œå†å²: å¯è¿½æº¯

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. ActionService (æ ¸å¿ƒå†™å…¥å±‚)

#### 1.1 æ¥å£è®¾è®¡

```typescript
interface ActionService {
  // å•ä¸ªäº¤æ˜“æ›´æ–°
  updateTrade(
    path: string,
    updates: Partial<TradeRecord>,
    options?: ActionOptions
  ): Promise<ActionResult>;
  
  // æ‰¹é‡æ›´æ–°
  batchUpdateTrades(
    updates: Array<{ path: string; updates: Partial<TradeRecord> }>,
    options?: ActionOptions
  ): Promise<BatchActionResult>;
  
  // åˆ›å»ºæ–°äº¤æ˜“
  createTrade(
    data: TradeRecord,
    options?: CreateOptions
  ): Promise<ActionResult>;
  
  // åˆ é™¤äº¤æ˜“
  deleteTrade(
    path: string,
    options?: ActionOptions
  ): Promise<ActionResult>;
  
  // ç­–ç•¥ç®¡ç†
  updateStrategy(
    path: string,
    updates: Partial<StrategyCard>
  ): Promise<ActionResult>;
  
  createStrategy(
    data: StrategyCard
  ): Promise<ActionResult>;
}

interface ActionOptions {
  dryRun?: boolean;      // ä»…é¢„è§ˆï¼Œä¸å®é™…ä¿®æ”¹
  validate?: boolean;    // æ˜¯å¦éªŒè¯ (é»˜è®¤true)
  recordHistory?: boolean; // æ˜¯å¦è®°å½•å†å² (é»˜è®¤true)
}

interface ActionResult {
  success: boolean;
  message: string;
  changes?: {
    before: Record<string, unknown>;
    after: Record<string, unknown>;
  };
  errors?: ValidationError[];
}
```

#### 1.2 æ•°æ®éªŒè¯å™¨

```typescript
interface SchemaValidator {
  // éªŒè¯å•ä¸ªå­—æ®µ
  validateField(
    fieldName: string,
    value: unknown,
    schema: FieldSchema
  ): ValidationResult;
  
  // éªŒè¯æ•´ä¸ªè®°å½•
  validateRecord(
    record: Partial<TradeRecord>,
    schema: RecordSchema
  ): ValidationResult;
  
  // è·å–å­—æ®µSchema
  getFieldSchema(fieldName: string): FieldSchema;
}

interface FieldSchema {
  type: "string" | "number" | "enum" | "array" | "date";
  required?: boolean;
  enum?: string[];        // æšä¸¾å€¼
  min?: number;           // æœ€å°å€¼
  max?: number;           // æœ€å¤§å€¼
  pattern?: RegExp;       // æ­£åˆ™éªŒè¯
  aliases?: string[];     // å­—æ®µåˆ«å
  canonicalName: string;  // è§„èŒƒåç§°
}

// ç¤ºä¾‹Schemaå®šä¹‰
const TRADE_SCHEMA: RecordSchema = {
  date: {
    type: "date",
    required: true,
    canonicalName: "æ—¥æœŸ/date",
    aliases: ["date", "æ—¥æœŸ", "äº¤æ˜“æ—¥æœŸ"]
  },
  pnl: {
    type: "number",
    required: true,
    canonicalName: "ç›ˆäº/net_profit",
    aliases: ["pnl", "net_profit", "r", "ç›ˆäº"]
  },
  outcome: {
    type: "enum",
    required: true,
    enum: ["win", "loss", "scratch", "open"],
    canonicalName: "ç»“æœ/outcome",
    aliases: ["outcome", "ç»“æœ"]
  },
  accountType: {
    type: "enum",
    required: true,
    enum: ["Live", "Demo", "Backtest"],
    canonicalName: "è´¦æˆ·ç±»å‹/account_type",
    aliases: ["accountType", "account_type", "è´¦æˆ·ç±»å‹"]
  },
  // ... å…¶ä»–å­—æ®µ
};
```

#### 1.3 Frontmatteræ›´æ–°å™¨

```typescript
class FrontmatterUpdater {
  /**
   * æ›´æ–°Frontmatterï¼Œä¿æŒæ ¼å¼å’Œæ³¨é‡Š
   */
  async updateFrontmatter(
    file: TFile,
    updates: Record<string, unknown>,
    options: UpdateOptions
  ): Promise<void> {
    // 1. è¯»å–æ–‡ä»¶å†…å®¹
    const content = await this.app.vault.read(file);
    
    // 2. è§£æFrontmatter
    const { frontmatter, body } = this.parseFrontmatter(content);
    
    // 3. åº”ç”¨æ›´æ–° (ä½¿ç”¨è§„èŒƒåç§°)
    const updated = this.applyUpdates(frontmatter, updates);
    
    // 4. éªŒè¯æ›´æ–°åçš„æ•°æ®
    if (options.validate) {
      const validation = this.validator.validateRecord(updated, TRADE_SCHEMA);
      if (!validation.valid) {
        throw new ValidationError(validation.errors);
      }
    }
    
    // 5. åºåˆ—åŒ–Frontmatter
    const newContent = this.serializeFrontmatter(updated, body);
    
    // 6. å†™å…¥æ–‡ä»¶
    if (!options.dryRun) {
      await this.app.vault.modify(file, newContent);
    }
  }
  
  /**
   * åº”ç”¨æ›´æ–°æ—¶ä½¿ç”¨è§„èŒƒåç§°
   */
  private applyUpdates(
    frontmatter: Record<string, unknown>,
    updates: Record<string, unknown>
  ): Record<string, unknown> {
    const result = { ...frontmatter };
    
    for (const [key, value] of Object.entries(updates)) {
      const schema = this.validator.getFieldSchema(key);
      if (schema) {
        // ä½¿ç”¨è§„èŒƒåç§°
        result[schema.canonicalName] = value;
        
        // åˆ é™¤æ—§çš„åˆ«å (é¿å…é‡å¤)
        for (const alias of schema.aliases || []) {
          if (alias !== schema.canonicalName) {
            delete result[alias];
          }
        }
      } else {
        // æœªå®šä¹‰çš„å­—æ®µï¼Œä¿æŒåŸæ ·
        result[key] = value;
      }
    }
    
    return result;
  }
}
```

### 2. æ“ä½œå†å²ä¸æ’¤é”€

#### 2.1 æ“ä½œå†å²è®°å½•

```typescript
interface OperationHistory {
  id: string;
  timestamp: number;
  type: "update" | "create" | "delete";
  target: string;  // æ–‡ä»¶è·¯å¾„
  changes: {
    before: Record<string, unknown>;
    after: Record<string, unknown>;
  };
  user: string;    // æ“ä½œè€… (AI/User)
}

class HistoryManager {
  private history: OperationHistory[] = [];
  private maxHistory = 100;
  
  record(operation: OperationHistory): void {
    this.history.unshift(operation);
    if (this.history.length > this.maxHistory) {
      this.history.pop();
    }
  }
  
  async undo(operationId: string): Promise<void> {
    const op = this.history.find(h => h.id === operationId);
    if (!op) throw new Error("Operation not found");
    
    // æ¢å¤åˆ°beforeçŠ¶æ€
    await this.actionService.updateTrade(
      op.target,
      op.changes.before,
      { recordHistory: false }  // é¿å…å¾ªç¯è®°å½•
    );
  }
  
  getHistory(limit: number = 20): OperationHistory[] {
    return this.history.slice(0, limit);
  }
}
```

### 3. UIäº¤äº’è®¾è®¡

#### 3.1 å±æ€§ç¼–è¾‘å™¨ (Property Editor)

```typescript
interface PropertyEditorProps {
  trade: TradeRecord;
  onSave: (updates: Partial<TradeRecord>) => Promise<void>;
  onCancel: () => void;
}

function PropertyEditor({ trade, onSave, onCancel }: PropertyEditorProps) {
  const [formData, setFormData] = useState(trade);
  const [errors, setErrors] = useState<ValidationError[]>([]);
  const [preview, setPreview] = useState<ActionResult | null>(null);
  
  // å®æ—¶éªŒè¯
  useEffect(() => {
    const validation = validator.validateRecord(formData, TRADE_SCHEMA);
    setErrors(validation.errors || []);
  }, [formData]);
  
  // Dry Runé¢„è§ˆ
  const handlePreview = async () => {
    const result = await actionService.updateTrade(
      trade.path,
      formData,
      { dryRun: true }
    );
    setPreview(result);
  };
  
  // ä¿å­˜
  const handleSave = async () => {
    if (errors.length > 0) {
      new Notice("è¯·å…ˆä¿®æ­£éªŒè¯é”™è¯¯");
      return;
    }
    
    await onSave(formData);
  };
  
  return (
    <div className="property-editor">
      {/* å­—æ®µç¼–è¾‘è¡¨å• */}
      <FieldEditor
        schema={TRADE_SCHEMA}
        data={formData}
        onChange={setFormData}
        errors={errors}
      />
      
      {/* é¢„è§ˆæŒ‰é’® */}
      <Button onClick={handlePreview}>é¢„è§ˆä¿®æ”¹</Button>
      
      {/* é¢„è§ˆç»“æœ */}
      {preview && (
        <PreviewPanel changes={preview.changes} />
      )}
      
      {/* ä¿å­˜/å–æ¶ˆ */}
      <Button onClick={handleSave} disabled={errors.length > 0}>
        ä¿å­˜
      </Button>
      <Button onClick={onCancel}>å–æ¶ˆ</Button>
    </div>
  );
}
```

#### 3.2 æ‰¹é‡ç¼–è¾‘å™¨ (Batch Editor)

```typescript
interface BatchEditorProps {
  trades: TradeRecord[];
  onSave: (updates: BatchUpdate[]) => Promise<void>;
}

function BatchEditor({ trades, onSave }: BatchEditorProps) {
  const [selectedTrades, setSelectedTrades] = useState<string[]>([]);
  const [batchUpdates, setBatchUpdates] = useState<Partial<TradeRecord>>({});
  
  const handleBatchUpdate = async () => {
    const updates = selectedTrades.map(path => ({
      path,
      updates: batchUpdates
    }));
    
    // Dry Runé¢„è§ˆ
    const result = await actionService.batchUpdateTrades(
      updates,
      { dryRun: true }
    );
    
    // æ˜¾ç¤ºé¢„è§ˆï¼Œç¡®è®¤åæ‰§è¡Œ
    if (await confirmBatchUpdate(result)) {
      await onSave(updates);
    }
  };
  
  return (
    <div className="batch-editor">
      {/* äº¤æ˜“é€‰æ‹© */}
      <TradeSelector
        trades={trades}
        selected={selectedTrades}
        onSelect={setSelectedTrades}
      />
      
      {/* æ‰¹é‡ä¿®æ”¹å­—æ®µ */}
      <FieldEditor
        schema={TRADE_SCHEMA}
        data={batchUpdates}
        onChange={setBatchUpdates}
        mode="batch"
      />
      
      {/* åº”ç”¨æŒ‰é’® */}
      <Button onClick={handleBatchUpdate}>
        åº”ç”¨åˆ° {selectedTrades.length} ç¬”äº¤æ˜“
      </Button>
    </div>
  );
}
```

---

## ğŸ”’ æ•°æ®è§„èŒƒå¼ºåˆ¶æ‰§è¡Œ

### 1. Schemaå®šä¹‰æ¥æº

**ä¼˜å…ˆçº§**:
1. **Templatesä¸­çš„Schemaå®šä¹‰** (æœ€é«˜ä¼˜å…ˆçº§)
   - ä»Templatesæ–‡ä»¶å¤¹è¯»å–æ ‡å‡†æ¨¡æ¿
   - æå–Frontmatterå­—æ®µå®šä¹‰
   - ä½œä¸ºSchemaçš„æƒå¨æ¥æº

2. **ä»£ç ä¸­çš„FIELD_ALIASES** (å…¼å®¹æ€§)
   - ç”¨äºè¯†åˆ«æ—§æ•°æ®
   - è‡ªåŠ¨è½¬æ¢ä¸ºè§„èŒƒåç§°

3. **ç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•** (å¯é€‰)
   - å…è®¸ç”¨æˆ·æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
   - ä½†å¿…é¡»ç¬¦åˆå‘½åè§„èŒƒ

### 2. è‡ªåŠ¨è§„èŒƒåŒ–

```typescript
class SchemaEnforcer {
  /**
   * è‡ªåŠ¨è§„èŒƒåŒ–å­—æ®µå
   */
  normalizeFieldNames(
    frontmatter: Record<string, unknown>
  ): Record<string, unknown> {
    const normalized: Record<string, unknown> = {};
    
    for (const [key, value] of Object.entries(frontmatter)) {
      const schema = this.getFieldSchema(key);
      if (schema) {
        // ä½¿ç”¨è§„èŒƒåç§°
        normalized[schema.canonicalName] = value;
      } else {
        // æœªå®šä¹‰å­—æ®µï¼Œä¿æŒåŸæ ·ä½†å‘å‡ºè­¦å‘Š
        console.warn(`Unknown field: ${key}`);
        normalized[key] = value;
      }
    }
    
    return normalized;
  }
  
  /**
   * æ£€æµ‹å¹¶ä¿®å¤ä¸è§„èŒƒçš„æ•°æ®
   */
  async auditAndFix(trades: TradeRecord[]): Promise<AuditReport> {
    const issues: Issue[] = [];
    const fixes: Fix[] = [];
    
    for (const trade of trades) {
      // æ£€æŸ¥å­—æ®µåæ˜¯å¦è§„èŒƒ
      const fm = trade.rawFrontmatter;
      for (const key of Object.keys(fm)) {
        const schema = this.getFieldSchema(key);
        if (schema && key !== schema.canonicalName) {
          issues.push({
            path: trade.path,
            field: key,
            issue: "éè§„èŒƒå­—æ®µå",
            suggestion: schema.canonicalName
          });
          
          fixes.push({
            path: trade.path,
            action: "rename",
            from: key,
            to: schema.canonicalName
          });
        }
      }
      
      // æ£€æŸ¥å¿…å¡«å­—æ®µ
      for (const [fieldName, schema] of Object.entries(TRADE_SCHEMA)) {
        if (schema.required && !fm[schema.canonicalName]) {
          issues.push({
            path: trade.path,
            field: fieldName,
            issue: "ç¼ºå°‘å¿…å¡«å­—æ®µ"
          });
        }
      }
    }
    
    return { issues, fixes };
  }
}
```

---

## âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: å¹¶å‘ä¿®æ”¹å†²çª

**åœºæ™¯**: ç”¨æˆ·åœ¨æ§åˆ¶å°ä¿®æ”¹çš„åŒæ—¶ï¼Œç›´æ¥ç¼–è¾‘äº†Markdownæ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```typescript
class ConflictResolver {
  async detectConflict(
    file: TFile,
    expectedMtime: number
  ): Promise<boolean> {
    const currentMtime = file.stat.mtime;
    return currentMtime !== expectedMtime;
  }
  
  async resolveConflict(
    file: TFile,
    ourChanges: Record<string, unknown>,
    theirChanges: Record<string, unknown>
  ): Promise<ResolveResult> {
    // ç­–ç•¥1: æœ€åå†™å…¥è·èƒœ (Last Write Wins)
    // ç­–ç•¥2: å­—æ®µçº§åˆå¹¶ (Field-level Merge)
    // ç­–ç•¥3: æç¤ºç”¨æˆ·é€‰æ‹© (User Choice)
    
    return {
      strategy: "user-choice",
      prompt: "æ£€æµ‹åˆ°å†²çªï¼Œè¯·é€‰æ‹©ä¿ç•™å“ªä¸ªç‰ˆæœ¬"
    };
  }
}
```

### é—®é¢˜2: å¤§æ‰¹é‡æ“ä½œæ€§èƒ½

**åœºæ™¯**: æ‰¹é‡ä¿®æ”¹1000+ç¬”äº¤æ˜“

**è§£å†³æ–¹æ¡ˆ**:
```typescript
class BatchProcessor {
  async processBatch(
    updates: BatchUpdate[],
    options: BatchOptions
  ): Promise<BatchResult> {
    const chunkSize = 50;  // æ¯æ‰¹50ä¸ª
    const results: ActionResult[] = [];
    
    for (let i = 0; i < updates.length; i += chunkSize) {
      const chunk = updates.slice(i, i + chunkSize);
      
      // å¹¶è¡Œå¤„ç†ä¸€æ‰¹
      const chunkResults = await Promise.all(
        chunk.map(u => this.processOne(u))
      );
      
      results.push(...chunkResults);
      
      // è¿›åº¦é€šçŸ¥
      this.notifyProgress(i + chunk.length, updates.length);
      
      // è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡UI
      await new Promise(r => setTimeout(r, 0));
    }
    
    return { results, total: updates.length };
  }
}
```

### é—®é¢˜3: Schemaå˜æ›´è¿ç§»

**åœºæ™¯**: Templatesä¸­çš„Schemaå®šä¹‰å˜æ›´äº†

**è§£å†³æ–¹æ¡ˆ**:
```typescript
class SchemaMigrator {
  async migrate(
    fromVersion: string,
    toVersion: string
  ): Promise<MigrationResult> {
    const migrations = this.getMigrations(fromVersion, toVersion);
    
    for (const migration of migrations) {
      await this.applyMigration(migration);
    }
    
    return { success: true, migratedCount: migrations.length };
  }
  
  private async applyMigration(
    migration: Migration
  ): Promise<void> {
    // ç¤ºä¾‹: å­—æ®µé‡å‘½å
    if (migration.type === "rename-field") {
      await this.batchUpdateTrades(
        trades => trades.map(t => ({
          path: t.path,
          updates: {
            [migration.newName]: t[migration.oldName]
          }
        }))
      );
    }
  }
}
```

---

## ğŸ“‹ å®æ–½è·¯çº¿å›¾

### ğŸ¯ å®æ–½ä¼˜å…ˆçº§å†³ç­–

**å†³ç­–**: **ä¼˜å…ˆå®æ–½ActionService** â­â­â­â­â­

**ç†ç”±**:
1. âœ… æ•°æ®è§„èŒƒé—®é¢˜æ˜¯**å½“å‰æœ€ç—›çš„ç—›ç‚¹**
2. âœ… ActionServiceæ˜¯**ç‹¬ç«‹æ¨¡å—**ï¼Œå¯åœ¨`src/core/`å¼€å‘
3. âœ… ä¸ä¾èµ–Dashboardæ¶æ„é‡æ„
4. âœ… å¼€å‘å®Œæˆåï¼Œæ¶æ„é‡æ„æ—¶æ›´å®‰å…¨ï¼ˆæœ‰æ•°æ®éªŒè¯ä¿æŠ¤ï¼‰
5. âœ… ç”¨æˆ·ç«‹å³è·å¾—ä»·å€¼

**æ‰§è¡Œè·¯çº¿**:
```
Week 1-3: å¼€å‘ActionService (ç‹¬ç«‹æ¨¡å—)
Week 4-5: é›†æˆåˆ°ç°æœ‰UI (å±æ€§ç®¡ç†å™¨å‡çº§)
Week 6+: ç»§ç»­æ¶æ„é‡æ„ (æœ‰ActionServiceä¿æŠ¤æ•°æ®è´¨é‡)
```

---

### Phase 1: æ ¸å¿ƒActionService (Week 1-2)

**ç›®æ ‡**: å»ºç«‹å®‰å…¨çš„æ•°æ®å†™å…¥èƒ½åŠ›

- [ ] 1.1 å®ç°ActionServiceæ ¸å¿ƒæ¥å£
  - `updateTrade()` - å•ä¸ªäº¤æ˜“æ›´æ–°
  - `batchUpdateTrades()` - æ‰¹é‡æ›´æ–°
  - `createTrade()` - åˆ›å»ºæ–°äº¤æ˜“
  - `deleteTrade()` - åˆ é™¤äº¤æ˜“
  
- [ ] 1.2 å®ç°SchemaValidator
  - æ ¸å¿ƒå­—æ®µSchemaå®šä¹‰ï¼ˆä»£ç ä¸­ï¼‰
  - å­—æ®µç±»å‹éªŒè¯
  - å¿…å¡«å­—æ®µæ£€æŸ¥
  - æšä¸¾å€¼éªŒè¯
  
- [ ] 1.3 å®ç°FrontmatterUpdater
  - å®‰å…¨è¯»å†™Frontmatter
  - å­—æ®µåè§„èŒƒåŒ–
  - ä¿æŒæ ¼å¼å’Œæ³¨é‡Š
  
- [ ] 1.4 å•å…ƒæµ‹è¯•
  - éªŒè¯é€»è¾‘æµ‹è¯•
  - æ›´æ–°é€»è¾‘æµ‹è¯•
  - è¾¹ç•Œæƒ…å†µæµ‹è¯•

**äº¤ä»˜ç‰©**: `src/core/action-service.ts` å¯ç”¨

---

### Phase 2: å®‰å…¨æœºåˆ¶ä¸æ—¥å¿— (Week 2-3)

**ç›®æ ‡**: ç¡®ä¿æ“ä½œå®‰å…¨å¯è¿½æº¯

- [ ] 2.1 å®ç°Dry Runæ¨¡å¼
  - é¢„è§ˆä¿®æ”¹ç»“æœ
  - ä¸å®é™…å†™å…¥æ–‡ä»¶
  
- [ ] 2.2 å®ç°ä¿®æ”¹è®°å½•æ—¥å¿— â­
  ```typescript
  interface ChangeLog {
    timestamp: string;
    operator: "User" | "AI" | "System";
    action: "create" | "update" | "delete";
    target: string;
    changes: { field, before, after }[];
    reason?: string;
    result: "success" | "failed";
    error?: string;
  }
  ```
  - è®°å½•æ‰€æœ‰ä¿®æ”¹æ“ä½œ
  - å¯¼å‡ºæ—¥å¿—åŠŸèƒ½ï¼ˆç”¨äºAIåˆ†æï¼‰
  - æ—¥å¿—æŸ¥çœ‹å™¨UI
  
- [ ] 2.3 å®ç°UndoåŠŸèƒ½
  - åŸºäºChangeLogå›æ»š
  - æ”¯æŒæ’¤é”€æœ€è¿‘Næ¬¡æ“ä½œ
  
- [ ] 2.4 å†²çªæ£€æµ‹ä¸è§£å†³
  - æ£€æµ‹æ–‡ä»¶mtimeå˜åŒ–
  - æç¤ºç”¨æˆ·é€‰æ‹©ä¿ç•™å“ªä¸ªç‰ˆæœ¬

**äº¤ä»˜ç‰©**: å®‰å…¨çš„ActionService + å®Œæ•´æ—¥å¿—ç³»ç»Ÿ

---

### Phase 3: å±æ€§ç®¡ç†å™¨å‡çº§ (Week 4)

**ç›®æ ‡**: å¢å¼ºç°æœ‰å±æ€§ç®¡ç†å™¨

- [ ] 3.1 é›†æˆActionService
  - æ›¿æ¢ç°æœ‰ä¿®æ”¹é€»è¾‘
  - æ·»åŠ SchemaéªŒè¯
  
- [ ] 3.2 å¢å¼ºç¼–è¾‘åŠŸèƒ½
  - å†…è”ç¼–è¾‘
  - æ‰¹é‡ç¼–è¾‘
  - å­—æ®µè‡ªåŠ¨è¡¥å…¨
  
- [ ] 3.3 é¢„è§ˆé¢æ¿
  - Dry Runç»“æœå±•ç¤º
  - Before/Afterå¯¹æ¯”
  
- [ ] 3.4 æ“ä½œå†å²é¢æ¿
  - æ˜¾ç¤ºæœ€è¿‘ä¿®æ”¹
  - UndoæŒ‰é’®
  - å¯¼å‡ºæ—¥å¿—

**äº¤ä»˜ç‰©**: å‡çº§ç‰ˆå±æ€§ç®¡ç†å™¨

---

### Phase 4: æ‰©å±•åˆ°å…¶ä»–æ•°æ®ç±»å‹ (Week 5)

**ç›®æ ‡**: ç®¡ç†ç­–ç•¥ã€æ¨¡æ¿ç­‰å…¶ä»–æ•°æ®

- [ ] 4.1 ç­–ç•¥æ•°æ®ç®¡ç†
  ```typescript
  actionService.createStrategy(data);
  actionService.updateStrategy(path, updates);
  actionService.deleteStrategy(path);
  ```
  
- [ ] 4.2 æ¨¡æ¿æ•°æ®ç®¡ç†
  - ç®¡ç†Templatesæ–‡ä»¶å¤¹
  - ä¿®æ”¹æ¨¡æ¿å­—æ®µå®šä¹‰
  
- [ ] 4.3 ç»Ÿä¸€æ•°æ®ç®¡ç†ç•Œé¢
  ```
  æ•°æ®ç®¡ç†ä¸­å¿ƒ
  â”œâ”€â”€ äº¤æ˜“æ•°æ® (Trade Data)
  â”œâ”€â”€ ç­–ç•¥æ•°æ® (Strategy Data)
  â”œâ”€â”€ æ¨¡æ¿æ•°æ® (Template Data)
  â””â”€â”€ ä¿®æ”¹æ—¥å¿— (Change Logs)
  ```

**äº¤ä»˜ç‰©**: ç»Ÿä¸€çš„æ•°æ®ç®¡ç†ä¸­å¿ƒ

---

### Phase 5: SchemaåŠ¨æ€æ‰©å±• (Week 6)

**ç›®æ ‡**: æ”¯æŒä»Templatesè¯»å–Schemaæ‰©å±•

- [ ] 5.1 Templates Schemaè¯»å–å™¨
  - è§£æTemplatesä¸­çš„å­—æ®µå®šä¹‰
  - æå–å­—æ®µç±»å‹å’Œçº¦æŸ
  
- [ ] 5.2 Schemaåˆå¹¶é€»è¾‘
  - ä»£ç Schemaï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
  - Templates Schemaï¼ˆæ‰©å±•å­—æ®µï¼‰
  - åˆå¹¶ç­–ç•¥ï¼šä»£ç ä¼˜å…ˆï¼ŒTemplatesæ‰©å±•
  
- [ ] 5.3 è‡ªåŠ¨è§„èŒƒåŒ–å·¥å…·
  - æ‰«ææ‰€æœ‰ç¬”è®°
  - æ£€æµ‹ä¸è§„èŒƒå­—æ®µ
  - æ‰¹é‡ä¿®å¤
  
- [ ] 5.4 Schemaè¿ç§»å·¥å…·
  - å­—æ®µé‡å‘½å
  - å­—æ®µç±»å‹è½¬æ¢
  - æ‰¹é‡è¿ç§»

**äº¤ä»˜ç‰©**: åŠåŠ¨æ€Schemaç³»ç»Ÿ

---

### Phase 6: æµ‹è¯•ä¸ä¼˜åŒ– (Week 7)

- [ ] 6.1 é›†æˆæµ‹è¯•
  - ç«¯åˆ°ç«¯æµ‹è¯•
  - æ€§èƒ½æµ‹è¯•
  
- [ ] 6.2 æ€§èƒ½ä¼˜åŒ–
  - æ‰¹é‡æ“ä½œä¼˜åŒ–
  - ç¼“å­˜ç­–ç•¥
  
- [ ] 6.3 ç”¨æˆ·æ–‡æ¡£
  - ä½¿ç”¨æŒ‡å—
  - æœ€ä½³å®è·µ
  
- [ ] 6.4 å‘å¸ƒv2.1.0
  - ç‰ˆæœ¬è¯´æ˜
  - è¿ç§»æŒ‡å—

**äº¤ä»˜ç‰©**: ç¨³å®šçš„v2.1.0ç‰ˆæœ¬

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

1. **æ•°æ®è§„èŒƒæ€§**
   - âœ… æ‰€æœ‰æ–°å¢/ä¿®æ”¹çš„æ•°æ®éƒ½ç¬¦åˆSchema
   - âœ… å­—æ®µåç»Ÿä¸€ä½¿ç”¨è§„èŒƒåç§°
   - âœ… æ—§æ•°æ®è‡ªåŠ¨è§„èŒƒåŒ–

2. **ç”¨æˆ·ä½“éªŒ**
   - âœ… åœ¨æ§åˆ¶å°ç›´æ¥ç¼–è¾‘å±æ€§
   - âœ… å®æ—¶éªŒè¯ï¼Œå³æ—¶åé¦ˆ
   - âœ… æ‰¹é‡æ“ä½œç®€å•é«˜æ•ˆ

3. **å®‰å…¨æ€§**
   - âœ… Dry Runé¢„è§ˆä¿®æ”¹
   - âœ… æ“ä½œå¯æ’¤é”€
   - âœ… å†²çªè‡ªåŠ¨æ£€æµ‹

4. **æ€§èƒ½**
   - âœ… å•ä¸ªä¿®æ”¹ < 100ms
   - âœ… æ‰¹é‡ä¿®æ”¹1000ç¬” < 10s
   - âœ… UIä¸é˜»å¡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ğŸ“‹ æ’ä»¶åŠŸèƒ½ä¼˜åŒ–-ä¸»ä»»åŠ¡åˆ—è¡¨ - Phase 1.1](./ğŸ“‹%20æ’ä»¶åŠŸèƒ½ä¼˜åŒ–-ä¸»ä»»åŠ¡åˆ—è¡¨.md#phase-1-æ ¸å¿ƒæ¶æ„ä¸å…¨å±€ä¼˜åŒ–)
- [ğŸ“Š æ•°æ®é€»è¾‘æ¶æ„æ–‡æ¡£](./ğŸ“Š%20æ•°æ®é€»è¾‘æ¶æ„æ–‡æ¡£.md)
- [ğŸ¯ æ’ä»¶ä¼˜åŒ–é¡¹ç›®-ç›®æ ‡æ¶æ„](./ğŸ¯%20æ’ä»¶ä¼˜åŒ–é¡¹ç›®-ç›®æ ‡æ¶æ„.md)

---

**åˆ›å»º**: Antigravity Agent  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: ğŸŸ¡ è®¾è®¡é˜¶æ®µï¼Œå¾…è¯„å®¡
