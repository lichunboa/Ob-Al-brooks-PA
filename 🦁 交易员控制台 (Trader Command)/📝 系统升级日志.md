# 📝 系统升级日志 (System Changelog)

> [!info] 日志说明
> 本文档记录交易员控制台系统的所有重要更新、功能变更、Bug 修复等。
> 遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范: 主版本.次版本.修订号

---

## 🧩 v4.2.6 (2025-12-25)

### 🧠 单一信源联动底座：Core 统一取数 + 稳定聚合口径

**类型**: Architecture (架构) & Consistency (一致性) & Bug Fix (修复)

#### 核心引擎 (Core Engine)

- 🧩 **Raw 展示 + Stable Key 聚合**：交易字段展示保留原始中英写法，同时输出 `*Key`（如 `tickerKey/tfKey/setupKey/marketCycleKey/strategyKey`）用于统计/联动，避免未来升级导致旧笔记检索与统计口径漂移。
- 📚 **课程大纲解析加固**：`PA_Syllabus_Data.md` 优先解析 ```json 代码块，失败再兜底旧的 `[` `]` 截取，支持未来在文件中追加正文/链接不破坏解析。
- 📅 **新增 Daily 日记上下文**：输出 `window.paData.daily.todayJournal`（含 `market_cycle` 等），视图不再需要各自扫描 `Daily`。
- 🗂️ **新增交易聚合索引**：输出 `window.paData.index`（按 `*Key` 分组 + labels + counts），所有模块可直接复用同一套分组/统计结果。

#### 视图层 (Views)

- 🔒 **彻底收敛策略映射来源**：Analytics/Inspector 不再兜底扫描策略仓库，只消费 `window.paData.strategyIndex`，杜绝“同一策略两套口径”。
- 🔁 **Today / Trading Hub / Playbook / Cycle 改为只读 paData**：移除对 `dv.pages("Daily")/dv.pages("Daily/Trades")/dv.page()` 的依赖，统一从引擎数据渲染（UI 不变）。

#### 配置 (Config)

- 🎨 **主题色键兼容**：补齐 `cfg.colors.sub/purple/danger/warn/success` 等别名映射，修复部分视图引用缺失颜色键导致的 `undefined` 样式问题。

## 🧩 v4.2.5 (2025-12-25)

### 🧾 模板笔记化精简 + 封面自动写入 + 控制台旧文档归档

**类型**: UX (体验) & Consistency (一致性) & Maintenance (维护)

- ✂️ **三个模板精简为“更像笔记”**：去除不必要的说明性 callout，正文以条目为主；已在属性填写的内容，正文侧以“结果/摘要/自动计算”呈现。
- 🖼️ **封面/cover 自动化**：当 `封面/cover` 为空时，会从 `<!--PA_COVER_SOURCE-->` 锚点下方提取第一张图片并写入 frontmatter（不覆盖已有值）。
- 📘 **新增统一说明文档**：在控制台文件夹新增模板与字段说明，集中记录封面规则、字段约定、SR 语法。
- 🧹 **旧技术报告归档**：将 `📋 系统技术报告 v4.0.md` 移入 `_archive/`，避免与 v5 文档混淆。
- 🧩 **版本控制降噪**：Make.md 的 `.makemd/*.mdc` 属于插件缓存/状态文件，已建议从版本控制排除。

## 🧩 v4.2.4 (2025-12-25)

### 🛡️ 管理模块写入安全网 + 数据中心策略识别统一

**类型**: Safety Fix (安全修复) & Consistency (一致性)

#### 管理模块 (Manager)

- 🧯 **批量写入更安全**:
  - `RENAME_KEY` 现在避免覆盖已存在字段（目标 key 已存在时会跳过并在控制台记录）。
  - `UPDATE_VAL / APPEND_VAL / DELETE_VAL / INJECT_PROP` 按“实际发生变更”计数，不再出现“无变化但计数增加”。
  - 更稳健的 `normalizeVal()`：对 frontmatter 中的 Link/Object 值避免落成 `"[object Object]"` 导致误匹配。
  - 批处理失败文件会汇总提示（并输出到控制台），避免单文件异常导致你误以为系统“整体崩了”。

#### 数据中心 (Analytics Hub)

- 🧠 **策略识别复用 Core 的 strategyIndex（单一信源）**:
  - 优先使用 `window.paData.strategyIndex.lookup/byPattern`，减少重复扫描与口径漂移。
  - 不再强行剥离括号英文，策略显示更稳定（支持中英混用场景）。

## 🧩 v4.2.3 (2025-12-25)

### 🗂️ 策略仓库体验修复：中英一致 + 小卡片 + 阅读模式可展开

**类型**: UX Fix (体验修复) & Data Fix (数据修复)

#### 核心引擎 (Core Engine)

- 🧠 **策略索引保留双语字段**:
  - 修复了策略索引在读取 `策略名称/strategy_name` 时被 `getStr()` 清洗成纯英文的问题。
  - 现在策略索引会保留 `中文 (English)` 原始格式，英文别名也能正确映射回双语标准名。
- 🧹 **排除非策略说明页**:
  - 仅收录真正“策略卡片”（有 `策略名称/strategy_name` 或明确策略标记），排除方案说明/索引页被统计为策略的误入。

#### 策略仓库 (Strategy Repository)

- 🧩 **按市场周期字段分组**:
  - 分组逻辑改为按策略卡 `市场周期/market_cycle` 分组（取第一项为主周期），避免关键词匹配造成的错分/重复。
- 🃏 **列表改为网格小卡片**:
  - 分组内由纵向长条列表改为自适应网格小卡片，减少占屏。
- 📖 **阅读模式可展开**:
  - 卡片展开机制从自定义 `onclick` 改为原生 `<details>/<summary>`，阅读模式也可正常展开。
- 🔗 **链接可打开性增强**:
  - 内链统一补充 `data-href` + `encodeURI(path)`，提升中文路径/空格路径的打开稳定性。
- 🐛 **展开失效修复**:
  - 修复部分卡片因 DOM `id` 冲突导致“从第 N 个开始展不开”的问题，改为基于路径哈希生成唯一 id。

#### 全景巡检仪 (Inspector)

- 🧾 **Raw Data 周期显示修复**:
  - `PT5M / M5 / H1 / D1` 等周期代码在 Raw Data 中不再显示为“待补充/…”，改为 `5分钟/PT5M` 等双语格式。

## � v4.2.2 (2025-12-24)

### 🧠 数据中心逻辑对齐与汉化 (Data Center Alignment & Localization)

**类型**: Logic Fix (逻辑修复) & Localization (汉化)

#### 数据中心 (Analytics Hub)

- 🧠 **策略识别逻辑对齐**:
  - 更新了 `pa-view-hub-analytics.js` 的策略识别算法，使其与巡检仪 (Inspector) 保持一致。
  - **优先级调整**: 优先读取显式的 `strategy_name`，其次是 `patterns` 匹配，最后是 `setup` 类别。解决了"热门策略"显示为宽泛类别 (如 "Trend Pullback") 而非具体策略 (如 "20 均线缺口") 的问题。
- 🌐 **智能汉化映射**:
  - 引入了策略名称查找表。即使交易记录使用的是英文别名 (如 "20 EMA Gap")，系统也能自动关联到策略仓库中的中文标准名 (如 "20 均线缺口")。
- 🌪️ **环境表现归一化**:
  - 修复了环境表现模块中中英文标签 (如 "Strong Trend" 和 "强趋势") 分离统计的问题。现在所有周期标签都会被归一化并翻译为中文进行合并统计。
  - 补充了 "Breakout Mode" (突破模式) 等缺失的周期映射。

#### 全景巡检仪 (Inspector)

- 🐛 **校验逻辑修复**:
  - 修复了策略校验逻辑。现在只要 `strategy_name` 在策略仓库中存在，即视为合法，不再强制要求必须匹配 `patterns` 列表。
- 📊 **原始数据显示**:
  - "Raw Data" 表格现在支持显示策略的英文别名，方便排查中英文混用问题。

---

## �🐛 v4.2.1 (2025-12-24)

### 🌡️ 账户热力图修复 & UI 优化

**类型**: Bug Fix (修复) & UI Polish (界面优化)

#### 账户仪表盘 (Account Dashboard)

- 🐛 **热力图数据映射修复**:
  - 修复了 Metadata Menu 插件将数值属性转换为数组导致热力图无法正确识别盈亏金额的问题。
  - 增强了 `pa-utils.js` 的 `getVal` 函数，使其能智能处理数组型数值。
- 📅 **智能日期上下文**:
  - 热力图现在根据最近一笔实盘交易的日期自动定位月份，完美支持"2025 年模拟"等未来时间场景，不再强制依赖系统当前时间。
- 💎 **UI 布局升级**:
  - 账户概览升级为 Grid 栅格布局，视觉更整洁。
  - 新增"模拟盘"与"回测"迷你卡片，主次分明。

---

## ⚡️ v4.2.0 (2025-12-24)

### 🏎️ 性能引擎升级 & 💎 UI 焕新

**类型**: Feature Update (功能更新) & Performance (性能优化)

#### 核心引擎 (Core Engine)

- ⚡️ **智能增量更新 (Smart Incremental Caching)**:
  - 实现了数据分层加载机制。修改交易笔记时，系统将复用内存中的记忆库 (SR) 和课程数据，仅重新扫描交易数据。
  - **效果**: 仪表盘刷新速度显著提升，消除了修改笔记后的卡顿感。
- 🐛 **逻辑修复**: 修正了 R 值计算逻辑。现在即使 `initial_risk` 被记录为负数，也能正确取绝对值进行计算，消除了误报的"逻辑错误"。
- 📊 **数据完整性**: 补充了 `entry`, `exit`, `stop`, `tags` 等缺失字段的输出，为后续的高级分析功能奠定基础。

#### 全景巡检仪 (Inspector)

- 🚨 **精准异常定位**:
  - "异常详情 (Action Required)" 列表现在能精确列出缺失 **Ticker**, **Setup**, **Timeframe** 的具体文件，而不仅仅是统计数字。
  - 增加了对 `Templates/属性值预设.md` 的存在性检查，防止因文件丢失导致的误报。
- 🐛 **稳定性修复**: 修复了因对象层级变化导致的 `undefined link` 崩溃问题。

#### 记忆模块 (Memory Core)

- 💎 **UI 视觉升级 (Quantum Design)**:
  - 采用了全新的"量子"设计语言，引入磨砂玻璃 (Glassmorphism) 效果和动态光效。
- 🎲 **摇一摇 (Shake)**: 新增随机抽卡功能，点击推荐卡片右上角的骰子图标即可随机抽取一张闪卡。
- 🔄 **强制刷新**: 标题栏新增刷新按钮，允许用户在数据不同步时手动强制重载所有数据。

---

## 🧹 v4.1.1 (2025-12-24)

### 🛡️ 数据治理：属性值标准化

**类型**: Patch (补丁/维护)

#### 核心变更

- 🔒 **确立"单一信源"原则 (Single Source of Truth)**

  - 明确 `Templates/属性值预设.md` 为系统的最高数据标准。
  - 所有策略卡片和交易笔记的属性值必须严格遵循预设文件。

- 🧹 **全量数据清洗**

  - 扫描并修正了 `策略仓库/太妃方案` 下所有策略卡片的属性值。
  - 统一了 `market_cycle` (强趋势/弱趋势/区间/突破) 和 `setup_category` (突破/回调/反转/逆势) 的命名规范。
  - 修复了 `signal_bar_quality` 中的不一致 (新增 `十字星 (Doji)`，统一 `Weak / Tail`)。
  - **[新增] 全域属性收录**: 将 `入场/entry_price`, `止损/stop_loss`, `confidence/信心` 等分散在各处的属性全部收录进预设文件，实现 100% 覆盖。

- 📝 **文档更新**
  - 在 `属性值预设.md` 中增加了重要性声明，强调其作为系统"法律法规"的地位。
  - **特别强调**: 属性值预设不仅是补全工具，更是系统的**数据字典 (Data Dictionary)**。任何不在预设中的属性，都将被视为"非法数据"，可能导致统计失效。

---

## 🚀 v4.1.0 (2025-12-24)

### 🧠 核心逻辑重构：通用属性体系

**类型**: Major Refactor (重大重构)

#### 新特性

- ✨ **通用属性共振 (Universal Property Resonance)**

  - 摒弃了复杂的 `Strategy ID` 绑定机制。
  - 采用 **"形态匹配"** 逻辑：交易模版中的 `patterns_observed` 直接对应策略卡片中的同名属性。
  - 实现了属性的 **"全系统通用化"**：`signal_bar_quality`, `market_cycle` 等属性在模版和策略中完全一致。

- ✨ **策略卡片标准化 (Standardized Strategy Card)**

  - 新增 **指导区属性**：`entry_criteria`, `risk_alerts`, `stop_loss_recommendation`。
  - 这些属性专用于控制台的 **"实时策略助手"**，提供上下文相关的交易建议。

- ✨ **无缝数据流**
  - 交易模版无需修改，保持纯净。
  - 策略库作为规则源，交易笔记作为执行记录，控制台作为连接器。

#### 优化改进

- 🎨 **属性名标准化**: 统一使用 `中文/英文` 格式 (e.g., `观察到的形态/patterns_observed`)，兼顾可读性与代码解析。

---

## 🎯 v4.0.0 (2025-01-20)

### 🎨 主题系统全面升级

**类型**: Major Update (重大更新)

#### 新功能

- ✨ **Modern Glassmorphism v3.0 主题**

  - 深蓝色渐变背景 (#0F172A → #1E3A8A)
  - 毛玻璃效果 (backdrop-filter: blur(16px))
  - 柔和阴影和边框增强
  - 平滑过渡动画 (transition: all 0.3s ease)

- ✨ **完整样式库系统**

  - `cfg.styles.glassCard`: 毛玻璃卡片样式
  - `cfg.styles.pill`: 药丸标签样式
  - `cfg.styles.pillGradient`: 渐变药丸样式
  - `cfg.styles.flexCenter`: 居中布局样式
  - `cfg.styles.sectionHeader`: 章节标题样式

- ✨ **双语标签系统**
  - `cfg.labels.zh`: 中文标签库
  - `cfg.labels.en`: 英文标签库
  - 支持账户类型、市场周期等标签的中英文切换

#### 优化改进

- 🎨 **路径统一**: 所有引用从 `Scripts/` 统一为小写 `scripts/`
- 🎨 **布局简化**: 移除所有嵌套 callout 结构,使用简洁的 `##` 标题
- 🌐 **全面本地化**: 所有 UI 文本翻译为中文
  - Live → 实盘, Demo → 模拟, Backtest → 回测
  - Win Rate → 胜率, Recent Errors → 近期错误

#### Bug 修复

- 🐛 **修复快速行动视图主题未应用**: 将硬编码背景色改为 `c.cardBg`
- 🐛 **修复图片加载失败**:
  - `pa-core.js`: 保留 cover 字段原始值,不使用 `getStr()` 清理
  - `pa-view-gallery.js`: 支持 Link 对象、[[wikilinks]]、HTTP URLs
- 🐛 **修复语法错误**: `pa-view-gallery.js` 缺少换行符导致变量未定义

#### 技术细节

- 📦 **涉及文件**: 16 个 JS 文件, 总计 1964 行代码
- 🔧 **核心修改**:
  - `pa-config.js`: 新增主题 v3.0 配置
  - `pa-core.js`: 优化 cover 字段处理逻辑
  - `pa-view-*.js`: 13 个视图模块全部应用新主题
  - `🦁 交易员控制台4.0.md`: 简化布局结构

#### 文档更新

- 📋 **新增**: 《📋 系统技术报告 v4.0》(544 行)

  - 系统概览与架构分析
  - 13 个功能模块详细说明
  - 性能指标与已知问题
  - 技术栈与开发规范

- 📋 **更新**: 《🦁 交易员控制台\_升级计划》
  - 三大模块架构重构战略
  - 策略仓库系统规划
  - 数据结构优化方案
  - 10 大额外优化建议

#### 提交记录

```
27fe1a5 - docs: add comprehensive system technical report v4.0
d830ce4 - docs: major upgrade plan v5.0 - three-hub architecture
a90ecf8 - docs: complete comprehensive upgrade plan v4.0 based on technical report
cfddeea - fix: apply theme to actions view, fix image loading in gallery
409768e - refactor: simplify dashboard layout, remove nested callouts
0aa9a43 - feat: translate all UI labels to Chinese
```

#### 下一步计划

- [ ] 实现加载动画和移动端响应式 (v4.1)
- [ ] 开发策略仓库系统 (v5.0)
- [ ] 构建市场信号匹配系统 (v5.0)

---

## 🎯 v4.1.0 (2025-12-20)

### 🔄 策略仓库与属性系统优化尝试

**类型**: Minor Update (次要更新) - **部分回滚**

#### 背景与目标

基于用户交易流程需求,尝试建立以**属性系统为桥梁**的完整工作流:

1. 打开交易软件查看图表
2. 快速创建笔记并分析形态
3. 系统根据形态自动推荐策略
4. 查看策略详情(止损/止盈建议)
5. 执行交易并实时监控

#### 新功能

- ✨ **策略仓库模块优化**

  - 增强策略卡片显示: 添加市场周期、设置类别、使用次数等信息
  - 点击展开/收起详情功能
  - 修复"太妃方案"和"Al Brooks 经典"按钮跳转
  - 新增"总使用次数"统计卡片

- ✨ **今日实时监控面板** (`pa-view-today.js`)

  - 显示今日交易统计: 总交易、获胜、亏损、胜率、净利润
  - 最近 5 笔交易列表(含策略、品种、盈亏)
  - 进行中交易提醒
  - 快速创建交易笔记按钮

- ✨ **属性系统扩展**
  - 新增 `观察到的形态/patterns_observed: []` 属性
  - 新增 `匹配策略ID/matched_strategy` 属性
  - 定义 17 种标准形态值(20EMA 缺口、楔形顶底、双顶双底等)

#### 尝试的改进 (部分问题)

- ⚠️ **单笔交易模板大幅改造**

  - 添加"阶段一: 图表分析与形态识别"section
  - 集成形态识别清单和智能策略推荐引擎
  - 通过 DataviewJS 读取`patterns_observed`属性自动匹配策略
  - **问题**: 逻辑复杂度增加,用户反馈"不太对"

- ⚠️ **创建并删除图表分析模板**
  - 最初创建独立的`图表分析模版 (Chart Analysis).md`
  - 后整合到单笔交易模板中并删除独立模板
  - **问题**: 应该在交易模板基础上升级而非重建

#### 技术细节

- 📦 **新增文件**:
  - `scripts/pa-view-today.js` (~160 行) - 今日监控面板
- 📦 **修改文件**:

  - `scripts/pa-view-playbook.js` - 策略仓库展示优化
  - `scripts/pa-view-actions.js` - 快速行动按钮优化
  - `Templates/属性值预设.md` - 新增形态和策略属性
  - `Templates/单笔交易模版 (Trade Note).md` - 大幅改造(需重新评估)
  - `🦁 交易员控制台4.0.md` - 集成今日监控面板

- 📦 **删除文件**:
  - `Templates/图表分析模版 (Chart Analysis).md` - 已整合到交易模板

#### 核心理念

**属性系统作为数据桥梁**:

```
交易笔记(frontmatter属性)
  ↓ patterns_observed
DataviewJS读取
  ↓ 形态名称匹配
策略仓库卡片
  ↓ 显示详情
pa-core引擎统计
  ↓ 分析成功率
控制台展示
```

#### 问题与反思

- ❌ **用户反馈**: "还是不太对"

  - 交易模板改动过大,流程复杂化
  - 形态识别逻辑可能不符合实际使用习惯
  - 属性匹配策略的方式需要重新设计

- 🤔 **需要重新思考**:
  - 图表分析应该如何融入工作流?
  - 形态识别应该在哪个环节?
  - 属性系统如何更自然地打通各模块?
  - 是否需要独立的图表分析笔记类型?

#### 保留的改进

- ✅ 策略仓库展示优化(已生效)
- ✅ 今日监控面板(已集成到控制台)
- ✅ 快速行动按钮优化(简化说明)
- ✅ 属性值预设扩展(patterns_observed 等)

#### 待重新设计

- ⏸️ 单笔交易模板的形态识别 section
- ⏸️ 智能策略推荐的触发时机
- ⏸️ 图表分析在整个流程中的位置

#### 下一步计划

- [ ] **暂停**: 重新思考交易流程和模板设计
- [ ] **讨论**: 与用户确认理想的工作流程
- [ ] **设计**: 基于实际需求重新设计属性桥梁系统
- [ ] **简化**: 避免过度复杂化现有模板

---

## 📌 版本历史

| 版本   | 日期       | 类型  | 主要变更                                       |
| ------ | ---------- | ----- | ---------------------------------------------- |
| v4.1.0 | 2025-12-20 | Minor | 策略仓库优化, 今日监控, 属性系统尝试(部分回滚) |
| v4.0.0 | 2025-01-20 | Major | 主题系统重构, 全面本地化, 技术文档完善         |
| v3.0.0 | 2024-12-15 | Major | 初始控制台系统搭建                             |

---

## 🔖 变更类型说明

- ✨ **新功能 (Feature)**: 新增功能或模块
- 🎨 **优化改进 (Enhancement)**: 改善用户体验或代码质量
- 🐛 **Bug 修复 (Bug Fix)**: 修复已知问题
- 📋 **文档更新 (Documentation)**: 更新技术文档或用户指南
- ♻️ **重构 (Refactor)**: 代码重构,不影响功能
- ⚡ **性能优化 (Performance)**: 提升系统性能
- 🔒 **安全更新 (Security)**: 修复安全漏洞
- ⚠️ **废弃警告 (Deprecated)**: 标记即将移除的功能
- 🗑️ **移除 (Removed)**: 删除已废弃功能

---

## 📝 更新日志模板

```markdown
## 🎯 vX.Y.Z (YYYY-MM-DD)

### 类型: 简短描述

#### 新功能

- ✨ **功能名称**: 功能描述

#### 优化改进

- 🎨 **改进点**: 改进描述

#### Bug 修复

- 🐛 **问题描述**: 修复方案

#### 技术细节

- 📦 涉及文件和代码量
- 🔧 核心修改点

#### 提交记录
```

commit_hash - commit message

```

#### 下一步计划
- [ ] 待完成项目1
- [ ] 待完成项目2
```

---

> [!tip] 如何使用本日志
>
> 1. **开发人员**: 每次合并重要功能到主分支后更新
> 2. **用户**: 查看最新功能和修复的问题
> 3. **回溯**: 出现问题时快速定位是哪个版本引入的
